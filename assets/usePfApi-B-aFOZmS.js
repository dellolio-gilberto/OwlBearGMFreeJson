var F=s=>{throw TypeError(s)};var O=(s,t,n)=>t.has(s)||F("Cannot "+n);var d=(s,t,n)=>(O(s,t,"read from private field"),n?n.call(s):t.get(s)),H=(s,t,n)=>t.has(s)?F("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(s):t.set(s,n),N=(s,t,n,e)=>(O(s,t,"write to private field"),e?e.call(s,n):t.set(s,n),n),C=(s,t,n)=>(O(s,t,"access private method"),n);import{z as it,A as ot,B as z,D as lt,E as tt,F as Z,G as ct,H as ut,j as l,a as U,b,u as v,I as T}from"./main-D4A3q17J.js";import{r as f,_ as pt,aQ as V,W as k,aR as B,aS as D,aT as Q,N as g,L as W,X as L,V as X,O as P,p as R,D as K,aU as ht,g as mt,c as M,aV as E}from"./diceHelper-DyDajmT-.js";import{u as G}from"./TokenContextWrapper-Djw0KyBT.js";import{i as q,k as dt}from"./DiceButtonWrapper-zlAAiXL9.js";var S,A,y,w,j,I,$,_,ft=(_=class extends it{constructor(t,n){super();H(this,j);H(this,S);H(this,A);H(this,y);H(this,w);N(this,S,t),this.setOptions(n),this.bindMethods(),C(this,j,I).call(this)}bindMethods(){this.mutate=this.mutate.bind(this),this.reset=this.reset.bind(this)}setOptions(t){var e;const n=this.options;this.options=d(this,S).defaultMutationOptions(t),ot(this.options,n)||d(this,S).getMutationCache().notify({type:"observerOptionsUpdated",mutation:d(this,y),observer:this}),n!=null&&n.mutationKey&&this.options.mutationKey&&z(n.mutationKey)!==z(this.options.mutationKey)?this.reset():((e=d(this,y))==null?void 0:e.state.status)==="pending"&&d(this,y).setOptions(this.options)}onUnsubscribe(){var t;this.hasListeners()||(t=d(this,y))==null||t.removeObserver(this)}onMutationUpdate(t){C(this,j,I).call(this),C(this,j,$).call(this,t)}getCurrentResult(){return d(this,A)}reset(){var t;(t=d(this,y))==null||t.removeObserver(this),N(this,y,void 0),C(this,j,I).call(this),C(this,j,$).call(this)}mutate(t,n){var e;return N(this,w,n),(e=d(this,y))==null||e.removeObserver(this),N(this,y,d(this,S).getMutationCache().build(d(this,S),this.options)),d(this,y).addObserver(this),d(this,y).execute(t)}},S=new WeakMap,A=new WeakMap,y=new WeakMap,w=new WeakMap,j=new WeakSet,I=function(){var n;const t=((n=d(this,y))==null?void 0:n.state)??lt();N(this,A,{...t,isPending:t.status==="pending",isSuccess:t.status==="success",isError:t.status==="error",isIdle:t.status==="idle",mutate:this.mutate,reset:this.reset})},$=function(t){tt.batch(()=>{var n,e,i,r,c,a,p,u;if(d(this,w)&&this.hasListeners()){const m=d(this,A).variables,o=d(this,A).context;(t==null?void 0:t.type)==="success"?((e=(n=d(this,w)).onSuccess)==null||e.call(n,t.data,m,o),(r=(i=d(this,w)).onSettled)==null||r.call(i,t.data,null,m,o)):(t==null?void 0:t.type)==="error"&&((a=(c=d(this,w)).onError)==null||a.call(c,t.error,m,o),(u=(p=d(this,w)).onSettled)==null||u.call(p,void 0,t.error,m,o))}this.listeners.forEach(m=>{m(d(this,A))})})},_);function et(s,t){const n=Z(),[e]=f.useState(()=>new ft(n,s));f.useEffect(()=>{e.setOptions(s)},[e,s]);const i=f.useSyncExternalStore(f.useCallback(c=>e.subscribe(tt.batchCalls(c)),[e]),()=>e.getCurrentResult(),()=>e.getCurrentResult()),r=f.useCallback((c,a)=>{e.mutate(c,a).catch(ct)},[e]);if(i.error&&ut(e.options.throwOnError,[i.error]))throw i.error;return{...i,mutate:r,mutateAsync:i.mutate}}const J=({percent:s,name:t,className:n,color:e})=>l.jsxs("svg",{className:`hp-icon ${n??""}`,height:"24px",viewBox:"0 -960 960 960",width:"24px",children:[l.jsx("defs",{children:l.jsxs("linearGradient",{id:t,x1:"0",x2:"0",y1:"1",y2:"0",children:[l.jsx("stop",{stopColor:e??"#AA1404",offset:"0%"}),l.jsx("stop",{stopColor:e??"#AA1404",offset:`${isNaN(s)?0:s}%`}),l.jsx("stop",{stopColor:"black",offset:`${Math.min(100,isNaN(s)?0:s+40)}%`}),l.jsx("stop",{stopColor:"black",offset:"100%"})]})}),l.jsx("path",{d:"m480-120-58-52q-101-91-167-157T150-447.5Q111-500 95.5-544T80-634q0-94 63-157t157-63q52 0 99 22t81 62q34-40 81-62t99-22q94 0 157 63t63 157q0 46-15.5 90T810-447.5Q771-395 705-329T538-172l-58 52Z",fill:`url(#${t})`}),l.jsx("path",{d:"m480-155.81-40.92-36.96q-98.06-89.04-162.19-153.02-64.12-63.98-101.63-113.65-37.52-49.67-52.35-90.63-14.83-40.96-14.83-83.12 0-82.74 55.8-138.54 55.81-55.81 138.54-55.81 51.74 0 97.78 24.5 46.03 24.5 79.8 71.08 34.88-46.58 80.29-71.08 45.4-24.5 97.29-24.5 82.73 0 138.54 55.79 55.8 55.78 55.8 138.48 0 42.23-14.83 83.19-14.83 40.97-52.33 90.62-37.5 49.65-101.52 113.67-64.01 64.03-162.32 153.02L480-155.81Zm0-75.42q94.32-85.61 155.52-146.46 61.2-60.85 96.82-105.96 35.62-45.12 49.62-80.15 14-35.03 14-69.36 0-59.53-39.55-98.97-39.55-39.45-98.59-39.45-47.01 0-86.95 26.89-39.95 26.88-64.52 75.92h-52.7q-24.96-49.42-64.71-76.11-39.75-26.7-86.76-26.7-58.66 0-98.4 39.45-39.74 39.44-39.74 98.99 0 34.35 14.03 69.39 14.02 35.04 49.59 80.1 35.57 45.07 96.76 105.86Q385.62-317 480-231.23Zm0-270.27Z",fill:e??"#AA1404"})]}),yt=()=>l.jsx("svg",{className:"map-icon",height:"24px",viewBox:"0 -960 960 960",width:"24px",children:l.jsx("path",{d:"m599.27-169.23-238.15-83.39-154.74 59.93q-14.65 5.77-27.5-2.91-12.84-8.67-12.84-24.49v-479.78q0-10.48 4.94-19.32 4.94-8.85 14.75-12.19l175.39-60L599.27-708l154.61-60q14.39-5.69 27.43 1.83 13.04 7.52 13.04 22.79v486.32q0 11.25-6.29 19.71-6.29 8.47-16.48 11.2l-172.31 56.92Zm-18.77-45.08V-678l-200.62-69.85v463.7l200.62 69.84Zm36.92 0 140-46.15v-469.69l-140 52.15v463.69Zm-414.46-16.15 140-53.69v-463.7l-140 47.7v469.69ZM617.42-678v463.69V-678Zm-274.46-69.85v463.7-463.7Z"})}),at=()=>l.jsx("svg",{className:"player-icon",height:"24px",viewBox:"0 -960 960 960",width:"24px",children:l.jsx("path",{d:"M480-504q-48.38 0-82.65-34.27t-34.27-82.65q0-48.39 34.27-82.66 34.27-34.27 82.65-34.27t82.65 34.27q34.27 34.27 34.27 82.66 0 48.38-34.27 82.65T480-504ZM205.54-223.38v-62.16q0-24.23 13.86-44.95 13.86-20.72 38.05-32.35 56.27-26.58 111.89-40.12t110.67-13.54q55.05 0 110.75 13.52t111.88 40.11q24.16 11.63 37.99 32.36 13.83 20.73 13.83 44.97v62.16H205.54Z"})}),st=({onClick:s,onContextMenu:t,active:n,players:e,tooltip:i})=>{const r=f.useRef(null),c=f.useRef(0);let a;return l.jsx("div",{className:`map-button ${n?"active":""}`,children:l.jsx(q,{content:i,children:l.jsxs("button",{ref:r,className:"map-default",onClick:async()=>{try{r.current&&(r.current.disabled=!0,r.current.classList.add("loading")),await s()}finally{r.current&&(r.current.disabled=!1,r.current.classList.remove("loading"))}},onContextMenu:async p=>{var u;if(p.preventDefault(),!((u=r==null?void 0:r.current)!=null&&u.disabled))try{r.current&&(r.current.disabled=!0,r.current.classList.add("loading")),await t()}finally{r.current&&(r.current.disabled=!1,r.current.classList.remove("loading"))}},onTouchStart:p=>{p.preventDefault(),p.stopPropagation(),c.current=Date.now(),a=setTimeout(async()=>{try{r.current&&(r.current.disabled=!0,r.current.classList.add("loading")),await t()}finally{r.current&&(r.current.disabled=!1,r.current.classList.remove("loading"))}},300)},onTouchEnd:async p=>{if(Date.now()-c.current<300){clearTimeout(a);try{r.current&&(r.current.disabled=!0,r.current.classList.add("loading")),await s()}finally{r.current&&(r.current.disabled=!1,r.current.classList.remove("loading"))}}else p.preventDefault(),p.stopPropagation()},children:[l.jsx(yt,{}),e?l.jsx(at,{}):null]})})})},Nt=({id:s})=>{var u,m;const t=U(),n=f.useRef(null),e=f.useRef(null),i=f.useRef(null),r=b(v(o=>o.room)),c=G(v(o=>{var h;return(h=o.tokens)==null?void 0:h.get(s)})),a=c==null?void 0:c.data,p=c==null?void 0:c.item;return f.useEffect(()=>{n&&n.current&&(n.current.value=String(a==null?void 0:a.hp))},[a==null?void 0:a.hp]),f.useEffect(()=>{e&&e.current&&(e.current.value=String(a==null?void 0:a.maxHp))},[a==null?void 0:a.maxHp]),f.useEffect(()=>{var o,h;i&&i.current&&pt.isNumber((o=a==null?void 0:a.stats)==null?void 0:o.tempHp)&&(i.current.value=String((h=a==null?void 0:a.stats)==null?void 0:h.tempHp))},[(u=a==null?void 0:a.stats)==null?void 0:u.tempHp]),l.jsxs("div",{className:"token-hp",children:[l.jsx(J,{percent:a.hp/(a.maxHp+(a.stats.tempHp??0))*100,name:p.id}),l.jsx(J,{percent:a.stats.tempHp&&a.stats.tempHp>0?100:0,name:`tempHp-${p.id}`,className:"temp-hp-icon",color:"#2248ff"}),l.jsxs("div",{className:"current-hp",children:[l.jsx(q,{content:"Set current HP",children:l.jsx("input",{ref:n,type:"text",defaultValue:a.hp,onBlur:async o=>{const h=o.target.value,x=await V(h,a,p,e,r);x!==null&&(o.target.value=String(x),await k(x,a,p,n,i,r))},onKeyDown:async o=>{if(o.key==="ArrowUp"){const h=Math.min(a.hp+1,a.stats.tempHp?a.maxHp+a.stats.tempHp:a.maxHp);await k(h,a,p,n,i,r),o.currentTarget.value=String(h)}else if(o.key==="ArrowDown"){const h=Math.min(a.hp-1,a.stats.tempHp?a.maxHp+a.stats.tempHp:a.maxHp);await k(h,a,p,n,i,r),o.currentTarget.value=String(h)}else if(o.key==="Enter"){const h=o.currentTarget.value,x=await V(h,a,p,e,r);x!==null&&await k(x,a,p,n,i,r)}}})}),l.jsx("span",{className:"divider"}),l.jsx(q,{content:"Set max HP",children:l.jsx("input",{type:"text",ref:e,defaultValue:a.maxHp,onKeyDown:async o=>{if(o.key==="ArrowUp")await B(a.maxHp+1,a,p,e);else if(o.key==="ArrowDown")await B(a.maxHp-1,a,p,e);else if(o.key==="Enter"){const h=Number(o.currentTarget.value.replace(/[^0-9]/g,""));await B(h,a,p,e)}},onBlur:async o=>{const h=Number(o.target.value.replace(/[^0-9]/g,""));await B(h,a,p,e)}})})]}),l.jsxs("div",{className:"bottom-row",children:[l.jsx(q,{content:"set temp HP",children:l.jsx("input",{type:"text",defaultValue:a.stats.tempHp,ref:i,onKeyDown:async o=>{if(o.key==="ArrowUp")await D((a.stats.tempHp||0)+1,a,p,n,i);else if(o.key==="ArrowDown")await D((a.stats.tempHp||0)-1,a,p,n,i);else if(o.key==="Enter"){const h=Q(o.currentTarget.value);await D(h,a,p,n,i)}},onBlur:async o=>{const h=Q(o.currentTarget.value);await D(h,a,p,n,i)}})}),t.role==="GM"?l.jsx(st,{onClick:async()=>{const o=!a.hpOnMap,h={...a,hpOnMap:o,hpBar:o&&!(r!=null&&r.disableHpBar)};await g(h,[s]),await W(p,h)},onContextMenu:async()=>{var h,x;const o={...a,playerMap:{ac:!!((h=a.playerMap)!=null&&h.ac),hp:!((x=a.playerMap)!=null&&x.hp)}};await g(o,[s]),await W(p,o)},active:a.hpOnMap,players:!!((m=a.playerMap)!=null&&m.hp),tooltip:"Add HP to map (players: right click)"}):null]})]})},vt=()=>l.jsx("svg",{className:"ac-icon",height:"24px",viewBox:"0 -960 960 960",width:"24px",children:l.jsx("path",{d:"M480-80q-139-35-229.5-159.5T160-516v-244l320-120 320 120v244q0 152-90.5 276.5T480-80Z"})}),Ct=({id:s,hideExtras:t})=>{var p;const n=U(),e=b(v(u=>u.room)),i=f.useRef(null),r=G(v(u=>{var m;return(m=u.tokens)==null?void 0:m.get(s)})),c=r==null?void 0:r.data,a=r==null?void 0:r.item;return f.useEffect(()=>{i&&i.current&&(i.current.value=String(c==null?void 0:c.armorClass))},[c==null?void 0:c.armorClass]),l.jsxs("div",{className:`token-ac ${t?"no-extras":""}`,children:[t?null:l.jsx(vt,{}),l.jsx(q,{content:"Set AC",children:l.jsx("input",{className:"ac-input",type:"text",size:1,value:c.armorClass,onChange:u=>{let m=1;e!=null&&e.allowNegativeNumbers&&(m=u.target.value.startsWith("-")?-1:1);const o=Number(u.target.value.replace(/[^0-9]/g,""));L(o*m,c,a,e)},onKeyDown:u=>{u.key==="ArrowUp"?L(c.armorClass+1,c,a,e):u.key==="ArrowDown"&&L(c.armorClass-1,c,a,e)}})}),n.role==="GM"&&!t?l.jsx(st,{onClick:async()=>{const u={...c,acOnMap:!c.acOnMap};await g(u,[s]),await X(a,u)},onContextMenu:async()=>{var m,o;const u={...c,playerMap:{hp:!!((m=c.playerMap)!=null&&m.hp),ac:!((o=c.playerMap)!=null&&o.ac)}};await g(u,[s]),await X(a,u)},active:c.acOnMap,players:!!((p=c.playerMap)!=null&&p.ac),tooltip:"Add AC to map (players: right click)"}):null]})},xt=()=>l.jsx("svg",{className:"initiative-icon",height:"20px",viewBox:"0 -960 960 960",width:"20px",children:l.jsx("path",{d:"m757.46-117-121-120.69-88 88-19.84-19.85q-19.58-19.58-19.58-48t19.58-48l169.84-170.04q19.58-19.38 48-19.38t48 19.38l20.04 20.04-88 88 120.69 120.81q10.35 10.54 10.35 24.19 0 13.65-10.35 24L805.65-117q-10.54 10.54-24.19 10.54-13.65 0-24-10.54Zm100.62-616.27L411.04-285.85l20.04 19.43q19.57 19.57 19.57 48.25 0 28.67-19.57 48.25l-19.85 19.84-88-88-121 120.69q-10.34 10.54-24.09 10.54t-24.1-10.54l-41.54-41.53q-10.34-10.35-10.34-24 0-13.66 10.34-24.2l120.69-120.8-88-88 20.04-20.04q19.39-19.39 48.06-19.39t48.25 19.39l20.31 20.92 447.42-447.04h128.81v128.81ZM331.27-582.69 356.5-608l24.62-25.31L356.5-608l-25.23 25.31Zm-39.42 39.54L102.12-733.27v-128.81h128.61l189.54 189.93-39.15 38.84-173.31-172.81h-49.73v49.93l173.19 173.5-39.42 39.54ZM370-324.27l432.12-431.92v-49.93h-49.93L320.27-374 370-324.27Zm0 0-24.73-25-25-24.73 25 24.73 24.73 25Z"})}),bt=({active:s,onClick:t})=>l.jsx(q,{content:"Show Token in Player Initiative List",children:l.jsx("div",{className:`player-button ${s?"active":""}`,children:l.jsx("button",{className:"player-default",onClick:t,children:l.jsx(at,{})})})}),Y=async(s,t,n)=>{try{t.sync_pretty_sordid&&await P.scene.items.updateItems([s],e=>{e.forEach(i=>{i.metadata[`${R}/metadata`]={count:String(n),active:!1}})})}catch(e){K.isObject(e)&&"error"in e&&K.isObject(e.error)&&"name"in e.error&&e.error.name==="RateLimitHit"&&await P.notification.show("Too many changes, OBR rate limit prevented updating Pretty Sordid","WARNING")}},Pt=async(s,t,n)=>{try{n.sync_pretty_sordid&&(s&&await P.scene.items.updateItems([s],e=>{e.forEach(i=>{i.metadata[`${R}/metadata`].active=!1})}),await P.scene.items.updateItems([t],e=>{e.forEach(i=>{i.metadata[`${R}/metadata`].active=!0})}))}catch(e){K.isObject(e)&&"error"in e&&K.isObject(e.error)&&"name"in e.error&&e.error.name==="RateLimitHit"&&await P.notification.show("Too many changes, OBR rate limit prevented updating Pretty Sordid","WARNING")}},Tt=({id:s})=>{const t=U(),n=f.useRef(null),e=f.useRef(null),[i,r]=b(v(u=>[u.room,u.taSettings])),c=G(v(u=>{var m;return(m=u.tokens)==null?void 0:m.get(s)})),a=c==null?void 0:c.data,p=c==null?void 0:c.item;return f.useEffect(()=>{n&&n.current&&(n.current.value=String(a==null?void 0:a.initiative))},[a==null?void 0:a.initiative]),f.useEffect(()=>{e&&e.current&&(e.current.value=String(a==null?void 0:a.stats.initiativeBonus))},[a==null?void 0:a.stats.initiativeBonus]),l.jsxs("div",{className:"initiative-wrapper",children:[l.jsx(xt,{}),l.jsx(q,{content:"Set initiative",children:l.jsx("input",{type:"number",size:1,value:String(a.initiative),step:.1,ref:n,onChange:async u=>{const m={...a,initiative:Number(u.target.value)};await g(m,[s]),await Y(s,r,Number(u.target.value))},className:"initiative"})}),l.jsx(dt,{dice:`1d${(i==null?void 0:i.initiativeDice)||20}${Intl.NumberFormat("en-US",{signDisplay:"always"}).format(a.stats.initiativeBonus)}`,text:Intl.NumberFormat("en-US",{signDisplay:"always"}).format(a.stats.initiativeBonus),context:"Initiative: Roll",stats:ht,statblock:a.sheet||mt(p),onRoll:async u=>{let m=0;try{u&&"total"in u?m=u.total:u&&"values"in u&&(m=u.values.map(h=>h.value).reduce((h,x)=>h+x,0))}catch{}const o={...a,initiative:m};await g(o,[s]),await Y(s,r,m)},classes:"init-wrapper"}),l.jsx(q,{content:"Set initiative bonus",children:l.jsx("input",{type:"number",size:1,defaultValue:a.stats.initiativeBonus,step:1,ref:e,onBlur:async u=>{const m=Number(u.target.value),o={...a,stats:{initiativeBonus:m}};await g(o,[s])},onKeyDown:async u=>{if(u.key==="Enter"){const m=Number(u.currentTarget.value),o={...a,stats:{initiativeBonus:m}};await g(o,[s])}},className:"initiative-bonus"})}),t.role==="GM"?l.jsx(bt,{active:!!a.playerList,onClick:async()=>{const u={...a,playerList:!a.playerList};await g(u,[s])}}):null]})},wt=(s,t,n,e,i)=>{let r={};return e&&(r={Authorization:`Bearer ${e}`}),E("/e5/statblock/search/",r,{search_string:s,take:t,skip:n},"GET",i).then(c=>c.data)},nt=(s,t,n)=>{let e={};return t&&(e={Authorization:`Bearer ${t}`}),E(`/e5/statblock/${s}`,e,{},"GET",n).then(i=>i.data?i.data:null)},Et=(s,t,n)=>{const e=b(v(r=>r.room)),i=M(e||void 0);return T({queryKey:["search",s,t,n,e==null?void 0:e.tabletopAlmanacAPIKey,i],queryFn:()=>wt(s,t,n,e==null?void 0:e.tabletopAlmanacAPIKey,i),enabled:s!==""})},kt=s=>{const t=b(v(e=>e.room)),n=M(t||void 0);return T({queryKey:["slug",s,t==null?void 0:t.tabletopAlmanacAPIKey,n],queryFn:()=>nt(s,t==null?void 0:t.tabletopAlmanacAPIKey,n),enabled:s!==""})},Bt=()=>{const s=Z(),t=b(v(e=>e.room)),n=M(t||void 0);return et({mutationKey:[],mutationFn:({slug:e})=>nt(e,t==null?void 0:t.tabletopAlmanacAPIKey,n),onSuccess:(e,i)=>(s.invalidateQueries({queryKey:["slug",i.slug]}),e)})},gt=(s,t,n,e,i)=>{let r={};return e&&(r={Authorization:`Bearer ${e}`}),E("/pf/statblock/search/",r,{name:s,take:t,skip:n},"GET",i).then(c=>c.data)},rt=(s,t,n)=>{let e={};return t&&(e={Authorization:`Bearer ${t}`}),E(`/pf/statblock/${s}`,e,{},"GET",n).then(i=>i.data?i.data:null)},jt=(s,t,n)=>{let e={};return t&&(e={Authorization:`Bearer ${t}`}),E(`/pf/spell/${s}`,e,{},"GET",n).then(i=>i.data?i.data:null)},Dt=(s,t,n)=>{const e=b(v(r=>r.room)),i=M(e||void 0);return T({queryKey:[s,t,n,"search",e==null?void 0:e.tabletopAlmanacAPIKey,i],queryFn:()=>gt(s,t,n,e==null?void 0:e.tabletopAlmanacAPIKey,i),enabled:s!==""})},It=s=>{const t=b(v(e=>e.room)),n=M(t||void 0);return T({queryKey:[s,"slug",t==null?void 0:t.tabletopAlmanacAPIKey,n],queryFn:()=>rt(s,t==null?void 0:t.tabletopAlmanacAPIKey,n),enabled:s!==""})},Kt=s=>{const t=b(v(e=>e.room)),n=M(t||void 0);return T({queryKey:[s,"slug",t==null?void 0:t.tabletopAlmanacAPIKey,n],queryFn:()=>jt(s,t==null?void 0:t.tabletopAlmanacAPIKey,n),enabled:s!==""})},Ot=()=>{const s=Z(),t=b(v(e=>e.room)),n=M(t||void 0);return et({mutationKey:[],mutationFn:({slug:e,apiKey:i})=>rt(e,i||(t==null?void 0:t.tabletopAlmanacAPIKey),n),onSuccess:(e,i)=>(s.invalidateQueries({queryKey:["slug",i.slug],refetchType:"all"}),e)})};export{vt as A,J as H,xt as I,st as M,bt as P,Dt as a,at as b,Bt as c,Ot as d,Nt as e,Ct as f,Tt as g,kt as h,Kt as i,It as j,Pt as s,Et as u};
