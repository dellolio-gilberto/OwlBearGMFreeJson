import{j as a,a as E,u as b,b as L,c as Q}from"./main-B_pIpk6P.js";import{I as R,r as M,O as x,k as W,o as ee,J as A,K as V,L as Y,M as z,g as te,N as ae,i as h,z as se,f as I,P as F,H as $,Q as X,S as ne,T as oe,G as U,_ as Z}from"./diceHelper-DEs3FY5e.js";import{u as G}from"./TokenContextWrapper-DPsiOHKq.js";import{c as ce,d as re,e as ie,f as le,g as de}from"./usePfApi-CepAF0Hx.js";import{i as O,u as ue,b as pe,c as he,F as me,d as xe,e as fe,o as ge,f as ye,s as ve,h as we}from"./DiceButtonWrapper-BeaTGS-U.js";const je=R()(e=>({characterId:null,setId:n=>e(()=>({characterId:n}))})),Me=()=>a.jsx("svg",{className:"sheet-icon",height:"24px",viewBox:"0 -960 960 960",width:"24px",children:a.jsx("path",{d:"M480.14-413.27q27.4 0 46.61-19.35t19.21-46.75q0-27.4-19.25-46.61t-46.75-19.21q-27.31 0-46.61 19.25-19.31 19.25-19.31 46.75 0 27.31 19.35 46.61 19.35 19.31 46.75 19.31Zm-146.1 143.65h291.92v-10.5q0-20.13-10.76-35.7-10.76-15.56-29.66-23.99-24.58-10.18-50.82-15.96-26.25-5.77-54.75-5.77-28.51 0-54.73 5.77-26.22 5.78-50.78 15.96-18.9 8.43-29.66 23.99-10.76 15.57-10.76 35.7v10.5Zm370.5 161.54H255.46q-28.36 0-48.27-19.91-19.92-19.92-19.92-48.27v-607.48q0-28.35 19.92-48.27 19.91-19.91 48.31-19.91h293.68l223.55 223.61v452.03q0 28.37-19.92 48.29-19.91 19.91-48.27 19.91Zm-.08-55.96q4.62 0 8.46-3.84 3.85-3.85 3.85-8.47v-428.06L525.38-795.96H255.54q-4.62 0-8.46 3.84-3.85 3.85-3.85 8.47v607.3q0 4.62 3.85 8.47 3.84 3.84 8.46 3.84h448.92Zm-461.23 0v-631.92V-164.04Z"})}),Ce=()=>a.jsx("svg",{className:"delete-icon",height:"24px",viewBox:"0 -960 960 960",width:"24px",children:a.jsx("path",{d:"M294.73-148.08q-28.26 0-48.26-20-20.01-20.01-20.01-48.27v-501.23h-39.19v-55.89h174.35v-33.84h237.57v33.77h174.35v55.96h-39.2v501.32q0 28.35-19.91 48.27-19.92 19.91-48.35 19.91H294.73Zm383.65-569.5H282.42v501.23q0 5.39 3.46 8.85 3.47 3.46 8.85 3.46h371.35q4.61 0 8.46-3.84 3.84-3.85 3.84-8.47v-501.23ZM380.19-282.92h55.96v-355.96h-55.96v355.96Zm144.46 0h55.96v-355.96h-55.96v355.96ZM282.42-717.58V-204.04v-513.54Z"})}),be=({id:e})=>{var v,f;const[n,t]=E(b(u=>[u.room,u.scene])),s=L(),c=G(b(u=>{var i;return(i=u.tokens)==null?void 0:i.get(e)})),r=je(b(u=>u.setId)),o=c==null?void 0:c.data,d=c==null?void 0:c.item,[l,y]=M.useState([]),C=((v=l.find(u=>u.id===d.createdUserId))==null?void 0:v.id)??s.id??"";return M.useEffect(()=>((async()=>{y(await x.party.getPlayers())})(),x.party.onChange(i=>{y(i)})),[]),a.jsxs("div",{className:"sheet",children:[a.jsx(Me,{}),o.sheet?a.jsxs(a.Fragment,{children:[a.jsx(O,{content:"open statblock (RMB in popover)",children:a.jsx("button",{onClick:()=>r(e),onContextMenu:async u=>{var w,j;u.preventDefault();let i=1e4,p=600;try{i=await x.viewport.getWidth(),p=await x.viewport.getHeight()}catch{}const g=t!=null&&t.statblockPopoverOpen?{...t.statblockPopoverOpen}:{};g[x.player.id]=!0,await W(t,{statblockPopoverOpen:g}),await x.player.select([e]),await x.popover.open({...ee,width:Math.min(((w=n==null?void 0:n.statblockPopover)==null?void 0:w.width)||500,i),height:Math.min(((j=n==null?void 0:n.statblockPopover)==null?void 0:j.height)||600,p),anchorPosition:{top:55,left:i-70}})},children:"open"})}),s.role==="GM"?a.jsx(O,{content:"Remove statblock",children:a.jsx("button",{className:"remove-statblock",onClick:async()=>{const u={...o,sheet:""};await A(u,[e])},children:a.jsx(Ce,{})})}):null]}):a.jsx(O,{content:"Assign statblock",children:a.jsx("button",{onClick:()=>r(e),children:"assign"})}),s.role==="GM"?a.jsxs(a.Fragment,{children:[d.createdUserId!==s.id?a.jsx("div",{className:"owner-color",style:{backgroundColor:((f=l.find(u=>u.id===d.createdUserId))==null?void 0:f.color)??"transparent"}}):null,a.jsx(O,{content:"Assign token owner",children:a.jsxs("select",{value:C,onChange:async u=>{await x.scene.items.updateItems([d],i=>{i.forEach(p=>{p.createdUserId=u.target.value})})},className:"select-owner",children:[a.jsx("option",{value:x.player.id,children:"GM"}),l.map(u=>a.jsx("option",{value:u.id,children:u.name},u.id))]})})]}):null]})},ke=()=>a.jsx("svg",{className:"shield-icon",height:"24",width:"20",xmlns:"http://www.w3.org/2000/svg",children:a.jsx("polygon",{points:"0,0 10,6 20,0 20,16 10,24 0,16, 0,0"})}),Pe=R()(V(e=>({playerPreview:!0,setPlayerPreview:n=>e(()=>({playerPreview:n}))}),{name:`${Y}.ui-settings`,storage:z(()=>localStorage)})),Se="_contextPopover_19y06_1",Ie={contextPopover:Se},Ne=e=>{const[n,t]=M.useState(!1),s=M.useRef(!1),{refs:c,floatingStyles:r,context:o}=ue({open:n,onOpenChange:t,middleware:[ge({mainAxis:5,alignmentAxis:4}),ye({fallbackPlacements:["left-start"]}),ve({padding:10})],placement:"right-start",strategy:"fixed",whileElementsMounted:we}),d=pe(o),{getFloatingProps:l}=he([d]);return M.useEffect(()=>{let y;function C(f){f.preventDefault(),c.setPositionReference({getBoundingClientRect(){return{width:0,height:0,x:f.clientX,y:f.clientY,top:f.clientY,right:f.clientX,bottom:f.clientY,left:f.clientX}}}),t(!0),clearTimeout(y),s.current=!1,y=window.setTimeout(()=>{s.current=!0},300)}function v(){s.current&&t(!1)}e.context?C(e.context):v()},[c,e.context]),a.jsx(me,{children:n&&a.jsx(xe,{lockScroll:!0,style:{zIndex:5},children:a.jsx(fe,{context:o,initialFocus:c.floating,children:a.jsx("div",{className:Ie.contextPopover,ref:c.setFloating,style:r,...l(),children:e.children})})})})},He="_groupSelect_19uio_1",Oe={groupSelect:He},De=({id:e,onSelect:n,data:t})=>{var c;const[s]=E(b(r=>[r.scene]));return a.jsxs("div",{className:Oe.groupSelect,children:[a.jsx("b",{children:"Select Group for Token"}),a.jsx("select",{value:t.group||"Default",onChange:r=>{n(),A({...t,group:r.currentTarget.value},[e])},children:(c=s==null?void 0:s.groups)==null?void 0:c.map((r,o)=>a.jsx("option",{value:r,children:r},o))})]})};let D;const K=({id:e,onClick:n,hideName:t,isDragging:s})=>{var j,T,N,P,H;const c=Pe(b(m=>m.playerPreview)),r=L(),o=E(b(m=>m.room)),d=G(b(m=>{var k;return(k=m.tokens)==null?void 0:k.get(e)})),l=d==null?void 0:d.data,y=d==null?void 0:d.item,[C,v]=M.useState(!1),[f,u]=M.useState(null),i=ce(),p=re(),g=async()=>{const m=await x.scene.items.getItemBounds([e]);await x.player.select([e]),await x.viewport.animateToBounds({...m,min:{x:m.min.x-1e3,y:m.min.y-1e3},max:{x:m.max.x+1e3,y:m.max.y+1e3}})},w=async()=>{if(l.sheet&&(o!=null&&o.ruleset)){const m=await(o.ruleset==="e5"?i:p).mutateAsync({slug:l.sheet,apiKey:o==null?void 0:o.tabletopAlmanacAPIKey});if(m){await ae(m,e,o.ruleset);const k=await x.notification.show("Don't forget to close and reopen the Statblock Popover","SUCCESS");setTimeout(async()=>{await x.notification.close(k)},3e3)}}v(!1)};return M.useEffect(()=>{s&&(v(!1),clearTimeout(D))},[s]),a.jsxs(a.Fragment,{children:[a.jsx(Ne,{context:f,children:a.jsx(a.Fragment,{children:a.jsx(De,{id:e,onSelect:()=>{u(null)},data:l})})}),a.jsx(O,{content:C?"Resyncing Statblock...":te(y),hideOnClick:!C,className:"token-name-tooltip",disabled:t,children:a.jsxs("div",{className:`token-icon ${C?"mouse-down":""}`,onDoubleClick:g,onClick:n,onPointerDown:()=>{r.role==="GM"&&(v(!0),D=setTimeout(()=>w(),1e3))},onPointerUp:()=>{v(!1),clearTimeout(D)},onContextMenu:m=>{m.preventDefault(),v(!1),clearTimeout(D),u(m.nativeEvent)},children:[a.jsx("img",{src:y.image.url,alt:"",className:`${y.scale.x<0&&c?"flipped":""}`,style:{rotate:`${c?y.rotation+"deg":"0deg"}`}}),r.role==="GM"&&c?a.jsxs(a.Fragment,{children:[l.hpOnMap&&!(o!=null&&o.disableHpBar)?a.jsx("div",{className:"preview-hp",style:{"--width":`${l.maxHp!==0?(l.hp-(((j=l.stats)==null?void 0:j.tempHp)??0))/l.maxHp*100:0}%`,"--temp-width":`${(l.maxHp!==0&&(T=l.stats)!=null&&T.tempHp?l.stats.tempHp/l.maxHp:0)*100}%`},children:(N=l.playerMap)!=null&&N.hp?a.jsxs("span",{className:"preview-hp-text",children:[l.hp,"/",l.maxHp,(P=l.stats)!=null&&P.tempHp?`(${l.stats.tempHp})`:null]}):null}):null,(H=l.playerMap)!=null&&H.ac&&l.acOnMap?a.jsxs("div",{className:"preview-ac",children:[a.jsx(ke,{}),a.jsx("span",{className:"preview-value",children:l.armorClass})]}):null]}):null]})})]})},Ee=({color:e})=>a.jsxs("svg",{className:"rest-icon",height:"800px",width:"800px",version:"1.1",viewBox:"0 0 297.136 297.136",children:[a.jsx("defs",{children:a.jsxs("linearGradient",{id:"CampFire",x1:"0",x2:"0",y1:"1",y2:"0",children:[a.jsx("stop",{stopColor:"yellow",offset:"0%"}),a.jsx("stop",{stopColor:"orange",offset:"30%"}),a.jsx("stop",{stopColor:"red",offset:"100%"})]})}),a.jsxs("g",{children:[a.jsx("path",{d:"m232.515,264.944l-28.297-8.784 28.131-8.732c8.664-2.823 13.4-12.137 10.578-20.8-2.824-8.665-12.137-13.4-20.801-10.577l-73.559,22.834-73.558-22.835c-8.664-2.823-17.977,1.912-20.801,10.577-2.822,8.663 1.914,17.977 10.578,20.8l28.131,8.732-28.297,8.784c-8.664,2.822-13.4,12.136-10.576,20.799 2.822,8.664 12.135,13.4 20.799,10.577l73.725-22.886 73.725,22.886c8.664,2.823 17.977-1.913 20.799-10.577 2.824-8.663-1.913-17.976-10.577-20.798z",fill:e??"brown"}),a.jsx("path",{d:"m121.648,209.237c0-40.52 27.011-79.78 27.011-79.78s27.017,39.26 27.017,79.78c79.605,0 75.389-79.648 56.217-120.303-4.033-8.553-15.586-10.06-21.662-2.817-15.578,18.572-34.005,29.066-34.005,29.066s14.598-42.873-14.38-86.78c-8.439-12.789-21.273-21.456-32.278-26.998-8.696-4.379-18.991,2.018-18.813,11.754 0.755,41.521-29.282,66.196-43.839,88.024-27.014,40.521-13.509,108.054 54.732,108.054z",fill:e??"url(#CampFire)"})]})]}),Fe=e=>e.map(t=>t.metadata[h].hpOnMap).some(t=>t),Ge=e=>e.map(t=>{var c;return((c=t.metadata[h].playerMap)==null?void 0:c.hp)||!1}).some(t=>t),Te=e=>e.map(t=>{var c;return((c=t.metadata[h].playerMap)==null?void 0:c.ac)??!1}).some(t=>t),_e=async(e,n)=>{const t=Fe(e),s=se.chunk(e,4);for(const c of s)await I(c.map(r=>r.id),r=>{r.forEach(o=>{o.metadata[h].hpOnMap=!t,o.metadata[h].hpBar=!t&&!(n!=null&&n.disableHpBar)})});await F(e,t?4:2,async c=>{for(const r of c){const o=r.metadata[h];await $(r,{...o,hpOnMap:!t,hpBar:!t&&!(n!=null&&n.disableHpBar)})}})},Ve=async e=>{const n=Ge(e);await I(e.map(t=>t.id),t=>{t.forEach(s=>{var r;const c=s.metadata[h];s.metadata[h].playerMap={ac:!!((r=c.playerMap)!=null&&r.ac),hp:!n}})}),await F(e,n?4:2,async t=>{var s;for(const c of t){const r=c.metadata[h];await $(c,{...r,playerMap:{ac:!!((s=r.playerMap)!=null&&s.ac),hp:!n}})}})},Ye=async e=>{const n=Te(e);await I(e.map(t=>t.id),t=>{t.forEach(s=>{var r;const c=s.metadata[h];s.metadata[h].playerMap={ac:!n,hp:!!((r=c.playerMap)!=null&&r.hp)}})}),await F(e,n?4:2,async t=>{var s;for(const c of t){const r=c.metadata[h];await X(c,{...r,playerMap:{hp:!!((s=r.playerMap)!=null&&s.hp),ac:!n}})}})},Be=e=>e.map(t=>t.metadata[h].acOnMap).some(t=>t),ze=async e=>{const n=Be(e);await I(e.map(t=>t.id),t=>{t.forEach(s=>{s.metadata[h].acOnMap=!n})}),await F(e,n?4:2,async t=>{for(const s of t){const c=s.metadata[h];await X(s,{...c,acOnMap:!n})}})},Le=e=>e.map(t=>t.metadata[h].playerList).some(t=>t),Xe=async e=>{const n=Le(e);await I(e.map(t=>t.id),t=>{t.forEach(s=>{s.metadata[h].playerList=!n})})},_=async(e,n)=>{var c;const t=[];await I(e.map(r=>r.id),r=>{r.forEach(o=>{var y,C,v;const d=o.metadata[h],l=(y=d.stats.limits)==null?void 0:y.map(f=>f.resets.includes(n)?{...f,used:0}:f);o.metadata[h].stats.limits=l,n==="Long Rest"&&d.hp!==d.maxHp+(((C=d.stats)==null?void 0:C.tempHp)??0)&&(o.metadata[h].hp=d.maxHp+(((v=d.stats)==null?void 0:v.tempHp)??0),t.push(o.id))})});const s=e.filter(r=>t.includes(r.id));for(const r of s){const o=r.metadata[h];await $(r,{...o,hp:o.maxHp+(((c=o.stats)==null?void 0:c.tempHp)??0)})}},Re=({id:e})=>{const n=G(b(s=>{var c;return(c=s.tokens)==null?void 0:c.get(e)})),t=n==null?void 0:n.item;return a.jsxs("div",{className:"token-rest",children:[a.jsx(Ee,{}),a.jsx("button",{className:"button short",onClick:()=>{_([t],"Short Rest")},children:"short"}),a.jsx("button",{className:"button long",onClick:()=>{_([t],"Long Rest")},children:"long"})]})},Ae=R()(V(e=>({groups:[],current:null,battle:!1,setCurrent:n=>e(()=>({current:n})),addGroup:n=>e(t=>{const s=Array.from(t.groups);return s.includes(n)||s.push(n),{groups:s}}),removeGroup:n=>e(t=>{const s=Array.from(t.groups),c=s.findIndex(r=>r===n);return c>=0&&s.splice(c,1),{groups:s}}),setGroups:n=>e(()=>({groups:n})),setBattle:n=>e(()=>({battle:n}))}),{name:`${Y}.battle-context`,storage:z(()=>localStorage)})),Je=e=>{const n=Q(b(i=>i.component)),t=L(),s=E(b(i=>i.room)),c=M.useRef(null),r=G(b(i=>{var p;return(p=i.tokens)==null?void 0:p.get(e.id)})),o=r==null?void 0:r.data,d=r==null?void 0:r.item,l=Ae(b(i=>i.current)),y=M.useRef(0);M.useEffect(()=>{s&&s.allowNegativeNumbers===!1&&(o.hp<0&&ne(0,o,d,void 0,void 0,s),o.armorClass<0&&oe(0,o,d,s))},[s==null?void 0:s.allowNegativeNumbers]),M.useEffect(()=>{t.role==="GM"&&(!o.isCurrent&&l===d.id||o.isCurrent&&l!==d.id)&&A({...o,isCurrent:l===d.id},[e.id])},[l,t]),M.useEffect(()=>{o.isCurrent&&c.current&&c.current.scrollIntoView({behavior:"smooth",block:"nearest",inline:"start"})},[o.isCurrent]);const C=i=>{var g;const p=o.group;if(p||p===void 0){const w=(g=e.tokenLists)==null?void 0:g.get(p||"Default");if(w){const j=o.index||w.indexOf(d),N=w.filter(P=>i.includes(P.id)).sort((P,H)=>{const m=P.metadata[h],k=H.metadata[h],B=Math.abs(j-m.index),S=Math.abs(j-k.index);return B<S?-1:S<B?1:0});if(N.length>0){const P=N[0],m=P.metadata[h].index||w.indexOf(P);let k=[];return m<j?k=Z.range(m,j):k=Z.range(j,m),w.map(S=>{const q=S.metadata[h];if(q.index){if(k.includes(q.index))return S.id}else{const J=w.indexOf(S);if(k.includes(J))return S.id}}).filter(S=>!!S)}}}return null},v=async(i,p)=>{if(!p&&i.target.tagName!=="DIV")return;i.preventDefault(),i.stopPropagation();const g=await x.player.getSelection()||[];if(g.length===0)await x.player.select([e.id]);else if(g.includes(e.id))g.splice(g.indexOf(e.id),1),await x.player.select(g);else if(i.shiftKey){const w=C(g);if(w){const j=g.concat(w);j.push(e.id),await x.player.select(j)}}else i.metaKey||i.ctrlKey?(g.push(e.id),await x.player.select(g)):await x.player.select([e.id])},f=async i=>{if(i.target.tagName!=="DIV")return;const p=await x.scene.items.getItemBounds([e.id]);await x.player.select([e.id]),await x.viewport.animateToBounds({...p,min:{x:p.min.x-1e3,y:p.min.y-1e3},max:{x:p.max.x+1e3,y:p.max.y+1e3}})},u=()=>{var i,p;return o.hpTrackerActive&&(t.role==="GM"||d.createdUserId===t.id||!!((i=o.playerMap)!=null&&i.hp)&&!!((p=o.playerMap)!=null&&p.ac)&&o.hpOnMap&&o.acOnMap&&!!o.playerList)};return u()?a.jsxs("div",{ref:c,className:`token ${t.role==="PLAYER"?"player":""} ${e.selected?"selected":""} ${n} ${o.isCurrent?"current":""}`,style:{background:`linear-gradient(to right, ${U(o)}, #1C1B22 50%, #1C1B22 )`},onClick:i=>{v(i)},onDoubleClick:i=>{f(i)},onTouchStart:i=>{const p=Date.now();p-y.current<300?f(i):y.current=p},children:[a.jsx(K,{id:e.id,onClick:async i=>{v(i,!0)},hideName:!u(),isDragging:e.isDragging}),a.jsx(ie,{id:e.id}),a.jsx(le,{id:e.id}),a.jsx(de,{id:e.id}),e.popover?null:t.role==="GM"||d.createdUserId===t.id?a.jsxs(a.Fragment,{children:[t.role==="GM"||o.sheet?a.jsx(be,{id:e.id}):null,a.jsx(Re,{id:e.id})]}):null]}):o.playerList&&d.visible?a.jsx("div",{ref:c,className:`token ${o.isCurrent?"current":""}`,style:{background:`linear-gradient(to right, ${U(o,"0.2",t.role==="PLAYER"&&(s==null?void 0:s.disableColorGradient),"#1F1E26")}, #1F1E26 50%, #1F1E26 )`},children:a.jsx(K,{id:e.id,hideName:!u()})}):a.jsx(a.Fragment,{})};export{Ee as R,Je as T,Ae as a,Ve as b,Ge as c,ze as d,Ye as e,Be as f,Fe as g,Te as h,Le as i,Xe as j,Pe as k,_ as r,_e as t,je as u};
