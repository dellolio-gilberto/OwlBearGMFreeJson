var U=s=>{throw TypeError(s)};var R=(s,e,n)=>e.has(s)||U("Cannot "+n);var f=(s,e,n)=>(R(s,e,"read from private field"),n?n.call(s):e.get(s)),q=(s,e,n)=>e.has(s)?U("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(s):e.set(s,n),M=(s,e,n,a)=>(R(s,e,"write to private field"),a?a.call(s,n):e.set(s,n),n),H=(s,e,n)=>(R(s,e,"access private method"),n);import{z as it,A as ot,B as z,D as ut,E as tt,F as G,G as lt,H as ct,j as o,b as I,a as K,u as N,I as T}from"./main-C8GKjXB6.js";import{r as d,_ as pt,aM as Q,S as B,aN as k,aO as D,aP as V,c as w,I as W,T as $,Q as _,O as C,p as L,A as P,aQ as ht,g as mt,aK as A,aR as E}from"./diceHelper-Bm8inGoE.js";import{u as F}from"./TokenContextWrapper-DyUhA0AV.js";import{i as S,k as ft}from"./DiceButtonWrapper-CnIgHcSU.js";var b,j,y,x,g,O,Z,Y,dt=(Y=class extends it{constructor(e,n){super();q(this,g);q(this,b);q(this,j);q(this,y);q(this,x);M(this,b,e),this.setOptions(n),this.bindMethods(),H(this,g,O).call(this)}bindMethods(){this.mutate=this.mutate.bind(this),this.reset=this.reset.bind(this)}setOptions(e){var a;const n=this.options;this.options=f(this,b).defaultMutationOptions(e),ot(this.options,n)||f(this,b).getMutationCache().notify({type:"observerOptionsUpdated",mutation:f(this,y),observer:this}),n!=null&&n.mutationKey&&this.options.mutationKey&&z(n.mutationKey)!==z(this.options.mutationKey)?this.reset():((a=f(this,y))==null?void 0:a.state.status)==="pending"&&f(this,y).setOptions(this.options)}onUnsubscribe(){var e;this.hasListeners()||(e=f(this,y))==null||e.removeObserver(this)}onMutationUpdate(e){H(this,g,O).call(this),H(this,g,Z).call(this,e)}getCurrentResult(){return f(this,j)}reset(){var e;(e=f(this,y))==null||e.removeObserver(this),M(this,y,void 0),H(this,g,O).call(this),H(this,g,Z).call(this)}mutate(e,n){var a;return M(this,x,n),(a=f(this,y))==null||a.removeObserver(this),M(this,y,f(this,b).getMutationCache().build(f(this,b),this.options)),f(this,y).addObserver(this),f(this,y).execute(e)}},b=new WeakMap,j=new WeakMap,y=new WeakMap,x=new WeakMap,g=new WeakSet,O=function(){var n;const e=((n=f(this,y))==null?void 0:n.state)??ut();M(this,j,{...e,isPending:e.status==="pending",isSuccess:e.status==="success",isError:e.status==="error",isIdle:e.status==="idle",mutate:this.mutate,reset:this.reset})},Z=function(e){tt.batch(()=>{var n,a,l,r,c,t,p,u;if(f(this,x)&&this.hasListeners()){const m=f(this,j).variables,i=f(this,j).context;(e==null?void 0:e.type)==="success"?((a=(n=f(this,x)).onSuccess)==null||a.call(n,e.data,m,i),(r=(l=f(this,x)).onSettled)==null||r.call(l,e.data,null,m,i)):(e==null?void 0:e.type)==="error"&&((t=(c=f(this,x)).onError)==null||t.call(c,e.error,m,i),(u=(p=f(this,x)).onSettled)==null||u.call(p,void 0,e.error,m,i))}this.listeners.forEach(m=>{m(f(this,j))})})},Y);function et(s,e){const n=G(),[a]=d.useState(()=>new dt(n,s));d.useEffect(()=>{a.setOptions(s)},[a,s]);const l=d.useSyncExternalStore(d.useCallback(c=>a.subscribe(tt.batchCalls(c)),[a]),()=>a.getCurrentResult(),()=>a.getCurrentResult()),r=d.useCallback((c,t)=>{a.mutate(c,t).catch(lt)},[a]);if(l.error&&ct(a.options.throwOnError,[l.error]))throw l.error;return{...l,mutate:r,mutateAsync:l.mutate}}const J=({percent:s,name:e,className:n,color:a})=>o.jsxs("svg",{className:`hp-icon ${n??""}`,height:"24px",viewBox:"0 -960 960 960",width:"24px",children:[o.jsx("defs",{children:o.jsxs("linearGradient",{id:e,x1:"0",x2:"0",y1:"1",y2:"0",children:[o.jsx("stop",{stopColor:a??"#AA1404",offset:"0%"}),o.jsx("stop",{stopColor:a??"#AA1404",offset:`${isNaN(s)?0:s}%`}),o.jsx("stop",{stopColor:"black",offset:`${Math.min(100,isNaN(s)?0:s+40)}%`}),o.jsx("stop",{stopColor:"black",offset:"100%"})]})}),o.jsx("path",{d:"m480-120-58-52q-101-91-167-157T150-447.5Q111-500 95.5-544T80-634q0-94 63-157t157-63q52 0 99 22t81 62q34-40 81-62t99-22q94 0 157 63t63 157q0 46-15.5 90T810-447.5Q771-395 705-329T538-172l-58 52Z",fill:`url(#${e})`}),o.jsx("path",{d:"m480-155.81-40.92-36.96q-98.06-89.04-162.19-153.02-64.12-63.98-101.63-113.65-37.52-49.67-52.35-90.63-14.83-40.96-14.83-83.12 0-82.74 55.8-138.54 55.81-55.81 138.54-55.81 51.74 0 97.78 24.5 46.03 24.5 79.8 71.08 34.88-46.58 80.29-71.08 45.4-24.5 97.29-24.5 82.73 0 138.54 55.79 55.8 55.78 55.8 138.48 0 42.23-14.83 83.19-14.83 40.97-52.33 90.62-37.5 49.65-101.52 113.67-64.01 64.03-162.32 153.02L480-155.81Zm0-75.42q94.32-85.61 155.52-146.46 61.2-60.85 96.82-105.96 35.62-45.12 49.62-80.15 14-35.03 14-69.36 0-59.53-39.55-98.97-39.55-39.45-98.59-39.45-47.01 0-86.95 26.89-39.95 26.88-64.52 75.92h-52.7q-24.96-49.42-64.71-76.11-39.75-26.7-86.76-26.7-58.66 0-98.4 39.45-39.74 39.44-39.74 98.99 0 34.35 14.03 69.39 14.02 35.04 49.59 80.1 35.57 45.07 96.76 105.86Q385.62-317 480-231.23Zm0-270.27Z",fill:a??"#AA1404"})]}),yt=()=>o.jsx("svg",{className:"map-icon",height:"24px",viewBox:"0 -960 960 960",width:"24px",children:o.jsx("path",{d:"m599.27-169.23-238.15-83.39-154.74 59.93q-14.65 5.77-27.5-2.91-12.84-8.67-12.84-24.49v-479.78q0-10.48 4.94-19.32 4.94-8.85 14.75-12.19l175.39-60L599.27-708l154.61-60q14.39-5.69 27.43 1.83 13.04 7.52 13.04 22.79v486.32q0 11.25-6.29 19.71-6.29 8.47-16.48 11.2l-172.31 56.92Zm-18.77-45.08V-678l-200.62-69.85v463.7l200.62 69.84Zm36.92 0 140-46.15v-469.69l-140 52.15v463.69Zm-414.46-16.15 140-53.69v-463.7l-140 47.7v469.69ZM617.42-678v463.69V-678Zm-274.46-69.85v463.7-463.7Z"})}),st=()=>o.jsx("svg",{className:"player-icon",height:"24px",viewBox:"0 -960 960 960",width:"24px",children:o.jsx("path",{d:"M480-504q-48.38 0-82.65-34.27t-34.27-82.65q0-48.39 34.27-82.66 34.27-34.27 82.65-34.27t82.65 34.27q34.27 34.27 34.27 82.66 0 48.38-34.27 82.65T480-504ZM205.54-223.38v-62.16q0-24.23 13.86-44.95 13.86-20.72 38.05-32.35 56.27-26.58 111.89-40.12t110.67-13.54q55.05 0 110.75 13.52t111.88 40.11q24.16 11.63 37.99 32.36 13.83 20.73 13.83 44.97v62.16H205.54Z"})}),at=({onClick:s,onContextMenu:e,active:n,players:a,tooltip:l})=>{const r=d.useRef(null),c=d.useRef(0);let t;return o.jsx("div",{className:`map-button ${n?"active":""}`,children:o.jsx(S,{content:l,children:o.jsxs("button",{ref:r,className:"map-default",onClick:async()=>{try{r.current&&(r.current.disabled=!0,r.current.classList.add("loading")),await s()}finally{r.current&&(r.current.disabled=!1,r.current.classList.remove("loading"))}},onContextMenu:async p=>{var u;if(p.preventDefault(),!((u=r==null?void 0:r.current)!=null&&u.disabled))try{r.current&&(r.current.disabled=!0,r.current.classList.add("loading")),await e()}finally{r.current&&(r.current.disabled=!1,r.current.classList.remove("loading"))}},onTouchStart:p=>{p.preventDefault(),p.stopPropagation(),c.current=Date.now(),t=setTimeout(async()=>{try{r.current&&(r.current.disabled=!0,r.current.classList.add("loading")),await e()}finally{r.current&&(r.current.disabled=!1,r.current.classList.remove("loading"))}},300)},onTouchEnd:async p=>{if(Date.now()-c.current<300){clearTimeout(t);try{r.current&&(r.current.disabled=!0,r.current.classList.add("loading")),await s()}finally{r.current&&(r.current.disabled=!1,r.current.classList.remove("loading"))}}else p.preventDefault(),p.stopPropagation()},children:[o.jsx(yt,{}),a?o.jsx(st,{}):null]})})})},Ct=({id:s})=>{var u,m;const e=I(),n=d.useRef(null),a=d.useRef(null),l=d.useRef(null),r=K(N(i=>i.room)),c=F(N(i=>{var h;return(h=i.tokens)==null?void 0:h.get(s)})),t=c==null?void 0:c.data,p=c==null?void 0:c.item;return d.useEffect(()=>{n&&n.current&&(n.current.value=String(t==null?void 0:t.hp))},[t==null?void 0:t.hp]),d.useEffect(()=>{a&&a.current&&(a.current.value=String(t==null?void 0:t.maxHp))},[t==null?void 0:t.maxHp]),d.useEffect(()=>{var i,h;l&&l.current&&pt.isNumber((i=t==null?void 0:t.stats)==null?void 0:i.tempHp)&&(l.current.value=String((h=t==null?void 0:t.stats)==null?void 0:h.tempHp))},[(u=t==null?void 0:t.stats)==null?void 0:u.tempHp]),o.jsxs("div",{className:"token-hp",children:[o.jsx(J,{percent:t.hp/(t.maxHp+(t.stats.tempHp??0))*100,name:p.id}),o.jsx(J,{percent:t.stats.tempHp&&t.stats.tempHp>0?100:0,name:`tempHp-${p.id}`,className:"temp-hp-icon",color:"#2248ff"}),o.jsxs("div",{className:"current-hp",children:[o.jsx(S,{content:"Set current HP",children:o.jsx("input",{ref:n,type:"text",defaultValue:t.hp,onBlur:async i=>{const h=i.target.value,v=await Q(h,t,p,a,r);v!==null&&(i.target.value=String(v),await B(v,t,p,n,l,r))},onKeyDown:async i=>{if(i.key==="ArrowUp"){const h=Math.min(t.hp+1,t.stats.tempHp?t.maxHp+t.stats.tempHp:t.maxHp);await B(h,t,p,n,l,r),i.currentTarget.value=String(h)}else if(i.key==="ArrowDown"){const h=Math.min(t.hp-1,t.stats.tempHp?t.maxHp+t.stats.tempHp:t.maxHp);await B(h,t,p,n,l,r),i.currentTarget.value=String(h)}else if(i.key==="Enter"){const h=i.currentTarget.value,v=await Q(h,t,p,a,r);v!==null&&await B(v,t,p,n,l,r)}}})}),o.jsx("span",{className:"divider"}),o.jsx(S,{content:"Set max HP",children:o.jsx("input",{type:"text",ref:a,defaultValue:t.maxHp,onKeyDown:async i=>{if(i.key==="ArrowUp")await k(t.maxHp+1,t,p,a);else if(i.key==="ArrowDown")await k(t.maxHp-1,t,p,a);else if(i.key==="Enter"){const h=Number(i.currentTarget.value.replace(/[^0-9]/g,""));await k(h,t,p,a)}},onBlur:async i=>{const h=Number(i.target.value.replace(/[^0-9]/g,""));await k(h,t,p,a)}})})]}),o.jsxs("div",{className:"bottom-row",children:[o.jsx(S,{content:"set temp HP",children:o.jsx("input",{type:"text",defaultValue:t.stats.tempHp,ref:l,onKeyDown:async i=>{if(i.key==="ArrowUp")await D((t.stats.tempHp||0)+1,t,p,n,l);else if(i.key==="ArrowDown")await D((t.stats.tempHp||0)-1,t,p,n,l);else if(i.key==="Enter"){const h=V(i.currentTarget.value);await D(h,t,p,n,l)}},onBlur:async i=>{const h=V(i.currentTarget.value);await D(h,t,p,n,l)}})}),e.role==="GM"?o.jsx(at,{onClick:async()=>{const i=!t.hpOnMap,h={...t,hpOnMap:i,hpBar:i&&!(r!=null&&r.disableHpBar)};await w(h,[s]),await W(p,h)},onContextMenu:async()=>{var h,v;const i={...t,playerMap:{ac:!!((h=t.playerMap)!=null&&h.ac),hp:!((v=t.playerMap)!=null&&v.hp)}};await w(i,[s]),await W(p,i)},active:t.hpOnMap,players:!!((m=t.playerMap)!=null&&m.hp),tooltip:"Add HP to map (players: right click)"}):null]})]})},vt=()=>o.jsx("svg",{className:"ac-icon",height:"24px",viewBox:"0 -960 960 960",width:"24px",children:o.jsx("path",{d:"M480-80q-139-35-229.5-159.5T160-516v-244l320-120 320 120v244q0 152-90.5 276.5T480-80Z"})}),Tt=({id:s,hideExtras:e})=>{var p;const n=I(),a=K(N(u=>u.room)),l=d.useRef(null),r=F(N(u=>{var m;return(m=u.tokens)==null?void 0:m.get(s)})),c=r==null?void 0:r.data,t=r==null?void 0:r.item;return d.useEffect(()=>{l&&l.current&&(l.current.value=String(c==null?void 0:c.armorClass))},[c==null?void 0:c.armorClass]),o.jsxs("div",{className:`token-ac ${e?"no-extras":""}`,children:[e?null:o.jsx(vt,{}),o.jsx(S,{content:"Set AC",children:o.jsx("input",{className:"ac-input",type:"text",size:1,value:c.armorClass,onChange:u=>{let m=1;a!=null&&a.allowNegativeNumbers&&(m=u.target.value.startsWith("-")?-1:1);const i=Number(u.target.value.replace(/[^0-9]/g,""));$(i*m,c,t,a)},onKeyDown:u=>{u.key==="ArrowUp"?$(c.armorClass+1,c,t,a):u.key==="ArrowDown"&&$(c.armorClass-1,c,t,a)}})}),n.role==="GM"&&!e?o.jsx(at,{onClick:async()=>{const u={...c,acOnMap:!c.acOnMap};await w(u,[s]),await _(t,u)},onContextMenu:async()=>{var m,i;const u={...c,playerMap:{hp:!!((m=c.playerMap)!=null&&m.hp),ac:!((i=c.playerMap)!=null&&i.ac)}};await w(u,[s]),await _(t,u)},active:c.acOnMap,players:!!((p=c.playerMap)!=null&&p.ac),tooltip:"Add AC to map (players: right click)"}):null]})},xt=()=>o.jsx("svg",{className:"initiative-icon",height:"20px",viewBox:"0 -960 960 960",width:"20px",children:o.jsx("path",{d:"m757.46-117-121-120.69-88 88-19.84-19.85q-19.58-19.58-19.58-48t19.58-48l169.84-170.04q19.58-19.38 48-19.38t48 19.38l20.04 20.04-88 88 120.69 120.81q10.35 10.54 10.35 24.19 0 13.65-10.35 24L805.65-117q-10.54 10.54-24.19 10.54-13.65 0-24-10.54Zm100.62-616.27L411.04-285.85l20.04 19.43q19.57 19.57 19.57 48.25 0 28.67-19.57 48.25l-19.85 19.84-88-88-121 120.69q-10.34 10.54-24.09 10.54t-24.1-10.54l-41.54-41.53q-10.34-10.35-10.34-24 0-13.66 10.34-24.2l120.69-120.8-88-88 20.04-20.04q19.39-19.39 48.06-19.39t48.25 19.39l20.31 20.92 447.42-447.04h128.81v128.81ZM331.27-582.69 356.5-608l24.62-25.31L356.5-608l-25.23 25.31Zm-39.42 39.54L102.12-733.27v-128.81h128.61l189.54 189.93-39.15 38.84-173.31-172.81h-49.73v49.93l173.19 173.5-39.42 39.54ZM370-324.27l432.12-431.92v-49.93h-49.93L320.27-374 370-324.27Zm0 0-24.73-25-25-24.73 25 24.73 24.73 25Z"})}),wt=({active:s,onClick:e})=>o.jsx(S,{content:"Show Token in Player Initiative List",children:o.jsx("div",{className:`player-button ${s?"active":""}`,children:o.jsx("button",{className:"player-default",onClick:e,children:o.jsx(st,{})})})}),X=async(s,e,n)=>{try{e.sync_pretty_sordid&&await C.scene.items.updateItems([s],a=>{a.forEach(l=>{l.metadata[`${L}/metadata`]={count:String(n),active:!1}})})}catch(a){P.isObject(a)&&"error"in a&&P.isObject(a.error)&&"name"in a.error&&a.error.name==="RateLimitHit"&&await C.notification.show("Too many changes, OBR rate limit prevented updating Pretty Sordid","WARNING")}},At=async(s,e,n)=>{try{n.sync_pretty_sordid&&(s&&await C.scene.items.updateItems([s],a=>{a.forEach(l=>{l.metadata[`${L}/metadata`].active=!1})}),await C.scene.items.updateItems([e],a=>{a.forEach(l=>{l.metadata[`${L}/metadata`].active=!0})}))}catch(a){P.isObject(a)&&"error"in a&&P.isObject(a.error)&&"name"in a.error&&a.error.name==="RateLimitHit"&&await C.notification.show("Too many changes, OBR rate limit prevented updating Pretty Sordid","WARNING")}},Et=({id:s})=>{const e=I(),n=d.useRef(null),a=d.useRef(null),[l,r]=K(N(u=>[u.room,u.taSettings])),c=F(N(u=>{var m;return(m=u.tokens)==null?void 0:m.get(s)})),t=c==null?void 0:c.data,p=c==null?void 0:c.item;return d.useEffect(()=>{n&&n.current&&(n.current.value=String(t==null?void 0:t.initiative))},[t==null?void 0:t.initiative]),d.useEffect(()=>{a&&a.current&&(a.current.value=String(t==null?void 0:t.stats.initiativeBonus))},[t==null?void 0:t.stats.initiativeBonus]),o.jsxs("div",{className:"initiative-wrapper",children:[o.jsx(xt,{}),o.jsx(S,{content:"Set initiative",children:o.jsx("input",{type:"number",size:1,value:String(t.initiative),step:.1,ref:n,onChange:async u=>{const m={...t,initiative:Number(u.target.value)};await w(m,[s]),await X(s,r,Number(u.target.value))},className:"initiative"})}),o.jsx(ft,{dice:`1d${(l==null?void 0:l.initiativeDice)||20}${Intl.NumberFormat("en-US",{signDisplay:"always"}).format(t.stats.initiativeBonus)}`,text:Intl.NumberFormat("en-US",{signDisplay:"always"}).format(t.stats.initiativeBonus),context:"Initiative: Roll",stats:ht,statblock:t.sheet||mt(p),onRoll:async u=>{let m=0;try{u&&"total"in u?m=u.total:u&&"values"in u&&(m=u.values.map(h=>h.value).reduce((h,v)=>h+v,0))}catch{}const i={...t,initiative:m};await w(i,[s]),await X(s,r,m)},classes:"init-wrapper"}),o.jsx(S,{content:"Set initiative bonus",children:o.jsx("input",{type:"number",size:1,defaultValue:t.stats.initiativeBonus,step:1,ref:a,onBlur:async u=>{const m=Number(u.target.value),i={...t,stats:{initiativeBonus:m}};await w(i,[s])},onKeyDown:async u=>{if(u.key==="Enter"){const m=Number(u.currentTarget.value),i={...t,stats:{initiativeBonus:m}};await w(i,[s])}},className:"initiative-bonus"})}),e.role==="GM"?o.jsx(wt,{active:!!t.playerList,onClick:async()=>{const u={...t,playerList:!t.playerList};await w(u,[s])}}):null]})},gt=(s,e,n,a)=>{let l={};return a&&(l={Authorization:`Bearer ${a}`}),A.request({url:`${E}/e5/statblock/search/`,headers:l,params:{search_string:s,take:e,skip:n},method:"GET"}).then(r=>r.data)},nt=(s,e)=>{let n={};return e&&(n={Authorization:`Bearer ${e}`}),A.request({url:`${E}/e5/statblock/${s}`,headers:n,method:"GET"}).then(a=>a.data?a.data:null)},Bt=(s,e,n,a)=>T({queryKey:["search",s,e,n],queryFn:()=>gt(s,e,n,a),enabled:s!==""}),kt=(s,e)=>T({queryKey:["slug",s],queryFn:()=>nt(s,e),enabled:s!==""}),Dt=()=>{const s=G();return et({mutationKey:[],mutationFn:({slug:e,apiKey:n})=>nt(e,n),onSuccess:(e,n)=>(s.invalidateQueries({queryKey:["slug",n.slug]}),e)})},bt=(s,e,n,a)=>{let l={};return a&&(l={Authorization:`Bearer ${a}`}),A.request({url:`${E}/pf/statblock/search/`,headers:l,params:{name:s,take:e,skip:n},method:"GET"}).then(r=>r.data)},rt=(s,e)=>{let n={};return e&&(n={Authorization:`Bearer ${e}`}),A.request({url:`${E}/pf/statblock/${s}`,headers:n,method:"GET"}).then(a=>a.data?a.data:null)},jt=(s,e)=>{let n={};return e&&(n={Authorization:`Bearer ${e}`}),A.request({url:`${E}/pf/spell/${s}`,headers:n,method:"GET"}).then(a=>a.data?a.data:null)},Ot=(s,e,n,a)=>T({queryKey:[s,e,n,"search"],queryFn:()=>bt(s,e,n,a),enabled:s!==""}),Pt=(s,e)=>T({queryKey:[s,"slug"],queryFn:()=>rt(s,e),enabled:s!==""}),Rt=(s,e)=>T({queryKey:[s,"slug"],queryFn:()=>jt(s,e),enabled:s!==""}),$t=()=>{const s=G();return et({mutationKey:[],mutationFn:({slug:e,apiKey:n})=>rt(e,n),onSuccess:(e,n)=>(s.invalidateQueries({queryKey:["slug",n.slug],refetchType:"all"}),e)})};export{vt as A,J as H,xt as I,at as M,wt as P,Ot as a,st as b,Dt as c,$t as d,Ct as e,Tt as f,Et as g,kt as h,Rt as i,Pt as j,At as s,Bt as u};
