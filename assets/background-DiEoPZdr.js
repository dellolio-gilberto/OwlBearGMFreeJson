var $=Object.defineProperty;var N=(t,e,a)=>e in t?$(t,e,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[e]=a;var v=(t,e,a)=>N(t,typeof e!="symbol"?e+"":e,a);import{O as i,V as z,W as H,X as A,Y as L,Z as f,$ as F,m as c,e as C,a0 as K,a1 as T,a2 as J,a3 as V,a4 as X,a5 as Y,a6 as j,a7 as S,i as n,a8 as y,a9 as Q,k as W,f as P,C as O,L as h,aa as E,H as I,Q as B,ab as Z,ac as _,ad as R,ae as q,af as ee,ag as ae,ah as te,ai as ie,aj as oe,ak as x}from"./diceHelper-DRI35mZO.js";import{c as p}from"./compare-Hx1G6T9l.js";function se(t){return t.type==="IMAGE"}class ne{constructor(){v(this,"promise");v(this,"disable",e=>{});this.promise=Promise.resolve()}enable(){this.promise=new Promise(e=>this.disable=e)}}const k=new ne,d={diceUser:null,disableDiceRoller:!1},re=async(t,e)=>{var o;let a;if(e)if(a=await J(t),a)f.getState().setRollerApi(a);else throw Error("Error connecting to dddice");else a=f.getState().rollerApi;(o=d.diceUser)!=null&&o.diceRendering&&!f.getState().dddiceExtensionLoaded?(await i.modal.close(T),await i.modal.open({...V,url:`https://dddice.com/room/${t.diceRoom.slug}/stream?key=${d.diceUser.apiKey}`}),a&&await X()):(a&&!f.getState().dddiceExtensionLoaded&&await Y(a,A.getState().addRoll),await i.modal.close(T))},G=async(t,e)=>{t!=null&&t.disableDiceRoller?await i.modal.close(T):await re(t,e)},b=async(t,e)=>{var r,m,g,w,u;await k.promise,k.enable();const a=c in t?t[c]:null;let o=!1,s=d.disableDiceRoller!==(a==null?void 0:a.disableDiceRoller);if(s=s||((r=d.diceUser)==null?void 0:r.diceRendering)!==((m=C(a,i.player.id))==null?void 0:m.diceRendering),d.disableDiceRoller=(a==null?void 0:a.disableDiceRoller)===void 0?!1:a.disableDiceRoller,a&&(!a.disableDiceRoller||s)){const l=C(a,i.player.id);if(l){const M=l.apiKey,U=l.diceRendering;d.diceUser?(M!==void 0&&M!==d.diceUser.apiKey||U!==d.diceUser.diceRendering)&&(await G(a,e||M!==d.diceUser.apiKey),d.diceUser=l,o=!0):(d.diceUser=l,await G(a,e||!0),o=!0)}(s||!o)&&await G(a,e),d.diceRoom=(g=a.diceRoom)==null?void 0:g.slug}else if(d.diceRoom!==((w=a==null?void 0:a.diceRoom)==null?void 0:w.slug)){const l=f.getState().rollerApi;l&&((u=a==null?void 0:a.diceRoom)!=null&&u.slug)&&(d.diceRoom=a.diceRoom.slug,await K(l,a))}k.disable(null)},ce=async()=>{const t=await i.room.getMetadata();await b(t,!0),i.room.onMetadataChange(e=>b(e,!1)),i.broadcast.onMessage(z,e=>{H(A.getState().addRoll,e.data)}),window.addEventListener("message",async e=>{try{e.type==="message"&&(e.data.type==="roll:finished"&&await L(e.data.roll,A.getState().addRoll),e.data.type==="dddice.loaded"&&(f.getState().setDddiceExtensionLoaded(!0),await b(await i.room.getMetadata(),!1)))}catch{}}),F({type:"dddice.isLoaded"}),console.info("GM's Grimoire - Finished setting up dddice")},le=async()=>{console.log("Migration from 102 to 103 running");const t=await i.scene.items.getItems(j),e=[];t.forEach(a=>{S in a.metadata&&e.push(a.id)}),await i.scene.items.deleteItems(e)},de=async()=>{console.log("Migration from 105 to 106 running"),await i.scene.items.updateItems(se,t=>{t.forEach(e=>{if(n in e.metadata){const a=e.metadata[n];if(a.hasOwnProperty("hpMode")){const s=a.hpMode==="BAR";a.hpBar=s,delete a.hpMode,e.metadata[n]={...a}}}})})},me=async()=>{console.log("Migration from 111 to 112 running");const t=await i.scene.getMetadata(),e=t[c];e.hpBarSegments===void 0&&(e.hpBarSegments=0),e.hpBarOffset===void 0&&(e.hpBarOffset=0),t[c]=e,await i.scene.setMetadata(t)},pe=async()=>{console.log("Migration from 112 to 113 running");const t=await i.scene.getMetadata(),e=t[c];e.allowNegativeNumbers===void 0&&(e.allowNegativeNumbers=!1),t[c]=e,await i.scene.setMetadata(t)},fe=async()=>{console.log("Migration to 1.4.0 running"),await i.scene.items.updateItems(t=>n in t.metadata,t=>{t.forEach(e=>{e.metadata[n].ruleset="e5",e.metadata[n].stats={initiativeBonus:0}})})},ge=async()=>{if(console.log("Migration to 1.4.1 running"),await i.player.getRole()==="GM"){const e=await i.scene.items.getItems(s=>n in s.metadata),a=[];for(const s of e){const r=await y(s.id,["TEXT","SHAPE","CURVE"]);a.push(...r)}const o=await i.scene.items.getItems(s=>S in s.metadata&&s.metadata[S].isHpText);await Q([...a,...o])}},we=async()=>{console.log("Migration to 1.6.0 running");const t=await i.scene.getMetadata();if(c in t){const e=t[c],a={},o={};a[c]={allowNegativeNumbers:e.allowNegativeNumbers,hpBarSegments:e.hpBarSegments,hpBarOffset:e.hpBarOffset,acOffset:e.acOffset,acShield:e.acShield,playerSort:e.playerSort,statblockPopover:e.statblockPopover,initiativeDice:e.initiativeDice,ruleset:e.ruleset},o[c]={version:e.version,id:e.id,groups:e.groups,openGroups:e.openGroups},await i.scene.setMetadata(o),await i.room.setMetadata(a)}},ue=async()=>{var e;console.log("Migration to 2.0.0 running");const t=await i.room.getMetadata();if(c in t){const a=t[c],o=[];(e=a.diceUser)==null||e.forEach(r=>{o.push({...r,diceTheme:"dddice-bees"})});const s={};s[c]={...a,diceUser:o},await i.room.setMetadata(s)}},he=async()=>{console.log("Migration to 3.0.0 running");const t=await i.scene.getMetadata();if(c in t){const e=t[c];await W(e,{collapsedStatblocks:[]})}await P(e=>n in e.metadata,e=>{e.forEach(a=>{const o=a.metadata[n],s={hp:o.hp,maxHp:o.maxHp,armorClass:o.armorClass,hpTrackerActive:o.hpTrackerActive,hpOnMap:o.hpOnMap,acOnMap:o.acOnMap,hpBar:o.hpBar,initiative:o.initiative,sheet:o.sheet,stats:o.stats,playerMap:{hp:!!o.canPlayersSee,ac:!!o.canPlayersSee},canPlayersSee:!1,ruleset:o.ruleset,index:o.index,group:o.group,playerList:o.playerList};a.metadata[n]=s})})},ye=async()=>{var s;const t=await i.scene.items.getItems(r=>n in r.metadata&&r.metadata[n].hpTrackerActive),e=new Map,a=new Map,o=new Map;for(const r of t){const m=r.metadata[n],g=(await y(r.id,["SHAPE"])).filter(l=>R(l,"BAR")),w=(await y(r.id,["TEXT"])).filter(l=>R(l,"HP")),u=(await y(r.id,["CURVE"])).filter(l=>R(l,"AC"));m.hpBar&&await q(r,m,g,e),m.hpOnMap&&await ee(r,m,w,a),m.acOnMap&&await ae(r,m,u,o,r.visible&&!!((s=m.playerMap)!=null&&s.ac))}await te(o),await ie(e),await oe(a),console.info("GM's Grimoire - Token initialization done")},Me=async()=>{const t=await i.room.getMetadata(),e={};if(c in t){const a=t[c];a.ruleset!=="pf"&&a.ruleset!=="e5"&&(a.ruleset="e5")}else{const a={allowNegativeNumbers:!1,hpBarSegments:0,hpBarOffset:0,acOffset:{x:0,y:0},acShield:!0,playerSort:!0,statblockPopover:{width:500,height:600},initiativeDice:20,ruleset:"e5",ignoreUpdateNotification:!1,disableDiceRoller:!1};e[c]=a}await i.room.setMetadata(e)},ve=async()=>{const t=await i.scene.getMetadata(),e={};if(c in t){const a=t[c];a.version=O,a.id||(a.id=x()),(!a.groups||a.groups.length===0)&&(a.groups=["Default"]),a.openGroups===void 0&&(a.openGroups=["Default"]),a.collapsedStatblocks||(a.collapsedStatblocks=[]),a.statblockPopoverOpen={},e[c]=a}else{const a={version:O,id:x(),groups:["Default"],openGroups:["Default"],collapsedStatblocks:[],openStatblocks:[],statblockPopoverOpen:{}};e[c]=a}await i.scene.setMetadata(e)},Re=async()=>{await i.contextMenu.create({id:`${h}/popover`,icons:[{icon:"/OwlBearGMFreeJson/iconPopover.svg",label:"GM's Grimoire",filter:{some:[{key:["metadata",`${n}`,"hpTrackerActive"],value:!0}],roles:["GM"]}},{icon:"/OwlBearGMFreeJson/iconPopover.svg",label:"GM's Grimoire",filter:{every:[{key:["metadata",`${n}`,"hpTrackerActive"],value:!0,coordinator:"&&"},{key:["createdUserId"],value:i.player.id}],roles:["PLAYER"]}}],embed:{url:"/OwlBearGMFreeJson/popover.html",height:100}}),await i.contextMenu.create({id:`${h}/remove`,icons:[{icon:"/OwlBearGMFreeJson/iconOff.svg",label:"Remove from Grimoire",filter:{some:[{key:["metadata",`${n}`,"hpTrackerActive"],value:!0}],roles:["GM"]}}],onClick:async t=>{const e=t.items.filter(a=>n in a.metadata&&a.metadata[n].hpTrackerActive);await P(e.map(a=>a.id),a=>{a.forEach(o=>{if(n in o.metadata){const s=o.metadata[n];o.metadata[n]={...s,hpTrackerActive:!1}}})})}}),await i.contextMenu.create({id:`${h}/add-to-grimoire`,icons:[{icon:"/OwlBearGMFreeJson/icon.svg",label:"Add to Grimoire",filter:{every:[{key:["metadata",`${n}`],value:void 0,coordinator:"||"},{key:["metadata",`${n}`,"hpTrackerActive"],value:!1}],some:[{key:"type",value:"IMAGE",coordinator:"&&"},{key:"layer",value:"CHARACTER",coordinator:"||"},{key:"layer",value:"MOUNT",coordinator:"||"}],roles:["GM"]}}],onClick:async t=>{const e=t.items.filter(s=>(s.layer==="CHARACTER"||s.layer==="MOUNT")&&s.type==="IMAGE"),a=await E(e),o=await i.scene.items.getItems(a);for(const s of o)if(n in s.metadata){const r=s.metadata[n];await I(s,r),await B(s,r)}}}),await i.contextMenu.create({id:`${h}/add-prop-to-grimoire`,icons:[{icon:"/OwlBearGMFreeJson/icon.svg",label:"Add to Grimoire",filter:{every:[{key:["metadata",`${n}`],value:void 0,coordinator:"||"},{key:["metadata",`${n}`,"hpTrackerActive"],value:!1},{key:"type",value:"IMAGE",coordinator:"&&"},{key:"layer",value:"PROP"}],roles:["GM"]}}],onClick:async t=>{const e=t.items.filter(s=>s.layer==="PROP"&&s.type==="IMAGE"),a=await E(e);(await i.scene.items.getItems(a)).forEach(s=>{if(n in s.metadata){const r=s.metadata[n];I(s,r),B(s,r)}})}})},ke=async()=>{const t=await i.scene.getMetadata();if(c in t){const e=t[c];e.version&&(p(e.version,"1.0.3","<")&&await le(),p(e.version,"1.0.6","<")&&await de(),p(e.version,"1.1.2","<")&&await me(),p(e.version,"1.1.3","<")&&await pe(),p(e.version,"1.4.0","<")&&await fe(),p(e.version,"1.4.1","<")&&await ge(),p(e.version,"1.6.0","<")&&await we(),p(e.version,"2.0.0","<")&&await ue(),p(e.version,"3.0.0","<")&&await he())}},D=async()=>{try{await ke()}catch(t){console.warn("GM's Grimoire - Error while running migrations",t)}try{await ye()}catch(t){console.warn("GM's Grimoire - Error while initializing items",t)}try{await ve()}catch(t){console.warn("GM's Grimoire - Error while initializing Scene",t)}},Ge=async()=>{i.scene.items.onChange(async t=>{const e=t.filter(a=>n in a.metadata&&a.metadata[n].hpTrackerActive);await Z(e),await _(e)})};i.onReady(async()=>{console.info(`GM's Grimoire - version ${O} initializing`);try{await Re()}catch{console.warn("GM's Grimoire - error while setting up context menu")}if(await i.player.getRole()==="GM"){try{await Me()}catch(e){console.warn("GM's Grimoire - Error while initializing Room",e)}i.scene.onReadyChange(async e=>{e&&await D()}),await i.scene.isReady()&&await D();try{await Ge()}catch(e){console.warn("GM's Grimoire - error while initializing Token event handler",e)}}try{await ce()}catch(t){await i.notification.show("GM's Grimoire dice roller initialization error. Check browser logs for more info.","ERROR"),console.warn("GM's Grimoire - error while intializing dddice",t)}console.info("GM's Grimoire - initialization done")});
