import{Q as cs,t as De,w as rs,x as os,y as ds,u as O,j as e,L as ie,b as G,M as us,r as ms,a as ae}from"./main-C2BHiGAC.js";import{u as we}from"./TokenContextWrapper-BKEMl2-3.js";import{r as y,ax as hs,g as Ie,ay as xs,Q as Ce,h as Le,i as re,az as Ae,L as ps,N as fs,aA as ee,D as T,M as qe,P as ze,S as Pe,aB as oe,e as he,aC as Be,aD as js,aE as gs,aF as Ee,aG as vs,c as Fe,O as U,d as xe,aH as Re,aI as bs,f as _e,at as de,a6 as Ns,aJ as Me,aK as ce,aL as Je,j as He,aM as Ve,k as Ke,l as We,a as ys,aN as _s,aO as Qe,a3 as Ss,a5 as ks,aP as ws}from"./diceHelper-DyDajmT-.js";import{e as Ue,g as Ge,f as Ze,h as Xe,i as Cs,j as $s}from"./usePfApi-DU8euMVs.js";import{j as W,i as q,k as P,l as te,a as Ts,g as ue}from"./DiceButtonWrapper-Bu-RYWmC.js";import{R as Ds}from"./RollLog-DZTuG7t4.js";var As=class extends cs{constructor(s,a){super(s,a)}bindMethods(){super.bindMethods(),this.fetchNextPage=this.fetchNextPage.bind(this),this.fetchPreviousPage=this.fetchPreviousPage.bind(this)}setOptions(s){super.setOptions({...s,behavior:De()})}getOptimisticResult(s){return s.behavior=De(),super.getOptimisticResult(s)}fetchNextPage(s){return this.fetch({...s,meta:{fetchMore:{direction:"forward"}}})}fetchPreviousPage(s){return this.fetch({...s,meta:{fetchMore:{direction:"backward"}}})}createResult(s,a){var x,j;const{state:i}=s,t=super.createResult(s,a),{isFetching:n,isRefetching:p,isError:l,isRefetchError:c}=t,o=(j=(x=i.fetchMeta)==null?void 0:x.fetchMore)==null?void 0:j.direction,d=l&&o==="forward",f=n&&o==="forward",r=l&&o==="backward",u=n&&o==="backward";return{...t,fetchNextPage:this.fetchNextPage,fetchPreviousPage:this.fetchPreviousPage,hasNextPage:rs(a,i.data),hasPreviousPage:os(a,i.data),isFetchNextPageError:d,isFetchingNextPage:f,isFetchPreviousPageError:r,isFetchingPreviousPage:u,isRefetchError:c&&!d&&!r,isRefetching:p&&!f&&!u}}};function Ye(s,a){return ds(s,As)}const es=y.createContext(null),B=()=>{const s=y.useContext(es);if(s===null)throw new Error("E5StatblockContext is not set");return s},Es=s=>{const a=we(O(i=>{var t;return(t=i.tokens)==null?void 0:t.get(s.itemId)}));if(a){const i=a.data,t=a.item,n=hs(i,s.statblock.stats,s.statblock.equipment||[]);return e.jsx(es.Provider,{value:{tokenName:Ie(t),data:i,item:t,statblock:s.statblock,itemId:s.itemId,stats:{strength:n.stats.strength,dexterity:n.stats.dexterity,constitution:n.stats.constitution,wisdom:n.stats.wisdom,intelligence:n.stats.intelligence,charisma:n.stats.charisma},equipmentBonuses:n},children:s.children})}return e.jsx(ie,{})},Fs="_statblock_14qyr_1",Rs="_title_14qyr_11",Os="_name_14qyr_20",Is="_note_14qyr_27",Ls="_headerActions_14qyr_33",Q={statblock:Fs,title:Rs,name:Os,note:Is,headerActions:Ls},qs="_values_1bw4j_1",zs={values:qs},Ps=()=>{const{item:s}=B();return e.jsxs("div",{className:zs.values,children:[e.jsx(Ue,{id:s.id}),e.jsx(Ge,{id:s.id})]})},Bs="_content_19vac_10",Ms="_tabs_19vac_27",Js="_tab_19vac_27",Hs="_activeTab_19vac_51",Vs="_wrapper_19vac_57",Ks="_actionWrapper_19vac_67",Y={content:Bs,tabs:Ms,tab:Js,activeTab:Hs,wrapper:Vs,actionWrapper:Ks},Ws="_lineBreak_1ql1p_1",Qs="_line_1ql1p_1",Us="_fancyLine_1ql1p_25",Gs="_decoration_1ql1p_30",me={lineBreak:Ws,line:Qs,fancyLine:Us,decoration:Gs},R=()=>e.jsx("div",{className:me.lineBreak,children:e.jsx("span",{className:me.line})}),J=()=>e.jsx("div",{className:me.fancyLine,children:e.jsx("span",{className:me.decoration})}),Zs="_general_bqxrl_1",Xs="_hitDiceWrapper_bqxrl_5",Ys="_hitDice_bqxrl_5",et="_stats_bqxrl_15",st="_savingThrows_bqxrl_22",tt="_stat_bqxrl_15",nt="_name_bqxrl_35",it="_value_bqxrl_48",at="_header_bqxrl_64",lt="_infos_bqxrl_75",ct="_ac_bqxrl_82",V={general:Zs,hitDiceWrapper:Xs,hitDice:Ys,stats:et,savingThrows:st,stat:tt,name:nt,value:it,header:at,infos:lt,ac:ct},pe=({about:s,slug:a,statblock:i,stats:t,context:n,defaultOpen:p,hideTitle:l})=>{const c=G.getState().room,[o,d]=xs(`${Ce}.about.${a}`,!!p);return s?e.jsxs("div",{className:`about ${l?"no-title":""}`,children:[l?null:e.jsx("h3",{children:"About"}),e.jsx("button",{className:`expand ${o?"open":null}`,onClick:()=>d(!o)}),e.jsx("div",{className:`about-content-wrapper ${o?"open":"hidden"}`,children:e.jsx("div",{className:"about-content",children:e.jsx(W,{text:s,context:n||(i==null?void 0:i.name)||"Custom Roll",statblock:i==null?void 0:i.name,stats:t||{strength:(i==null?void 0:i.stats.strength)||0,dexterity:(i==null?void 0:i.stats.dexterity)||0,constitution:(i==null?void 0:i.stats.constitution)||0,intelligence:(i==null?void 0:i.stats.intelligence)||0,wisdom:(i==null?void 0:i.stats.wisdom)||0,charisma:(i==null?void 0:i.stats.charisma)||0},proficiencyBonus:(c==null?void 0:c.ruleset)==="e5"?i.proficiency_bonus:null})})})]}):null},rt="_box_9rgpd_1",ot="_used_9rgpd_16",dt="_unused_9rgpd_22",ge={box:rt,used:ot,unused:dt},ut=({limitValues:s,itemId:a})=>e.jsx(e.Fragment,{children:Array(s.max).fill(0).map((i,t)=>{const n=t<s.used;return e.jsx("div",{className:`limit-use ${n?"used":""}`,onClick:async()=>{await Le([a],p=>{p.forEach(l=>{var c;if(l){const o=l.metadata[re];if(o){const d=(c=o.stats.limits)==null?void 0:c.findIndex(f=>f.id===s.id);d!==void 0&&(l.metadata[re].stats.limits[d].used=n?s.used-1:s.used+1)}}})})}},t)})}),mt=({limitValues:s,itemId:a})=>{const i=s.max-s.used,t=async l=>{await Le([a],c=>{c.forEach(o=>{var d;if(o){const f=o.metadata[re];if(f){const r=(d=f.stats.limits)==null?void 0:d.findIndex(u=>u.id===s.id);r!==void 0&&(o.metadata[re].stats.limits[r].used=Math.max(Math.min(s.used+l,s.max),0))}}})})},n=Ae(async()=>await t(5),async()=>await t(1),500),p=Ae(async()=>await t(-5),async()=>await t(-1),500);return e.jsxs("div",{className:`${ge.box} limit-box`,children:[s.used>0?e.jsx(q,{content:"Click to reduce uses by one (Long press for -5)",children:e.jsx("div",{className:ge.used,style:{flexGrow:s.used},...p,children:s.used})}):null,i>0?e.jsx(q,{content:"Click to mark on use (Long press for +5)",children:e.jsx("div",{className:ge.unused,style:{flexGrow:i},...n,children:i})}):null]})},se=({limit:s,title:a,limitValues:i,itemId:t,hideReset:n,hideDescription:p})=>{const l=()=>a==="name"?e.jsx("h4",{children:s.name}):a==="uses"?e.jsx("b",{children:"uses"}):null;return e.jsxs("div",{className:"limit",children:[e.jsxs("div",{className:"limit-heading",children:[l(),e.jsx("div",{className:"limit-uses",children:i.max>10?e.jsx(mt,{limitValues:i,itemId:t}):e.jsx(ut,{limitValues:i,itemId:t})})]}),s.description&&!p?e.jsx(us,{remarkPlugins:[ms],children:s.description}):null,s.resets&&!n?e.jsxs("div",{children:[e.jsx("b",{children:"Resets after:"})," ",s.resets.join(", ")]}):null]})},ht=["strength","dexterity","constitution","intelligence","wisdom","charisma"],xt=()=>{var d,f;const{statblock:s,stats:a,tokenName:i,item:t,equipmentBonuses:n,data:p}=B(),l=(d=p.stats.limits)==null?void 0:d.find(r=>r.id==="Hit Dice");let c=null,o=null;if(s.hp.hit_dice)try{c={name:"Hit Dice",uses:Number(s.hp.hit_dice.split("d")[0]),resets:["Long Rest"]},o=s.hp.hit_dice.split("d")[1].split("+")[0]}catch{}return e.jsxs("div",{className:V.general,children:[e.jsxs("div",{className:V.ac,children:[e.jsx("b",{children:"Armor Class:"})," ",e.jsx(Ze,{id:t.id,hideExtras:!0}),s.armor_class.special?e.jsxs("span",{children:["(",s.armor_class.special,")"]}):null]}),e.jsxs("div",{children:[e.jsx("b",{children:"Speed:"})," ",Object.entries(s.speed).map(([r,u])=>{if(r!=="notes"){const g=n.statblockBonuses.speed[r];if(u||g)return`${r} ${u+g} ft.`}return null}).filter(r=>!!r).join(", ")]}),s.proficiency_bonus?e.jsxs("div",{children:[e.jsx("b",{children:"Proficiency Bonus:"})," ",s.proficiency_bonus]}):null,e.jsx(R,{}),c&&l&&o?e.jsxs("div",{className:V.hitDiceWrapper,children:[e.jsx("h3",{className:V.hitDice,children:"Hit Dice"}),e.jsx(se,{limit:c,title:"uses",limitValues:l,itemId:t.id,hideReset:!0}),e.jsx("div",{className:"dice-button-wrapper",children:e.jsx(P,{dice:`1d${o}+CON`,text:`1d${o}+CON`,context:"Hit Dice",stats:a,statblock:i,onRoll:async r=>{let u=0;try{r&&"total"in r?u=r.total:r&&"values"in r&&(u=r.values.map(g=>g.value).reduce((g,x)=>g+x,0))}catch{}if(u){const g={...p,hp:Math.min(p.hp+u,p.maxHp)};await ps(t,g),await fs(g,[t.id])}await ee(t.id,l)},limitReached:c.uses===l.used,proficiencyBonus:s.proficiency_bonus})}),e.jsx(R,{})]}):null,e.jsxs("ul",{className:V.stats,children:[e.jsxs("li",{className:V.header,children:[e.jsx("div",{}),e.jsx("div",{children:"Check"}),e.jsx("div",{children:"Save"})]}),ht.map(r=>{const u=`${r}_save`,g=n.stats[r],x=Math.floor((g-10)/2),j=s.saving_throws[u]||x,h=Object.hasOwn(n.statblockBonuses.savingThrows,u)?j+n.statblockBonuses.savingThrows[u]:j;return e.jsxs("li",{className:V.stat,children:[e.jsxs("div",{className:V.name,children:[e.jsx("span",{children:r.substring(0,3)}),e.jsx("span",{children:g})]}),e.jsxs("div",{className:V.value,children:[e.jsx(P,{dice:`d20${Intl.NumberFormat("en-US",{signDisplay:"always"}).format(Math.floor((g-10)/2))}`,text:Intl.NumberFormat("en-US",{signDisplay:"always"}).format(Math.floor((g-10)/2)),stats:a,context:`${T.capitalize(r)}: Check`,statblock:i,proficiencyBonus:s.proficiency_bonus}),e.jsx(P,{dice:`d20${Intl.NumberFormat("en-US",{signDisplay:"always"}).format(Math.floor(h))}`,text:Intl.NumberFormat("en-US",{signDisplay:"always"}).format(Math.floor(h)),stats:a,context:`${T.capitalize(r.substring(0,3))}: Save`,statblock:i,proficiencyBonus:s.proficiency_bonus})]})]},r)})]}),e.jsx(R,{}),s.limits&&s.limits.length>0?e.jsxs("div",{children:[e.jsx("h3",{className:V.hitDice,children:"Limits"}),s.limits.map((r,u)=>{var x,j;return((x=p.stats.limits)==null?void 0:x.find(h=>h.id===r.name))?e.jsxs("div",{children:[e.jsx(se,{limit:r,title:"name",limitValues:(j=p.stats.limits)==null?void 0:j.find(h=>h.id===r.name),itemId:t.id}),e.jsx(R,{})]},u):null})]}):null,e.jsxs("ul",{className:V.infos,children:[s.senses||n.statblockBonuses.senses?e.jsxs("li",{children:[e.jsx("b",{children:"Senses:"})," ",(s.senses||[]).concat(...n.statblockBonuses.senses).join(", ")]}):null,e.jsxs("li",{children:[e.jsx("b",{children:"Languages:"})," ",(f=s.languages)==null?void 0:f.join(", ")]}),s.challenge_rating||!T.isNull(s.cr)?e.jsxs("li",{children:[e.jsx("b",{children:"Challenge:"})," ",s.cr," ",s.challenge_rating?`(${s.challenge_rating})`:null]}):null,s.damage_vulnerabilities||n.statblockBonuses.damageVulnerabilities?e.jsxs("li",{children:[e.jsx("b",{children:"Damage Vulnerabilities:"})," ",s.damage_vulnerabilities," ",n.statblockBonuses.damageVulnerabilities]}):null,s.damage_resistances||n.statblockBonuses.damageResistances?e.jsxs("li",{children:[e.jsx("b",{children:"Damage Resistances:"})," ",s.damage_resistances," ",n.statblockBonuses.damageResistances]}):null,s.damage_immunities||n.statblockBonuses.damageImmunities?e.jsxs("li",{children:[e.jsx("b",{children:"Damage Immunities:"})," ",s.damage_immunities," ",n.statblockBonuses.damageResistances]}):null,s.condition_immunities||n.statblockBonuses.conditionImmunities?e.jsxs("li",{children:[e.jsx("b",{children:"Condition Immunities:"})," ",s.condition_immunities," ",n.statblockBonuses.conditionImmunities]}):null]}),e.jsx(R,{}),e.jsx(pe,{about:s.about,slug:s.slug,statblock:s,stats:a,context:s.name})]})},pt="_heading_quifz_1",ft="_skills_quifz_7",jt="_skill_quifz_7",ve={heading:pt,skills:ft,skill:jt},gt=(s,a)=>{let i=0;return s==="acrobatics"?i=a.dexterity:s==="animal_handling"?i=a.wisdom:s==="arcana"?i=a.intelligence:s==="athletics"?i=a.strength:s==="deception"?i=a.charisma:s==="history"?i=a.intelligence:s==="insight"?i=a.wisdom:s==="intimidation"?i=a.charisma:s==="investigation"?i=a.intelligence:s==="medicine"?i=a.wisdom:s==="nature"?i=a.intelligence:s==="perception"?i=a.wisdom:s==="performance"||s==="persuasion"?i=a.charisma:s==="religion"?i=a.intelligence:s==="sleight_of_hand"||s==="stealth"?i=a.dexterity:s==="survival"&&(i=a.wisdom),Math.floor((i-10)/2)},vt=()=>{const{statblock:s,stats:a,tokenName:i,equipmentBonuses:t}=B();return e.jsxs("div",{children:[e.jsx("h3",{className:ve.heading,children:"Skills"}),e.jsx(J,{}),e.jsx("ul",{className:ve.skills,children:s.skills?Object.entries(s.skills).map(([n,p])=>{const l=(p||gt(n,a))+t.statblockBonuses.skills[n]+(t.statblockBonuses.proficiencies.includes(n)?s.proficiency_bonus:0);return e.jsxs("li",{className:ve.skill,style:{background:`linear-gradient(to right, #3f3f3f, transparent  ${l/10*100}%)`},children:[e.jsx("b",{children:T.capitalize(n.replaceAll("_"," "))}),e.jsx(P,{dice:`d20${Intl.NumberFormat("en-US",{signDisplay:"always"}).format(Math.floor(l))}`,text:Intl.NumberFormat("en-US",{signDisplay:"always"}).format(Math.floor(l)),stats:a,context:`${T.capitalize(n)}: Check`,statblock:i,proficiencyBonus:s.proficiency_bonus})]},n)}):null})]})},fe=qe()(ze(s=>({activeTab:{},setActiveTab:(a,i)=>s(t=>{const n=t.activeTab;return t.activeTab[a]!==i?(n[a]=i,{activeTab:n}):t})}),{name:`${Ce}.activeTab`,storage:Pe(()=>localStorage)})),bt="_heading_1jstp_1",Nt="_itemName_1jstp_7",Oe={heading:bt,itemName:Nt},be=({ability:s,proficient:a,range:i})=>{var j;const{item:t,stats:n,data:p,tokenName:l,statblock:c}=B(),o=(j=p.stats.limits)==null?void 0:j.find(h=>{var v;return h.id===((v=s.limit)==null?void 0:v.name)}),d=o&&o.max===o.used,f=y.useMemo(()=>{let h={bonus:void 0,stat:""};const v=(b,$,w)=>{const D=Math.floor(($-10)/2);return T.isUndefined(w.bonus)||D>w.bonus?{bonus:D,stat:b}:w};return s.stat_bonus&&s.stat_bonus.forEach(b=>{b==="STR"?h=v(b,n.strength,h):b==="DEX"?h=v(b,n.dexterity,h):b==="CON"?h=v(b,n.constitution,h):b==="INT"?h=v(b,n.intelligence,h):b==="WIS"?h=v(b,n.wisdom,h):b==="CHA"&&(h=v(b,n.charisma,h))}),h},[s,n]),r=s.attack_bonus||0,u=a&&c.proficiency_bonus?c.proficiency_bonus:0,g=(f.bonus||0)+r+u,x=y.useMemo(()=>{const h=[];return r&&h.push(`Attack: ${r}`),f.bonus&&h.push(`Stat (${f.stat}): ${f.bonus}`),u&&h.push(`Proficiency: ${u}`),h.join(", ")},[r,f,u]);return s.needs_proficiency&&!a?null:e.jsxs("li",{className:"e5-ability",children:[e.jsxs("span",{className:"ability-info",children:[e.jsx("b",{className:"ability-name",children:s.name}),i?e.jsxs("div",{children:[e.jsx("b",{children:"Range: "}),e.jsx("span",{children:i.replace("units","ft")})]}):null,s.limit&&p.stats.limits&&o?e.jsx(se,{limit:s.limit,title:"uses",limitValues:o,itemId:t.id}):null]}),e.jsx(pe,{slug:s.name,statblock:c,stats:n,about:s.desc||"",context:T.capitalize(s.name),defaultOpen:!0,hideTitle:!0}),e.jsxs("span",{className:"ability-extra-info",children:[s.stat_bonus&&s.stat_bonus.length>0||r!=0?e.jsxs("span",{className:"extra-info-with-button",children:[e.jsx("i",{children:"Hit:"}),e.jsx(q,{content:x,duration:200,delay:1e3,children:e.jsx("span",{children:e.jsx(P,{dice:`d20+${g}`,text:`+${g}`,context:`${T.capitalize(s.name)}: To Hit`,statblock:l,stats:n,onRoll:async()=>{await ee(t.id,o)},limitReached:d,proficiencyBonus:c.proficiency_bonus})})})]}):null,s.damage_dice?e.jsxs("span",{className:"extra-info-with-button",children:[e.jsx("i",{children:"Damage:"}),T.isInteger(Number(s.damage_dice))?e.jsx("b",{children:s.damage_dice}):e.jsx(P,{dice:s.damage_dice,text:s.damage_dice,context:`${T.capitalize(s.name)}: Damage`,statblock:l,stats:n,onRoll:s.attack_bonus?void 0:async()=>{await ee(t.id,o)},limitReached:s.attack_bonus?void 0:d,damageDie:!0,proficiencyBonus:c.proficiency_bonus})]}):null]})]},s.name)},yt="_itemCharges_vtf5f_1",_t={itemCharges:yt},$e=({equippedItem:s,showReset:a})=>{var p;const{data:i,item:t}=B(),n=(p=i.stats.limits)==null?void 0:p.find(l=>{var c;return l.id===((c=s==null?void 0:s.charges)==null?void 0:c.name)});return e.jsx(e.Fragment,{children:s!=null&&s.charges&&n?e.jsxs("div",{className:_t.itemCharges,children:["Charges:",e.jsx(se,{limit:s.charges,title:"none",hideReset:!a,hideDescription:!0,limitValues:n,itemId:t.id})]}):null})},X=({heading:s,abilities:a,abilityKey:i})=>{var c,o,d,f;const{statblock:t,equipmentBonuses:n,data:p}=B(),l=n.itemActions.items.flatMap(r=>({item:r.itemId,abilities:i in r?r[i]:[]}));return e.jsxs("div",{children:[e.jsx("h3",{className:Oe.heading,children:s}),e.jsx(J,{}),a==null?void 0:a.map((r,u)=>e.jsxs("div",{children:[e.jsx(be,{ability:r,proficient:!!r.use_proficiency}),e.jsx(R,{})]},u)),(o=(c=t.equipment)==null?void 0:c.filter(r=>r.embedded&&oe(p,r)))==null?void 0:o.map(r=>l.filter(u=>u.item===r.item.id).map(u=>u.abilities.map((g,x)=>e.jsxs("div",{children:[e.jsx(be,{ability:g,proficient:r.proficient}),e.jsx(R,{})]},x)))),(f=(d=t.equipment)==null?void 0:d.filter(r=>!r.embedded&&oe(p,r)))==null?void 0:f.map(r=>l.filter(u=>u.item===r.item.id).map((u,g)=>u.abilities.length?e.jsxs("div",{children:[e.jsx("h4",{className:Oe.itemName,children:r==null?void 0:r.item.name}),e.jsx($e,{equippedItem:r.item}),e.jsx(J,{}),u.abilities.map((x,j)=>e.jsxs("div",{children:[e.jsx(be,{ability:x,proficient:r.proficient,range:r.item.tags&&r.item.tags.includes("throw")&&r.item.range||r.item.range?r.item.range:void 0}),e.jsx(R,{})]},j))]},g):null))]})},St="_content_vnnfs_1",kt="_tabs_vnnfs_18",wt="_tab_vnnfs_18",Ct="_activeTab_vnnfs_42",$t="_wrapper_vnnfs_48",Tt="_actionWrapper_vnnfs_53",L={content:St,tabs:kt,tab:wt,activeTab:Ct,wrapper:$t,actionWrapper:Tt},Dt=()=>{const{statblock:s,item:a}=B(),{activeTab:i,setActiveTab:t}=fe(),n=`${a.id}-action`,p=y.useMemo(()=>{var d,f,r,u,g,x,j,h;const o=[];return((d=s.actions)!=null&&d.length||(f=s.equipment)!=null&&f.some(v=>{var b,$;return($=(b=v.item.bonus)==null?void 0:b.actions)==null?void 0:$.length}))&&o.push("action"),((r=s.bonus_actions)!=null&&r.length||(u=s.equipment)!=null&&u.some(v=>{var b,$;return($=(b=v.item.bonus)==null?void 0:b.bonus_actions)==null?void 0:$.length}))&&o.push("bonus"),((g=s.reactions)!=null&&g.length||(x=s.equipment)!=null&&x.some(v=>{var b,$;return($=(b=v.item.bonus)==null?void 0:b.reactions)==null?void 0:$.length}))&&o.push("reaction"),(j=s.mythic_actions)!=null&&j.length&&o.push("mythic"),(h=s.lair_actions)!=null&&h.length&&o.push("lair"),o},[s]),l=n in i?i[n]:p[0],c=y.useMemo(()=>l==="action"?e.jsx(X,{heading:"Actions",abilities:s.actions,abilityKey:"actions"}):l==="bonus"?e.jsx(X,{heading:"Bonus Actions",abilities:s.bonus_actions,abilityKey:"bonus_actions"}):l==="reaction"?e.jsx(X,{heading:"Reactions",abilities:s.reactions,abilityKey:"reactions"}):l==="mythic"?e.jsx(X,{heading:"Mythic Actions",abilities:s.mythic_actions,abilityKey:"mythic_actions"}):l==="lair"?e.jsx(X,{heading:"Lair Actions",abilities:s.lair_actions,abilityKey:"lair_actions"}):e.jsx(e.Fragment,{}),[l,s]);return e.jsx(e.Fragment,{children:p.length===1?e.jsx(e.Fragment,{children:c}):e.jsxs("div",{className:L.actionWrapper,children:[e.jsx("ul",{className:L.tabs,children:p.map((o,d)=>e.jsx("li",{className:l===o?`${L.tab} ${L.activeTab}`:L.tab,onClick:()=>t(n,o),children:o},d))}),e.jsx("div",{className:L.content,children:c})]})})},At="_spellFilters_1mi4b_1",Et="_left_1mi4b_9",Ft="_spellFilter_1mi4b_1",Rt="_active_1mi4b_22",Ot="_sticky_1mi4b_27",M={spellFilters:At,left:Et,spellFilter:Ft,active:Rt,sticky:Ot},ss=s=>e.jsx("div",{className:`${M.spellFilters} ${s.left?M.left:null}`,children:s.filters.map(a=>{let i=!1;return a==="All"&&s.spellFilter.length===0||a==="Cant"&&s.spellFilter.indexOf(0)>=0||a==="Const"&&s.spellFilter.indexOf(-1)>=0?i=!0:i=s.spellFilter.indexOf(parseInt(a))>=0,e.jsx("button",{className:`button ${M.spellFilter} ${i?M.active:null}`,onClick:()=>{if(a==="All")s.setSpellFilter([]);else if(a==="Cant"){const t=Array.from(s.spellFilter);t.indexOf(0)>=0?t.splice(t.indexOf(0),1):t.push(0),s.setSpellFilter(t)}else if(a==="Const"){const t=Array.from(s.spellFilter);t.indexOf(-1)>=0?t.splice(t.indexOf(-1),1):t.push(-1),s.setSpellFilter(t)}else{const t=parseInt(a),n=Array.from(s.spellFilter);n.indexOf(t)>=0?n.splice(n.indexOf(t),1):n.push(t),s.setSpellFilter(n)}},children:a},a)})}),It="_heading_gze6k_1",Lt="_top_gze6k_7",qt="_info_gze6k_13",zt="_sticky_gze6k_24",Pt="_spellAttack_gze6k_37",Bt="_spellList_gze6k_43",Mt="_spellMain_gze6k_48",Jt="_spellInfo_gze6k_55",Ht="_spellHeader_gze6k_61",Vt="_spellName_gze6k_67",Kt="_spellLevel_gze6k_74",Wt="_spellDamage_gze6k_79",Qt="_spellComponents_gze6k_83",Ut="_materialDetails_gze6k_90",Gt="_spellMoreInfo_gze6k_96",Zt="_open_gze6k_102",Xt="_moreInfoContent_gze6k_106",Yt="_micOpen_gze6k_116",en="_infoBits_gze6k_120",E={heading:It,top:Lt,info:qt,sticky:zt,spellAttack:Pt,spellList:Bt,spellMain:Mt,spellInfo:Jt,spellHeader:Ht,spellName:Vt,spellLevel:Kt,spellDamage:Wt,spellComponents:Qt,materialDetails:Ut,spellMoreInfo:Gt,open:Zt,moreInfoContent:Xt,micOpen:Yt,infoBits:en},sn="_spellSlots_1bdb5_1",tn="_spellSlotLimits_1bdb5_5",nn="_spellSlotEntry_1bdb5_11",an="_spellSlotLevel_1bdb5_21",le={spellSlots:sn,spellSlotLimits:tn,spellSlotEntry:nn,spellSlotLevel:an},ln=()=>{const{statblock:s,item:a,data:i}=B();return e.jsx(e.Fragment,{children:s.spell_slots&&s.spell_slots.length>0?e.jsx("div",{className:le.spellSlots,children:e.jsx("div",{className:le.spellSlotLimits,children:s.spell_slots.sort((t,n)=>t.level-n.level).map((t,n)=>{var l;const p=(l=i.stats.limits)==null?void 0:l.find(c=>c.id===t.limit.name);return p?e.jsxs("div",{className:le.spellSlotEntry,children:[e.jsxs("div",{className:le.spellSlotLevel,children:["Level: ",t.level]}),e.jsx(se,{limit:t.limit,title:"none",hideReset:!0,limitValues:p,itemId:a.id})]},n):null})})}):null})},Ne=({spell:s,statblock:a,stats:i,spellSlots:t,charges:n,chargesUsed:p,tokenData:l,itemId:c,dc:o,attack:d,embedded:f})=>{var D;const[r,u]=y.useState(!1),g=B(),x=G(O(A=>A.room)),j=he(O(A=>A.addRoll)),h=()=>s.level===0?"Cantrip":s.level===1?"1st level":s.level===2?"2nd level":s.level===3?"3rd level":`${s.level}th level`,v=s.desc?Be(s.desc):null,b=y.useMemo(()=>{var A;if(T.isUndefined(n)){if(t)return(A=t==null?void 0:t.find(m=>m.level===s.level))==null?void 0:A.limit}else return n},[t,s,n]),$=(D=l==null?void 0:l.stats.limits)==null?void 0:D.find(A=>A.id===(b==null?void 0:b.name)),w=y.useMemo(()=>s.level===0?!1:$&&$.max<$.used+(p||1)||t&&t.length>0&&!b,[s,$,t,b]);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:E.spellMain,children:[e.jsxs("div",{className:E.spellInfo,children:[e.jsxs("div",{className:E.spellHeader,children:[e.jsx("h4",{className:E.spellName,children:s.name}),e.jsxs("span",{className:E.spellLevel,children:["(",h(),")"]}),f&&n&&$&&c?e.jsx(se,{limit:n,title:"none",limitValues:$,itemId:c,hideDescription:!0,hideReset:!0}):null,p?e.jsxs("span",{className:E.spellLevel,children:["(uses ",p," charges)"]}):null,t&&t.length>0||n?e.jsx(q,{content:"No more spellslots",disabled:!w,children:e.jsx("div",{className:`button-wrapper enabled ${x!=null&&x.disableDiceRoller?"calculated":"three-d-dice"}`,children:s.is_attack&&d?e.jsx(e.Fragment,{children:e.jsx(P,{dice:`1d20+${d}`,text:`+${d}&nbspattack`,context:`${T.capitalize(s.name)}: Attack`,statblock:a,stats:i,onRoll:async()=>{c&&$&&await ee(c,$,p)},limitReached:w,proficiencyBonus:g.statblock.proficiency_bonus})}):e.jsx("button",{className:`dice-button button ${w?"limit":""}`,onClick:async()=>{c&&$&&await ee(c,$,p),await js(`${s.name}: Cast`,j,a)},children:"cast"})})}):null]}),s.dc?e.jsxs("span",{className:E.spellDamage,children:["DC: ",s.dc,e.jsx(P,{dice:"1d20",text:`DC ${o}`,context:`${T.capitalize(s.name)}: Attack`,stats:i,proficiencyBonus:g.statblock.proficiency_bonus})]}):null,v?e.jsxs("span",{className:E.spellDamage,children:["Damage:"," ",e.jsx(P,{dice:v,text:v,context:`${T.capitalize(s.name)}: Damage`,stats:i,statblock:a,limitReached:w,damageDie:!0,proficiencyBonus:g.statblock.proficiency_bonus})]}):null,e.jsxs("div",{className:E.spellComponents,children:[s.verbal?"V":null,s.somatic?"S":null,e.jsxs("span",{className:"spell-materials",children:[s.material?"M":null,e.jsx("span",{className:E.materialDetails,children:s.materials?` (${s.materials})`:null})]})]})]}),e.jsx("button",{className:`expand ${r?"open":null}`,onClick:()=>u(!r)})]}),e.jsx("div",{className:`${E.spellMoreInfo} ${r?E.open:null}`,children:e.jsxs("div",{className:`${E.moreInfoContent} ${r?E.micOpen:null}`,children:[e.jsxs("div",{className:E.infoBits,children:[s.school.name?e.jsxs("span",{children:[e.jsx("b",{children:"School"}),": ",s.school.name]}):null,s.archetypes&&s.archetypes.length>0?e.jsxs("span",{children:[e.jsx("b",{children:"Archetypes"}),": ",s.archetypes.map(A=>A.name).join(", ")]}):null,s.circles&&s.circles.length>0?e.jsxs("span",{children:[e.jsx("b",{children:"Circles"}),": ",s.circles.map(A=>A.name).join(", ")]}):null,s.classes&&s.classes.length>0?e.jsxs("span",{children:[e.jsx("b",{children:"Classes"}),": ",s.classes.map(A=>A.name).join(", ")]}):null,e.jsxs("span",{children:[e.jsx("b",{children:"Casting Time"}),": ",s.casting_time]}),e.jsxs("span",{children:[e.jsx("b",{children:"Range"}),": ",s.range]}),e.jsxs("span",{children:[e.jsx("b",{children:"Can be Ritual"}),": ",s.ritual?"Yes":"No"]}),e.jsxs("span",{children:[e.jsx("b",{children:"Duration"}),": ",s.duration]}),e.jsxs("span",{children:[e.jsx("b",{children:"Concentration"}),": ",s.concentration?"Yes":"No"]})]}),e.jsxs("div",{children:[e.jsx("b",{children:"Description"}),":",e.jsx(W,{text:s.desc||"",context:`${T.capitalize(s.name)}`,stats:i,statblock:a,onRoll:async()=>{c&&$&&await ee(c,$)},limitReached:w,proficiencyBonus:g.statblock.proficiency_bonus})]}),s.higher_level?e.jsxs("div",{children:[e.jsx("b",{children:"Higher Levels"}),":"," ",e.jsx(W,{text:s.higher_level,stats:i,context:`${T.capitalize(s.name)}: Higher Level`,statblock:a,proficiencyBonus:g.statblock.proficiency_bonus})]}):null]})})]})},cn=()=>{var r,u,g,x;const[s,a]=y.useState([]),{stats:i,data:t,item:n,tokenName:p,statblock:l,equipmentBonuses:c}=B(),o=l.spells||[],d=c.statblockBonuses.spells.flatMap(j=>({item:j.itemId,spells:j.spells.map(h=>({spell:h.spell,charges:h.charges}))})),f=["All"].concat(o.map(j=>j.level===0?"Cant":j.level===1?"1st":j.level===2?"2nd":j.level===3?"3rd":`${j.level}th`)).concat(d.flatMap(j=>j.spells.map(h=>h.spell.level===0?"Cant":h.spell.level===1?"1st":h.spell.level===2?"2nd":h.spell.level===3?"3rd":`${h.spell.level}th`))).filter((j,h,v)=>v.indexOf(j)===h).sort((j,h)=>j==="All"?-1:h==="All"?1:j==="Cant"?-1:h==="Cant"?1:parseInt(j)-parseInt(h));return e.jsxs("div",{className:"spells",children:[e.jsx("div",{className:E.top,children:e.jsx("h3",{className:E.heading,children:"Spells"})}),e.jsx(J,{}),e.jsxs("div",{className:E.sticky,children:[e.jsx(ss,{filters:f,spellFilter:s,setSpellFilter:a}),e.jsxs("div",{className:E.info,children:[l.spell_dc?e.jsxs("span",{children:["DC ",l.spell_dc]}):null,l.spell_attack?e.jsxs("span",{className:E.spellAttack,children:["Attack"," ",e.jsx(P,{dice:`d20+${l.spell_attack}`,text:`+${l.spell_attack}`,context:"Spell Attack",stats:i,proficiencyBonus:l.proficiency_bonus})]}):null]}),e.jsx(ln,{})]}),e.jsxs("ul",{className:E.spellList,children:[e.jsx("li",{children:e.jsx(R,{})}),o.sort((j,h)=>j.level-h.level).filter(j=>s.indexOf(j.level)>=0||s.length===0).map((j,h)=>e.jsxs("li",{children:[e.jsx(Ne,{spell:j,statblock:p,stats:i,spellSlots:l.spell_slots,tokenData:t,itemId:n.id,dc:l.spell_dc,attack:l.spell_attack}),e.jsx(R,{})]},`${j.name}${h}`)),(u=(r=l.equipment)==null?void 0:r.filter(j=>j.embedded&&oe(t,j)))==null?void 0:u.map(j=>d.filter(h=>h.item===j.item.id).map(h=>h.spells.filter(v=>s.indexOf(v.spell.level)>=0||s.length===0).sort((v,b)=>v.spell.level-b.spell.level).map((v,b)=>e.jsxs("li",{children:[e.jsx(Ne,{spell:v.spell,statblock:p,stats:i,spellSlots:l.spell_slots,charges:j.item.charges,chargesUsed:v.charges,tokenData:t,itemId:n.id,dc:l.spell_dc,attack:l.spell_attack,embedded:!0}),e.jsx(R,{})]},`${v.spell.name}${b}`)))),(x=(g=l.equipment)==null?void 0:g.filter(j=>!j.embedded&&oe(t,j)))==null?void 0:x.map(j=>d.filter(h=>h.item===j.item.id).map((h,v)=>h.spells.length?e.jsxs("li",{children:[e.jsx("h4",{className:E.heading,children:j.item.name}),e.jsx($e,{equippedItem:j.item}),e.jsx(J,{}),h.spells.filter(b=>s.indexOf(b.spell.level)>=0||s.length===0).sort((b,$)=>b.spell.level-$.spell.level).map((b,$)=>e.jsxs("div",{children:[e.jsx(Ne,{spell:b.spell,statblock:p,stats:i,tokenData:t,charges:j.item.charges,chargesUsed:b.charges,itemId:n.id,dc:l.spell_dc,attack:l.spell_attack}),e.jsx(R,{})]},`${b.spell.name}${$}`))]},v):null))]})]})},rn="_heading_1x8jz_1",on="_items_1x8jz_7",dn="_top_1x8jz_14",un="_itemName_1x8jz_21",mn="_info_1x8jz_28",hn="_cost_1x8jz_34",xn="_gp_1x8jz_41",pn="_cp_1x8jz_45",fn="_sp_1x8jz_49",jn="_ep_1x8jz_53",gn="_pp_1x8jz_57",vn="_equipmentOptions_1x8jz_61",K={heading:rn,items:on,top:dn,itemName:un,info:mn,cost:hn,gp:xn,cp:pn,sp:fn,ep:jn,pp:gn,equipmentOptions:vn},ts=qe()(ze(s=>({filter:{filter:{consumable:!1,isEquipped:!1,isAttuned:!1,search:""},sort:"name"},setFilter:a=>s(()=>({filter:a}))}),{name:`${Ce}.inventory-filter`,storage:Pe(()=>localStorage)})),bn=()=>{const[s,a]=ts(O(i=>[i.filter,i.setFilter]));return e.jsxs("div",{style:{display:"flex",gap:"10px",paddingBlock:"6px"},className:M.sticky,children:[e.jsxs("label",{children:["Sort:",e.jsxs("select",{value:s.sort,onChange:i=>{a({...s,sort:i.currentTarget.value})},children:[e.jsx("option",{children:"name"}),e.jsx("option",{children:"cost"}),e.jsx("option",{children:"equipped"}),e.jsx("option",{children:"attuned"})]})]}),e.jsxs("div",{className:`${M.spellFilters} ${M.left}`,style:{alignItems:"center"},children:[e.jsx(q,{content:"is equipped",children:e.jsx("button",{className:`button ${M.spellFilter} ${s.filter.isEquipped?M.active:null}`,onClick:()=>{a({...s,filter:{...s.filter,isEquipped:!s.filter.isEquipped}})},children:"equ"})}),e.jsx(q,{content:"is attuned",children:e.jsx("button",{className:`button ${M.spellFilter} ${s.filter.isAttuned?M.active:null}`,onClick:()=>{a({...s,filter:{...s.filter,isAttuned:!s.filter.isAttuned}})},children:"att"})}),e.jsx(q,{content:"can be consumed",children:e.jsx("button",{className:`button ${M.spellFilter} ${s.filter.consumable?M.active:null}`,onClick:()=>{a({...s,filter:{...s.filter,consumable:!s.filter.consumable}})},children:"con"})}),e.jsx(q,{content:"search",children:e.jsx("input",{style:{width:"40px",height:"20px",flexGrow:1},type:"text",value:s.filter.search,onChange:i=>{a({...s,filter:{...s.filter,search:i.target.value}})}})})]})]})},Nn=({equipment:s})=>{const{statblock:a,stats:i,data:t,item:n}=B();return e.jsxs("li",{children:[e.jsxs("div",{className:K.top,children:[e.jsxs("span",{className:K.info,children:[e.jsxs("h4",{className:K.itemName,children:[s.count?`${s.count}x `:null,s.item.name]}),e.jsxs("span",{children:[s.item.consumable?e.jsx(q,{content:"Can be consumed",children:e.jsx("i",{children:"C"})}):null,s.proficient?e.jsx(q,{content:"proficient",children:e.jsx("i",{children:"P"})}):null,s.loot?e.jsx(q,{content:"loot",children:e.jsx("i",{children:"L"})}):null,s.item.sentient?e.jsx(q,{content:"sentient",children:e.jsx("i",{children:"S"})}):null]})]}),e.jsx("div",{className:K.cost,children:s.item.cost?e.jsx(e.Fragment,{children:Object.entries(s.item.cost).map(([p,l])=>p!=="id"&&l?e.jsxs("span",{className:K[p],children:[l,p]},p):null)}):null})]}),e.jsxs("span",{className:K.equipmentOptions,children:[s.item.can_equip?e.jsxs("label",{"aria-label":"equipped",children:["equipped:",e.jsx("input",{type:"checkbox",checked:gs(t,s),onChange:async p=>{var o,d;const l=[...((o=t.equipment)==null?void 0:o.equipped)||[]],c=[...((d=t.equipment)==null?void 0:d.attuned)||[]];p.target.checked?l.push(s.item.slug):l.splice(l.findIndex(f=>f===s.item.slug),1),await Ee(t,l,c,a,n)}})]}):null,s.item.requires_attuning?e.jsxs("label",{"aria-label":"attuned",children:["attuned:",e.jsx("input",{type:"checkbox",checked:vs(t,s),onChange:async p=>{var o,d;const l=[...((o=t.equipment)==null?void 0:o.equipped)||[]],c=[...((d=t.equipment)==null?void 0:d.attuned)||[]];p.target.checked?c.push(s.item.slug):c.splice(c.findIndex(f=>f===s.item.slug),1),await Ee(t,l,c,a,n)}})]}):null]}),e.jsx($e,{equippedItem:s.item}),e.jsx(pe,{slug:s.item.name,statblock:a,stats:i,about:s.item.description,context:s.item.name}),e.jsx(R,{})]},s.id)},yn=()=>{var n,p;const{statblock:s}=B(),a=ts(l=>l.filter),i=(l,c)=>{var o,d,f,r,u,g,x,j,h,v;if(a.sort==="name")return l.item.name.localeCompare(c.item.name);if(a.sort==="cost"){const b=(((o=l.item.cost)==null?void 0:o.cp)||0)+10*(((d=l.item.cost)==null?void 0:d.sp)||0)+50*(((f=l.item.cost)==null?void 0:f.ep)||0)+100*(((r=l.item.cost)==null?void 0:r.gp)||0)+1e3*(((u=l.item.cost)==null?void 0:u.pp)||0),w=(((g=c.item.cost)==null?void 0:g.cp)||0)+10*(((x=c.item.cost)==null?void 0:x.sp)||0)+50*(((j=c.item.cost)==null?void 0:j.ep)||0)+100*(((h=c.item.cost)==null?void 0:h.gp)||0)+1e3*(((v=c.item.cost)==null?void 0:v.pp)||0)-b;return w===0?l.item.name.localeCompare(c.item.name):w}else{if(a.sort==="equipped")return l.equipped&&c.equipped||!l.equipped&&!c.equipped?l.item.can_equip&&c.item.can_equip||!l.item.can_equip&&!c.item.can_equip?l.item.name.localeCompare(c.item.name):l.item.can_equip&&!c.item.can_equip?-1:1:l.equipped&&!c.equipped?-1:1;if(a.sort==="attuned")return l.attuned&&c.attuned||!l.attuned&&!c.attuned?l.item.requires_attuning&&c.item.requires_attuning||!l.item.requires_attuning&&!c.item.requires_attuning?l.item.name.localeCompare(c.item.name):l.item.requires_attuning&&!c.item.requires_attuning?-1:1:l.attuned&&!c.attuned?-1:1}return 0},t=l=>!l.embedded&&(!a.filter.consumable||l.item.consumable)&&(!a.filter.isEquipped||l.equipped)&&(!a.filter.isAttuned||l.attuned)&&(a.filter.search===""||l.item.name.toLowerCase().includes(a.filter.search.toLowerCase()));return e.jsxs("div",{children:[e.jsx("h3",{className:K.heading,children:"Inventory"}),e.jsx(J,{}),e.jsx(bn,{}),e.jsx("ul",{className:K.items,children:(n=s.equipment)==null?void 0:n.filter(t).sort(i).map((l,c)=>e.jsx(Nn,{equipment:l},c))}),e.jsx("h3",{className:K.heading,children:"Other"}),e.jsx(J,{}),e.jsx("div",{children:(p=s.items)==null?void 0:p.join(", ")})]})},_n=()=>{const{statblock:s,item:a}=B(),{activeTab:i,setActiveTab:t}=fe(),n=a.id in i?i[a.id]:"general",p=y.useMemo(()=>{var o,d,f,r,u,g,x,j,h,v,b,$;const c=["general","skills"];return((o=s.actions)!=null&&o.length||(d=s.bonus_actions)!=null&&d.length||(f=s.mythic_actions)!=null&&f.length||(r=s.reactions)!=null&&r.length||(u=s.equipment)!=null&&u.some(w=>{var D,A,m,k,N,S;return((A=(D=w.item.bonus)==null?void 0:D.actions)==null?void 0:A.length)||((k=(m=w.item.bonus)==null?void 0:m.bonus_actions)==null?void 0:k.length)||((S=(N=w.item.bonus)==null?void 0:N.reactions)==null?void 0:S.length)}))&&c.push("actions"),((g=s.items)!=null&&g.length||(x=s.equipment)!=null&&x.length)&&c.push("inventory"),((j=s.spells)!=null&&j.length||(h=s.equipment)!=null&&h.some(w=>{var D;return(D=w.item.spells)==null?void 0:D.length}))&&c.push("spells"),((v=s.special_abilities)!=null&&v.length||(b=s.equipment)!=null&&b.some(w=>{var D,A;return(A=(D=w.item.bonus)==null?void 0:D.special_abilities)==null?void 0:A.length}))&&c.push("special"),($=s.legendary_actions)!=null&&$.length&&c.push("legendary"),c},[s]),l=y.useMemo(()=>n==="general"?e.jsx(xt,{}):n==="skills"?e.jsx(vt,{}):n==="actions"?e.jsx(Dt,{}):n==="inventory"?e.jsx(yn,{}):n==="spells"?e.jsx(cn,{}):n==="special"?e.jsx(X,{heading:"Specials & Traits",abilities:s.special_abilities,abilityKey:"special_abilities"}):n==="legendary"?e.jsx(X,{heading:"Legendary Actions",abilities:s.legendary_actions,abilityKey:"legendary_actions"}):e.jsx(e.Fragment,{}),[n,s]);return e.jsxs("div",{className:Y.wrapper,children:[e.jsx("ul",{className:Y.tabs,children:p.map((c,o)=>e.jsx("li",{className:n===c?`${Y.tab} ${Y.activeTab}`:Y.tab,onClick:()=>t(a.id,c),children:c},o))}),e.jsx("div",{className:Y.content,children:l})]})},Sn=({proxyUrl:s,onClose:a,onSelectItem:i})=>{const[t,n]=y.useState(""),[p,l]=y.useState([]),[c,o]=y.useState(!1),[d,f]=y.useState(null);y.useEffect(()=>{const g=setTimeout(()=>{t.trim()?r(t):l([])},300);return()=>clearTimeout(g)},[t]);const r=async g=>{o(!0),f(null);try{const x=`${s}/e5/item/search/?search_string=${encodeURIComponent(g)}&take=200&skip=0`;console.log("🔍 Searching items:",x);const j=await fetch(x);if(!j.ok)throw new Error(`Search failed: ${j.status}`);const h=await j.json();l(h||[]),console.log("✅ Found items:",(h==null?void 0:h.length)||0)}catch(x){f(`Search failed: ${x instanceof Error?x.message:String(x)}`),console.error("❌ Search error:",x)}finally{o(!1)}},u=g=>{i(g),a()};return e.jsx("div",{className:"item-search-overlay",children:e.jsxs("div",{className:"item-search-modal",children:[e.jsxs("div",{className:"item-search-header",children:[e.jsx("h3",{children:"🔍 Search Items"}),e.jsx("button",{className:"close-btn",onClick:a,"aria-label":"Close search",children:"✕"})]}),e.jsxs("div",{className:"item-search-content",children:[e.jsxs("div",{className:"search-box",children:[e.jsx("input",{type:"text",placeholder:"Search for items...",value:t,onChange:g=>n(g.target.value),className:"search-input",autoFocus:!0}),c&&e.jsx("div",{className:"search-loading",children:"⏳"})]}),d&&e.jsxs("div",{className:"search-error",children:["⚠️ ",d]}),e.jsxs("div",{className:"items-list",children:[p.length===0&&t&&!c&&e.jsxs("div",{className:"no-results",children:['No items found for "',t,'"']}),p.map(g=>e.jsxs("div",{className:"item-row",onClick:()=>u(g),children:[e.jsxs("div",{className:"item-info",children:[e.jsx("div",{className:"item-name",children:g.name}),g.type&&e.jsx("div",{className:"item-type",children:g.type}),g.rarity&&e.jsx("div",{className:"item-rarity",children:g.rarity})]}),e.jsxs("div",{className:"item-id",children:["ID: ",g.id]})]},g.id))]})]}),e.jsx("div",{className:"item-search-footer",children:e.jsx("button",{className:"cancel-btn",onClick:a,children:"Cancel"})})]})})},kn=({proxyUrl:s,onClose:a,onSelectSpell:i})=>{const[t,n]=y.useState(""),[p,l]=y.useState([]),[c,o]=y.useState(!1),[d,f]=y.useState(null);y.useEffect(()=>{const x=setTimeout(()=>{t.trim()?r(t):l([])},300);return()=>clearTimeout(x)},[t]);const r=async x=>{o(!0),f(null);try{const j=`${s}/e5/spell/search/?search_string=${encodeURIComponent(x)}&take=200&skip=0`;console.log("🔍 Searching spells:",j);const h=await fetch(j);if(!h.ok)throw new Error(`Search failed: ${h.status}`);const v=await h.json();l(v||[]),console.log("✅ Found spells:",(v==null?void 0:v.length)||0)}catch(j){f(`Search failed: ${j instanceof Error?j.message:String(j)}`),console.error("❌ Search error:",j)}finally{o(!1)}},u=x=>{i(x),a()},g=x=>x===0?"Cantrip":x===1?"1st level":x===2?"2nd level":x===3?"3rd level":`${x}th level`;return e.jsx("div",{className:"spell-search-overlay",children:e.jsxs("div",{className:"spell-search-modal",children:[e.jsxs("div",{className:"spell-search-header",children:[e.jsx("h3",{children:"🪄 Search Spells"}),e.jsx("button",{className:"close-btn",onClick:a,"aria-label":"Close search",children:"✕"})]}),e.jsxs("div",{className:"spell-search-content",children:[e.jsxs("div",{className:"search-box",children:[e.jsx("input",{type:"text",placeholder:"Search for spells...",value:t,onChange:x=>n(x.target.value),className:"search-input",autoFocus:!0}),c&&e.jsx("div",{className:"search-loading",children:"⏳"})]}),d&&e.jsxs("div",{className:"search-error",children:["⚠️ ",d]}),e.jsxs("div",{className:"spells-list",children:[p.length===0&&t&&!c&&e.jsxs("div",{className:"no-results",children:['No spells found for "',t,'"']}),p.map(x=>{var j;return e.jsxs("div",{className:"spell-row",onClick:()=>u(x),children:[e.jsxs("div",{className:"spell-info",children:[e.jsx("div",{className:"spell-name",children:x.name}),e.jsxs("div",{className:"spell-details",children:[x.level!==void 0&&e.jsx("span",{className:"spell-level",children:g(x.level)}),((j=x.school)==null?void 0:j.name)&&e.jsx("span",{className:"spell-school",children:x.school.name}),x.classes&&x.classes.length>0&&e.jsx("span",{className:"spell-classes",children:x.classes.map(h=>h.name).join(", ")})]}),e.jsxs("div",{className:"spell-extra-info",children:[x.range&&e.jsxs("span",{className:"spell-range",children:["Range: ",x.range]}),x.casting_time&&e.jsxs("span",{className:"spell-casting-time",children:["Cast: ",x.casting_time]}),x.duration&&e.jsxs("span",{className:"spell-duration",children:["Duration: ",x.duration]})]})]}),e.jsxs("div",{className:"spell-id",children:["ID: ",x.id]})]},x.id)})]})]}),e.jsx("div",{className:"spell-search-footer",children:e.jsx("button",{className:"cancel-btn",onClick:a,children:"Cancel"})})]})})},wn=({jsonData:s,onChange:a,disabled:i=!1})=>{var A;const[t,n]=y.useState(s||{}),[p]=y.useState(s||{}),[l,c]=y.useState(Array.isArray(s==null?void 0:s.languages)?s.languages.join(", "):(s==null?void 0:s.languages)||"");y.useEffect(()=>{c(Array.isArray(t.languages)?t.languages.join(", "):t.languages||"")},[t.languages]);const[o,d]=y.useState(()=>{if(typeof(s==null?void 0:s.items)=="string")return s.items;if(Array.isArray(s==null?void 0:s.items))return s.items.join(", ");if(s!=null&&s.equipment){if(typeof s.equipment=="string")return s.equipment;if(Array.isArray(s.equipment))return s.equipment.join(", ")}return""});y.useEffect(()=>{typeof t.items=="string"?d(t.items):Array.isArray(t.items)?d(t.items.join(", ")):t.equipment?typeof t.equipment=="string"?d(t.equipment):Array.isArray(t.equipment)&&d(t.equipment.join(", ")):d("")},[t.items,t.equipment]);const[f,r]=y.useState(()=>{var m;return t.hit_dice?t.hit_dice:(m=t.hp)!=null&&m.hit_dice?t.hp.hit_dice:t.hit_die?t.hit_die:""});y.useEffect(()=>{var m;t.hit_dice?r(t.hit_dice):(m=t.hp)!=null&&m.hit_dice?r(t.hp.hit_dice):t.hit_die?r(t.hit_die):r("")},[t.hit_dice,(A=t.hp)==null?void 0:A.hit_dice,t.hit_die]);const[u,g]=y.useState(()=>{var m;return typeof t.speed=="string"?t.speed:(m=t.speed)!=null&&m.walk?t.speed.walk:"1"});y.useEffect(()=>{var m;typeof t.speed=="string"?g(t.speed):(m=t.speed)!=null&&m.walk?g(t.speed.walk):g("1")},[t.speed]);const x=(m,k)=>{console.log("Updating field:",m,"to:",k);const N=JSON.parse(JSON.stringify(t)),S=m.split(".");let _=N;const C=["damage_vulnerabilities","damage_resistances","damage_immunities","condition_immunities"],F=["languages","senses","items","equipment"];if(["strength","dexterity","constitution","intelligence","wisdom","charisma"].includes(m)){const I=m;t.stats&&t.stats[I]!==void 0?(N.stats||(N.stats={}),N.stats[I]=parseInt(k)||10):t.ability_scores&&t.ability_scores[I]!==void 0?(N.ability_scores||(N.ability_scores={}),N.ability_scores[I]=parseInt(k)||10):t[I]!==void 0?N[I]=parseInt(k)||10:(N.stats||(N.stats={}),N.stats[I]=parseInt(k)||10)}else if(F.includes(m))Array.isArray(k)?N[m]=k:typeof k=="string"?N[m]=k?k.split(",").map(I=>I.trim()).filter(I=>I):[]:N[m]=[];else if(C.includes(m))Array.isArray(k)?N[m]=k.join(", "):typeof k=="string"?N[m]=k:N[m]="";else{for(let H=0;H<S.length-1;H++)_[S[H]]||(p[S[H]]?_[S[H]]=JSON.parse(JSON.stringify(p[S[H]])):_[S[H]]={}),_=_[S[H]];const I=S[S.length-1];_[I]=k}try{n(N),a(N),console.log("Successfully updated field:",m,"New data:",N)}catch(I){console.error("Error updating field:",m,I);return}},j=m=>{var k,N;return((k=t.stats)==null?void 0:k[m])!==void 0?t.stats[m]:((N=t.ability_scores)==null?void 0:N[m])!==void 0?t.ability_scores[m]:t[m]!==void 0?t[m]:10},h=()=>e.jsxs("div",{className:"form-section",children:[e.jsx("h3",{className:"form-section-title",children:"📋 Basic Information"}),e.jsxs("div",{className:"form-grid",children:[e.jsxs("div",{className:"form-field",children:[e.jsx("label",{className:"form-label",children:"Name"}),e.jsx("input",{type:"text",className:"form-input",value:t.name||"",onChange:m=>x("name",m.target.value),disabled:i})]}),e.jsxs("div",{className:"form-field",children:[e.jsx("label",{className:"form-label",children:"Size"}),e.jsxs("select",{className:"form-select",value:t.size||"",onChange:m=>x("size",m.target.value),disabled:i,children:[e.jsx("option",{value:"",children:"Select size"}),e.jsx("option",{value:"Tiny",children:"Tiny"}),e.jsx("option",{value:"Small",children:"Small"}),e.jsx("option",{value:"Medium",children:"Medium"}),e.jsx("option",{value:"Large",children:"Large"}),e.jsx("option",{value:"Huge",children:"Huge"}),e.jsx("option",{value:"Gargantuan",children:"Gargantuan"})]})]}),e.jsxs("div",{className:"form-field",children:[e.jsx("label",{className:"form-label",children:"Type"}),e.jsx("input",{type:"text",className:"form-input",value:t.type||"",onChange:m=>x("type",m.target.value),disabled:i})]}),e.jsxs("div",{className:"form-field",children:[e.jsx("label",{className:"form-label",children:"Alignment"}),e.jsx("input",{type:"text",className:"form-input",value:t.alignment||"",onChange:m=>x("alignment",m.target.value),disabled:i})]}),e.jsxs("div",{className:"form-field",children:[e.jsx("label",{className:"form-label",children:"Challenge Rating"}),e.jsx("input",{type:"text",className:"form-input",value:t.challenge_rating||t.cr||"",onChange:m=>x("challenge_rating",m.target.value),disabled:i,placeholder:"e.g., 1/4, 1, 5"})]}),e.jsxs("div",{className:"form-field",style:{gridColumn:"1 / -1"},children:[e.jsx("label",{className:"form-label",children:"About"}),e.jsx("textarea",{className:"form-textarea",value:t.about||"",onChange:m=>x("about",m.target.value),disabled:i,placeholder:"Description or background information about the character/creature",rows:3,style:{width:"100%",resize:"vertical"}})]}),e.jsxs("div",{className:"form-field",children:[e.jsx("label",{className:"form-label",children:"Languages"}),e.jsx("input",{type:"text",className:"form-input",value:l,onChange:m=>c(m.target.value),onBlur:()=>{const m=l?l.split(",").map(k=>k.trim()).filter(k=>k):[];x("languages",m)},onKeyDown:m=>{m.key==="Enter"&&m.currentTarget.blur()},disabled:i,placeholder:"e.g., Common, Draconic"}),e.jsx("small",{style:{color:"#9ca3af",fontSize:"0.75rem",marginTop:"0.25rem"},children:"Separate multiple languages with commas"})]})]})]}),v=()=>e.jsxs("div",{className:"form-section",children:[e.jsx("h3",{className:"form-section-title",children:"💪 Ability Scores"}),e.jsx("div",{className:"stats-grid",children:["strength","dexterity","constitution","intelligence","wisdom","charisma"].map(m=>{const k=j(m);return e.jsxs("div",{className:"stat-field",children:[e.jsx("label",{className:"form-label",children:m.charAt(0).toUpperCase()+m.slice(1)}),e.jsx("input",{type:"number",className:"form-input stat-input",value:k,onChange:N=>{const S=parseInt(N.target.value)||10;x(m,S),console.log(`Updated ${m} to:`,S)},disabled:i,min:1,max:30}),e.jsx("span",{className:"stat-modifier",children:k?`(${Math.floor((k-10)/2)>=0?"+":""}${Math.floor((k-10)/2)})`:"(+0)"})]},m)})})]}),b=()=>{var m;return t.hit_points?t.hit_points:(m=t.hp)!=null&&m.value?t.hp.value:t.hp&&typeof t.hp=="number"?t.hp:1},$=()=>e.jsxs("div",{className:"form-section",children:[e.jsx("h3",{className:"form-section-title",children:"⚔️ Combat Stats"}),e.jsxs("div",{className:"form-grid",children:[e.jsxs("div",{className:"form-field",children:[e.jsx("label",{className:"form-label",children:"Hit Points"}),e.jsx("input",{type:"number",className:"form-input",value:b(),onChange:m=>{const k=parseInt(m.target.value)||1;t.hp&&typeof t.hp=="object"?x("hp.value",k):x("hit_points",k),console.log("Updated HP to:",k)},disabled:i})]}),e.jsxs("div",{className:"form-field",children:[e.jsx("label",{className:"form-label",children:"Hit Dice"}),e.jsx("input",{type:"text",className:"form-input",value:f,onChange:m=>r(m.target.value),onBlur:()=>{t.hp&&typeof t.hp=="object"?x("hp.hit_dice",f):x("hit_dice",f)},onKeyDown:m=>{m.key==="Enter"&&m.currentTarget.blur()},disabled:i,placeholder:"e.g., 2d8+2"})]}),e.jsxs("div",{className:"form-field",children:[e.jsx("label",{className:"form-label",children:"Speed"}),e.jsx("input",{type:"text",className:"form-input",value:u,onChange:m=>g(m.target.value),onBlur:()=>{typeof t.speed=="object"&&t.speed!==null?x("speed.walk",u):x("speed",u)},onKeyDown:m=>{m.key==="Enter"&&m.currentTarget.blur()},disabled:i,placeholder:"e.g., 30 ft./9 m"})]}),e.jsxs("div",{className:"form-field",children:[e.jsx("label",{className:"form-label",children:"Proficiency Bonus"}),e.jsx("input",{type:"number",className:"form-input",value:t.proficiency_bonus||t.prof_bonus||2,onChange:m=>{const k=parseInt(m.target.value)||2;x("proficiency_bonus",k),console.log("Updated Proficiency Bonus to:",k)},disabled:i,min:2,max:6})]})]})]}),w=()=>e.jsxs("div",{className:"form-section",children:[e.jsx("h3",{className:"form-section-title",children:"🛡️ Resistances & Immunities"}),e.jsxs("div",{className:"form-grid",children:[e.jsxs("div",{className:"form-field",children:[e.jsx("label",{className:"form-label",children:"Damage Vulnerabilities"}),e.jsx("input",{type:"text",className:"form-input",value:Array.isArray(t.damage_vulnerabilities)?t.damage_vulnerabilities.join(", "):t.damage_vulnerabilities||"",onChange:m=>x("damage_vulnerabilities",m.target.value),disabled:i,placeholder:"e.g., Fire, Lightning"})]}),e.jsxs("div",{className:"form-field",children:[e.jsx("label",{className:"form-label",children:"Damage Resistances"}),e.jsx("input",{type:"text",className:"form-input",value:Array.isArray(t.damage_resistances)?t.damage_resistances.join(", "):t.damage_resistances||"",onChange:m=>x("damage_resistances",m.target.value),disabled:i,placeholder:"e.g., Fire, Cold"})]}),e.jsxs("div",{className:"form-field",children:[e.jsx("label",{className:"form-label",children:"Damage Immunities"}),e.jsx("input",{type:"text",className:"form-input",value:Array.isArray(t.damage_immunities)?t.damage_immunities.join(", "):t.damage_immunities||"",onChange:m=>x("damage_immunities",m.target.value),disabled:i,placeholder:"e.g., Poison, Necrotic"})]}),e.jsxs("div",{className:"form-field",children:[e.jsx("label",{className:"form-label",children:"Condition Immunities"}),e.jsx("input",{type:"text",className:"form-input",value:Array.isArray(t.condition_immunities)?t.condition_immunities.join(", "):t.condition_immunities||"",onChange:m=>x("condition_immunities",m.target.value),disabled:i,placeholder:"e.g., Charmed, Frightened"})]}),e.jsxs("div",{className:"form-field",children:[e.jsx("label",{className:"form-label",children:"Senses"}),e.jsx("input",{type:"text",className:"form-input",value:Array.isArray(t.senses)?t.senses.join(", "):t.senses||"",onChange:m=>x("senses",m.target.value),disabled:i,placeholder:"e.g., Darkvision 60 ft., passive Perception 12"})]})]})]}),D=()=>e.jsxs("div",{className:"form-section",children:[e.jsx("h3",{className:"form-section-title",children:"🎒 Equipment & Items"}),e.jsxs("div",{className:"form-field",children:[e.jsx("label",{className:"form-label",children:"Items"}),e.jsx("textarea",{className:"form-textarea",value:o,onChange:m=>d(m.target.value),onBlur:()=>{Array.isArray(t.items)?x("items",o.split(",").map(m=>m.trim()).filter(m=>m)):Array.isArray(t.equipment)?x("equipment",o.split(",").map(m=>m.trim()).filter(m=>m)):x("items",o)},onKeyDown:m=>{m.key==="Enter"&&!m.shiftKey&&(m.preventDefault(),m.currentTarget.blur())},disabled:i,placeholder:"Enter items separated by commas, e.g., Sword, Shield, Potion of Healing",rows:4}),e.jsx("small",{style:{color:"#9ca3af",fontSize:"0.75rem"},children:"Separate multiple items with commas. Format will be preserved based on original data structure."})]})]});return e.jsxs("div",{className:"json-form-editor",children:[h(),v(),$(),w(),D(),e.jsxs("div",{className:"form-section",children:[e.jsx("h3",{className:"form-section-title",children:"🎯 Additional Features"}),e.jsx("p",{className:"form-note",children:"For advanced editing (skills, actions, spells), switch to Raw mode or use the specialized buttons above."}),e.jsx("div",{className:"form-debug",children:e.jsxs("details",{children:[e.jsx("summary",{style:{color:"#9ca3af",cursor:"pointer"},children:"Debug: Show Raw Data"}),e.jsx("pre",{style:{background:"rgba(0,0,0,0.3)",padding:"1rem",borderRadius:"4px",fontSize:"0.75rem",overflow:"auto",maxHeight:"200px"},children:JSON.stringify(t,null,2)})]})})]})]})},Cn=({isOpen:s,onClose:a,slug:i,proxyUrl:t,onSave:n,title:p="Edit JSON"})=>{const[l,c]=y.useState(""),[o,d]=y.useState(null),[f,r]=y.useState(!0),[u,g]=y.useState(!1),[x,j]=y.useState(!1),[h,v]=y.useState(!1),[b,$]=y.useState("form");y.useEffect(()=>{s&&i&&t&&(async()=>{g(!0),d(null);try{const C=await fetch(`${t}/edit/statblock/${i}`);if(!C.ok)throw new Error(`Failed to fetch: ${C.status}`);const F=await C.json();c(JSON.stringify(F,null,2)),r(!0)}catch(C){d(`Failed to load JSON: ${C instanceof Error?C.message:String(C)}`),c(""),r(!1)}finally{g(!1)}})()},[s,i,t]);const w=_=>{const C=_.target.value;if(c(C),C.trim()===""){d(null),r(!1);return}try{JSON.parse(C),d(null),r(!0)}catch{d("Invalid JSON format"),r(!1)}},D=async()=>{if(!l.trim()){d("Cannot save empty data");return}if(!f){d("Cannot save invalid JSON");return}g(!0);try{const _=JSON.parse(l);typeof _.source=="string"&&!_.source.endsWith(" - NoTA")&&(_.source=_.source+" - NoTA"),typeof _.slug=="string"&&!_.slug.endsWith("-nota")&&(_.slug=_.slug+"-nota");const C=await fetch(`${t}/edit/statblock/${i}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(_,null,2)});if(!C.ok)throw new Error(`Save failed: ${C.status}`);n(_),a()}catch(_){d(`Save failed: ${_ instanceof Error?_.message:String(_)}`)}finally{g(!1)}},A=()=>{try{const _=JSON.parse(l);c(JSON.stringify(_,null,2)),d(null),r(!0)}catch{d("Cannot format invalid JSON")}},m=()=>{try{if(!l.trim())return!1;const _=JSON.parse(l);return Array.isArray(_.equipment)}catch{return!1}},k=()=>{try{if(!l.trim())return!1;const _=JSON.parse(l);return Array.isArray(_.spells)}catch{return!1}},N=_=>{try{if(!l.trim()){d("No JSON data available to modify");return}const C=JSON.parse(l);Array.isArray(C.spells)||(C.spells=[]),C.spells.includes(_.id)?console.log("⚠️ Spell già presente:",_.name):(C.spells.push(_.id),c(JSON.stringify(C,null,2)),console.log("✅ Spell aggiunto:",_.name)),v(!1)}catch(C){d("Failed to add spell to list"),console.error("❌ Errore aggiunta spell:",C)}},S=_=>{try{if(!l.trim()){d("No JSON data available to modify");return}const C=JSON.parse(l);Array.isArray(C.equipment)||(C.equipment=[]);const F={item:_.id,equipped:!1,proficient:!1,embedded:!1,loot:!1,attuned:!1,count:1};C.equipment.push(F),c(JSON.stringify(C,null,2)),j(!1),console.log("✅ Item aggiunto:",_.name)}catch(C){d("Failed to add item to equipment"),console.error("❌ Errore aggiunta item:",C)}};return s?e.jsx("div",{className:"json-editor-overlay",children:e.jsxs("div",{className:"json-editor-modal",children:[e.jsxs("div",{className:"json-editor-header",children:[e.jsx("h2",{className:"json-editor-title",children:p}),e.jsxs("div",{className:"json-editor-controls",children:[e.jsxs("div",{className:"view-toggle",children:[e.jsx("button",{className:`toggle-btn ${b==="form"?"active":""}`,onClick:()=>$("form"),disabled:!f||u,children:"📝 Form"}),e.jsx("button",{className:`toggle-btn ${b==="formatted"?"active":""}`,onClick:()=>$("formatted"),disabled:!f||u,children:"👁️ Preview"}),e.jsx("button",{className:`toggle-btn ${b==="raw"?"active":""}`,onClick:()=>$("raw"),disabled:u,children:"✏️ Raw"})]}),e.jsx("button",{className:"json-editor-close",onClick:a,"aria-label":"Close editor",disabled:u,children:"✕"})]})]}),e.jsxs("div",{className:"json-editor-toolbar",children:[e.jsxs("div",{className:"toolbar-left",children:[e.jsx("button",{className:"json-editor-btn json-editor-btn-secondary",onClick:A,disabled:!f||u,title:"Format and prettify JSON",children:"🎨 Format"}),m()&&e.jsx("button",{className:"json-editor-btn json-editor-btn-secondary",onClick:()=>j(!0),disabled:!f||u,title:"Add item to equipment",children:"➕ Add Item"}),k()&&e.jsx("button",{className:"json-editor-btn json-editor-btn-secondary",onClick:()=>v(!0),disabled:!f||u,title:"Add spell to spell list",children:"🪄 Add Spell"}),e.jsx("span",{className:"json-status",children:u?e.jsx("span",{className:"status-loading",children:"⏳ Loading..."}):f?e.jsx("span",{className:"status-valid",children:"✅ Valid JSON"}):e.jsx("span",{className:"status-invalid",children:"❌ Invalid JSON"})})]}),o&&e.jsxs("span",{className:"json-editor-error",children:["⚠️ ",o]})]}),x&&e.jsx(Sn,{proxyUrl:t,onClose:()=>j(!1),onSelectItem:S}),h&&e.jsx(kn,{proxyUrl:t,onClose:()=>v(!1),onSelectSpell:N}),e.jsx("div",{className:"json-editor-content",children:u?e.jsx("div",{className:"json-loading",children:e.jsx("div",{className:"loading-spinner",children:"⏳ Loading JSON from server..."})}):b==="form"&&f&&l.trim()?e.jsx(wn,{jsonData:(()=>{try{return JSON.parse(l)}catch{return{}}})(),onChange:_=>{const C=JSON.stringify(_,null,2);c(C),console.log("JsonEditor received update from FormEditor:",_),console.log("New JSON text:",C);try{JSON.parse(C),r(!0),d(null)}catch{d("Form generated invalid JSON"),r(!1)}},disabled:u}):b==="formatted"&&f&&l.trim()?e.jsx("div",{className:"json-viewer",children:e.jsx(ns,{data:(()=>{try{return JSON.parse(l)}catch{return{}}})()})}):l.trim()?e.jsx("div",{className:"json-raw-editor",children:e.jsx("textarea",{className:`json-editor-textarea ${f?"":"json-editor-textarea-error"}`,value:l,onChange:w,placeholder:"Loading JSON from server...",spellCheck:!1,disabled:u})}):e.jsx("div",{className:"json-empty-state",children:e.jsxs("div",{className:"empty-state-content",children:[e.jsx("div",{className:"empty-state-icon",children:"📄"}),e.jsx("h3",{children:"No Data Available"}),e.jsx("p",{children:"The JSON data could not be loaded from the server."}),e.jsx("button",{className:"json-editor-btn json-editor-btn-primary",onClick:()=>{i&&t&&(g(!0),d(null),fetch(`${t}/edit/statblock/${i}`).then(_=>{if(!_.ok)throw new Error(`Failed to fetch: ${_.status}`);return _.json()}).then(_=>{c(JSON.stringify(_,null,2)),r(!0)}).catch(_=>{d(`Failed to load JSON: ${_ instanceof Error?_.message:String(_)}`),c(""),r(!1)}).finally(()=>{g(!1)}))},disabled:u,children:"🔄 Retry Loading"})]})})}),e.jsxs("div",{className:"json-editor-footer",children:[e.jsxs("div",{className:"footer-info",children:[e.jsxs("span",{className:"char-count",children:[l.length," characters"]}),b==="formatted"&&e.jsx("span",{className:"view-hint",children:"💡 Switch to Edit mode to modify"})]}),e.jsxs("div",{className:"footer-buttons",children:[e.jsx("button",{className:"json-editor-btn json-editor-btn-secondary",onClick:a,disabled:u,children:"Cancel"}),e.jsx("button",{className:"json-editor-btn json-editor-btn-primary",onClick:D,disabled:!f||u,children:u?"⏳ Saving...":"💾 Save Changes"})]})]})]})}):null},ns=({data:s,level:a=0})=>{const[i,t]=y.useState({}),n=l=>{t(c=>({...c,[l]:!c[l]}))},p=(l,c,o)=>{const d=i[`${a}-${l}`];if(typeof c=="object"&&c!==null){const f=Array.isArray(c),r=f?c.length===0:Object.keys(c).length===0;return e.jsxs("div",{className:"json-tree-item",children:[e.jsxs("div",{className:"json-tree-key expandable",onClick:()=>n(`${a}-${l}`),children:[e.jsx("span",{className:"collapse-icon",children:r?"📄":d?"▶️":"🔽"}),e.jsxs("span",{className:"key-name",children:['"',l,'"']}),e.jsx("span",{className:"key-colon",children:":"}),e.jsx("span",{className:"value-preview",children:f?`Array(${c.length})`:"Object"})]}),!d&&!r&&e.jsx("div",{className:"json-tree-children",children:e.jsx(ns,{data:c,level:a+1})})]},o)}return e.jsxs("div",{className:"json-tree-item",children:[e.jsxs("span",{className:"json-tree-key",children:['"',l,'"']}),e.jsx("span",{className:"key-colon",children:":"}),e.jsx("span",{className:`json-value json-${typeof c}`,children:typeof c=="string"?`"${c}"`:String(c)})]},o)};return Array.isArray(s)?e.jsx("div",{className:"json-tree",children:s.map((l,c)=>p(String(c),l,c))}):e.jsx("div",{className:"json-tree",children:Object.entries(s).map(([l,c],o)=>p(l,c,o))})};async function $n(s,a,i){if(s.type!=="application/json")throw new Error("File needs to be a JSON.");if(!i)throw new Error("Proxy URL not configured. Please set it up in settings.");try{const t=await s.text(),n=JSON.parse(t);typeof n.source=="string"&&!n.source.endsWith(" - NoTA")&&(n.source=n.source+" - NoTA"),console.log("Original JSON:",a),n.slug=a,console.log("Uploading JSON file:",n);const p=await fetch(`${i}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}),l=await p.json();if(!p.ok)throw console.error("Server Error:",l),new Error(l.error||"Failed to upload JSON file.")}catch(t){throw console.error("Error uploading JSON file:",t),t}}const Tn=()=>{const{statblock:s}=B(),[a,i]=y.useState(!1),t=G(O(o=>o.room)),n=s==null?void 0:s.slug,p=Fe(t||void 0),l=Xe(n),c=async()=>{if(s)try{const o=Fe(t||void 0);if(!o||o==="https://nope"){console.log("Please configure your proxy URL in settings first.");return}const d=new Date,r=`${s.name}_${d.getFullYear()}${(d.getMonth()+1).toString().padStart(2,"0")}${d.getDate().toString().padStart(2,"0")}_${d.getHours().toString().padStart(2,"0")}${d.getMinutes().toString().padStart(2,"0")}${d.getSeconds().toString().padStart(2,"0")}`.replace(/[^a-zA-Z0-9_\-]/g,"_"),u=new Blob([JSON.stringify(s,null,2)],{type:"application/json"}),g=`${r}`,x=new File([u],"",{type:"application/json"});await $n(x,g,o),console.log(`Duplication complete! ${g}`),U.notification.show(`Statblock "${g}" duplicated successfully!`)}catch(o){console.log("Error: "+o.message)}};return e.jsxs("div",{className:Q.statblock,children:[e.jsxs("div",{className:Q.title,children:[e.jsxs("div",{children:[e.jsx(q,{content:`${s.size} ${s.type}, ${s.alignment}`,children:e.jsx("h1",{className:Q.name,children:s.name})}),e.jsxs("div",{className:Q.note,children:[s.size," ",s.type,", ",s.alignment]})]}),e.jsxs("div",{className:Q.headerActions,children:[e.jsx(Ps,{}),e.jsx("button",{className:"edit-json-btn",onClick:()=>i(!0),title:"Edit statblock JSON",children:"⚙️"}),e.jsx("button",{className:"edit-json-btn",onClick:c,title:"Duplicate statblock JSON",children:"📋"})]})]}),e.jsx(_n,{}),e.jsx(Cn,{isOpen:a,onClose:()=>i(!1),slug:n||"",proxyUrl:p||"",onSave:o=>{i(!1),l.refetch(),U.notification.show("Statblock updated successfully!"),console.log("Statblock updated:",o)},title:"Edit Statblock JSON"})]})},Dn=({slug:s,itemId:a})=>{const i=Xe(s),t=i.isSuccess&&i.data?i.data:null;return t?e.jsx(Es,{itemId:a,statblock:t,children:e.jsx(Tn,{})}):e.jsx(ie,{})},is=y.createContext(null),Z=()=>{const s=y.useContext(is);if(s===null)throw new Error("PFStatblockContext is not set");return s},An=s=>{const a=we(O(i=>{var t;return(t=i.tokens)==null?void 0:t.get(s.itemId)}));if(a){const i=a.data,t=a.item;return e.jsx(is.Provider,{value:{tokenName:Ie(t),data:i,item:t,statblock:s.statblock,stats:{strength:s.statblock.stats.strength||0,dexterity:s.statblock.stats.dexterity||0,constitution:s.statblock.stats.constitution||0,wisdom:s.statblock.stats.wisdom||0,intelligence:s.statblock.stats.intelligence||0,charisma:s.statblock.stats.charisma||0}},children:s.children})}return e.jsx(ie,{})},En="_values_15mtq_1",Fn={values:En},Rn=()=>{const{item:s}=Z();return e.jsxs("div",{className:Fn.values,children:[e.jsx(Ue,{id:s.id}),e.jsx(Ge,{id:s.id})]})},On="_general_1mcsm_1",In="_stats_1mcsm_5",Ln="_heading_1mcsm_12",qn="_savingThrows_1mcsm_18",zn="_stat_1mcsm_5",Pn="_traits_1mcsm_37",Bn="_trait_1mcsm_37",Mn="_name_1mcsm_47",Jn="_value_1mcsm_60",Hn="_header_1mcsm_76",Vn="_infos_1mcsm_84",Kn="_ac_1mcsm_91",z={general:On,stats:In,heading:Ln,savingThrows:qn,stat:zn,traits:Pn,trait:Bn,name:Mn,value:Jn,header:Hn,infos:Vn,ac:Kn},Wn=["strength","dexterity","constitution","intelligence","wisdom","charisma"],Qn=["reflex","will","fortitude"],Un=()=>{var n,p,l,c,o,d,f,r,u,g,x,j;const{statblock:s,stats:a,tokenName:i,item:t}=Z();return e.jsxs("div",{className:z.general,children:[e.jsxs("div",{className:z.ac,children:[e.jsx("b",{children:"Armor Class:"})," ",e.jsx(Ze,{id:t.id,hideExtras:!0}),s.armor_class.special?e.jsxs("span",{children:["(",s.armor_class.special,")"]}):null]}),e.jsxs("div",{children:[e.jsx("b",{children:"Speed:"}),` ${s.speed}`]}),e.jsx(R,{}),e.jsxs("ul",{className:z.stats,children:[e.jsxs("li",{className:z.header,children:[e.jsx("div",{}),e.jsx("div",{children:"Check"})]}),Wn.map(h=>{const v=a[h];return e.jsxs("li",{className:z.stat,children:[e.jsx("div",{className:z.name,children:e.jsx("span",{children:h.substring(0,3)})}),e.jsx("div",{className:z.value,children:e.jsx(P,{dice:`d20+${v}`,text:`+${v}`,stats:a,context:`${T.capitalize(h)}: Check`,statblock:i})})]},h)})]}),e.jsx(R,{}),e.jsxs("ul",{className:z.savingThrows,children:[e.jsxs("li",{className:z.header,children:[e.jsx("div",{}),e.jsx("div",{children:"Save"})]}),Qn.map(h=>{const v=s.saving_throws[h];return e.jsxs("li",{className:z.stat,children:[e.jsx("div",{className:z.name,children:e.jsx("span",{children:h.substring(0,3)})}),e.jsx("div",{className:z.value,children:e.jsx(P,{dice:`d20+${v}`,text:`+${v}`,stats:a,context:`${T.capitalize(h)}: Save`,statblock:i})})]},h)})]}),s.saving_throws.special?e.jsx("i",{children:s.saving_throws.special}):null,e.jsx(R,{}),(n=s.senses)!=null&&n.length||(p=s.languages)!=null&&p.length||(l=s.immunities)!=null&&l.length||(c=s.weaknesses)!=null&&c.length||(o=s.resistances)!=null&&o.length?e.jsxs(e.Fragment,{children:[e.jsxs("ul",{className:z.infos,children:[(d=s.senses)!=null&&d.length?e.jsxs("li",{children:[e.jsx("b",{children:"Senses:"})," ",(s.senses||[]).join(", ")]}):null,(f=s.languages)!=null&&f.length?e.jsxs("li",{children:[e.jsx("b",{children:"Languages:"})," ",(r=s.languages)==null?void 0:r.join(", ")]}):null,(u=s.immunities)!=null&&u.length?e.jsxs("li",{children:[e.jsx("b",{children:"Immunities:"})," ",s.immunities.join(", ")]}):null,(g=s.weaknesses)!=null&&g.length?e.jsxs("li",{children:[e.jsx("b",{children:"Weaknesses:"})," ",s.weaknesses.join(", ")]}):null,(x=s.resistances)!=null&&x.length?e.jsxs("li",{children:[e.jsx("b",{children:"Resistances:"})," ",s.resistances.join(", ")]}):null]}),e.jsx(R,{})," "]}):null,s.traits&&s.traits.length>0?e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("h3",{className:z.heading,children:"Traits"}),e.jsx(J,{}),e.jsx("ul",{className:z.traits,children:(j=s.traits)==null?void 0:j.map((h,v)=>{let b=h.value;return h.value.includes(",")&&(b=h.value.split(",")[0]),e.jsxs("li",{className:z.trait,children:[e.jsxs("b",{children:[h.name,":"]}),e.jsx("div",{children:b})]},v)})})]}),e.jsx(R,{})]}):null,e.jsx(pe,{slug:s.slug,about:s.about,stats:a,statblock:s,context:s.name})]})},Gn="_heading_13jjy_1",Zn="_skills_13jjy_7",Xn="_skill_13jjy_7",ye={heading:Gn,skills:Zn,skill:Xn},Yn=()=>{var t;const{statblock:s,stats:a,tokenName:i}=Z();return e.jsxs("div",{children:[e.jsx("h3",{className:ye.heading,children:"Skills"}),e.jsx(J,{}),e.jsx("ul",{className:ye.skills,children:(t=s.skills)==null?void 0:t.map((n,p)=>{let l=0;try{l=parseInt(n.value)}catch{}return e.jsxs("li",{className:ye.skill,style:{background:`linear-gradient(to right, #3f3f3f, transparent  ${l/30*100}%)`},children:[e.jsx("b",{children:T.capitalize(n.name.replaceAll("_"," "))}),e.jsx(P,{dice:`d20+${l}`,text:Intl.NumberFormat("en-US",{signDisplay:"always"}).format(Math.floor(l)),stats:a,context:`${T.capitalize(n.name)}: Check`,statblock:i})]},p)})})]})},ei="_heading_1jstp_1",si="_itemName_1jstp_7",ti={heading:ei,itemName:si},ni=({ability:s,statblock:a,stats:i})=>{const[t,n]=y.useState(!1),p=Object.entries(s),l=()=>{let d=!1;return p.forEach(f=>{const[r,u]=f;!["name","type","description","value"].includes(r)&&u&&(d=!0)}),d},c=d=>{let f="";if(Object.keys(d).includes("type")){const r=d;if(r.type==="ONE")f="(one action)";else if(r.type==="TWO")f="(two actions)";else if(r.type==="THREE")f="(three actions)";else if(r.type==="FREE")f="(free action)";else return"";return e.jsx("span",{className:"action-type",children:f})}return""},o=d=>!!Object.keys(d).includes("type");return e.jsxs("div",{className:`pf-ability ${t?"open":""}`,children:[e.jsxs("div",{className:"main-info",children:[e.jsxs("div",{className:"name-and-description",children:[e.jsx("b",{className:"ability-name",children:s.name})," ",c(s),Object.keys(s).includes("description")&&s.description!==""?e.jsx("div",{className:`ability-description ${o(s)?"action":"ability"}`,children:e.jsx(W,{text:s.description,context:`${T.capitalize(s.name)}`,statblock:a,stats:i})}):null]}),l()?e.jsx("button",{className:`expand ${t?"open":""}`,onClick:()=>n(!t)}):null]}),e.jsx("div",{className:`action-details-wrapper  ${t?"open":null}`,children:e.jsx("ul",{className:"action-details",children:Object.entries(s).map(([d,f],r)=>{if(f!==null&&f!==""&&T.isString(f)&&!["name","type","description","value","limit"].includes(d))return e.jsxs("li",{children:[e.jsx("b",{children:d}),":"," ",e.jsx(W,{text:f,stats:i,context:`${T.capitalize(s.name)}: ${T.capitalize(d)}`,statblock:a,damageDie:d==="damage"})]},r)})})})]},s.name)},Se=({heading:s,abilities:a})=>{const{statblock:i,stats:t}=Z();return e.jsxs("div",{children:[e.jsx("h3",{className:ti.heading,children:s}),e.jsx(J,{}),a==null?void 0:a.map((n,p)=>e.jsxs("div",{children:[e.jsx(ni,{ability:n,statblock:i.name,stats:t},p),e.jsx(R,{})]},p))]})},ii=()=>{const{statblock:s,item:a}=Z(),{activeTab:i,setActiveTab:t}=fe(),n=`${a.id}-action`,p=y.useMemo(()=>{var d,f;const o=[];return(d=s.actions)!=null&&d.length&&o.push("action"),(f=s.reactions)!=null&&f.length&&o.push("reaction"),o},[s]),l=n in i?i[n]:p[0],c=y.useMemo(()=>l==="action"?e.jsx(Se,{heading:"Actions",abilities:s.actions}):l==="reaction"?e.jsx(Se,{heading:"Reactions",abilities:s.reactions}):e.jsx(e.Fragment,{}),[l]);return e.jsx(e.Fragment,{children:p.length===1?e.jsx(e.Fragment,{children:c}):e.jsxs("div",{className:L.actionWrapper,children:[e.jsx("ul",{className:L.tabs,children:p.map((o,d)=>e.jsx("li",{className:l===o?`${L.tab} ${L.activeTab}`:L.tab,onClick:()=>t(n,o),children:o},d))}),e.jsx("div",{className:L.content,children:c})]})})},ai="_heading_1vm31_1",li="_sectionHeading_1vm31_7",as={heading:ai,sectionHeading:li},ci=s=>{var l,c,o;const[a,i]=y.useState(!1),t=Cs(s.spell.slug),n=t.isSuccess&&t.data?t.data:null,p=Be(((l=n==null?void 0:n.description)==null?void 0:l.text)||"");return e.jsxs("li",{className:"spell",children:[e.jsxs("div",{className:"spell-main",children:[e.jsxs("div",{className:"spell-info",children:[e.jsx("div",{className:"spell-header",children:e.jsx("h4",{className:"spell-name",children:n==null?void 0:n.name})}),p?e.jsxs("span",{className:"spell-damage",children:["Damage:"," ",e.jsx(W,{text:p,stats:s.stats,context:`${T.capitalize(n==null?void 0:n.name)} Damage`,statblock:s.statblock,damageDie:!0})]}):null,n!=null&&n.cast?e.jsxs("div",{className:"spell-components",children:[n.cast.verbal?"V":null,n.cast.somatic?"S":null,e.jsxs("span",{className:"spell-materials",children:[n.cast.material?"M":null,e.jsx("span",{className:"material-details",children:n.cast.cost?` (${n.cast.cost})`:null})]})]}):null]}),e.jsx("button",{className:`expand ${a?"open":null}`,onClick:()=>i(!a)})]}),e.jsx("div",{className:`spell-more-info ${a?"open":null}`,children:e.jsxs("div",{className:"more-info-content",children:[e.jsxs("div",{className:"info-bits",children:[n!=null&&n.traits&&n.traits.length>0?e.jsxs("span",{children:[e.jsx("b",{children:"Traits"}),": ",n.traits.map(d=>d.name).join(", ")]}):null,n!=null&&n.traditions&&n.traditions.length>0?e.jsxs("span",{children:[e.jsx("b",{children:"Traditions"}),": ",n.traditions.map(d=>d.name).join(", ")]}):null,n!=null&&n.bloodlines&&n.bloodlines.length>0?e.jsxs("span",{children:[e.jsx("b",{children:"Bloodlines"}),": ",n.bloodlines.map(d=>d.name).join(", ")]}):null,n!=null&&n.deities&&n.deities.length>0?e.jsxs("span",{children:[e.jsx("b",{children:"Deities"}),": ",n.deities.map(d=>d.name).join(", ")]}):null,n!=null&&n.domains&&n.domains.length>0?e.jsxs("span",{children:[e.jsx("b",{children:"Domains"}),": ",n.domains.map(d=>d.name).join(", ")]}):null,n!=null&&n.mysteries&&n.mysteries.length>0?e.jsxs("span",{children:[e.jsx("b",{children:"Mysteries"}),": ",n.mysteries.map(d=>d.name).join(", ")]}):null,n!=null&&n.range?e.jsxs("span",{children:[e.jsx("b",{children:"Range"}),": ",n==null?void 0:n.range]}):null,n!=null&&n.area?e.jsxs("span",{children:[e.jsx("b",{children:"Area"}),": ",n==null?void 0:n.area]}):null,n!=null&&n.targets?e.jsxs("span",{children:[e.jsx("b",{children:"Targets"}),": ",n==null?void 0:n.targets]}):null,n!=null&&n.duration?e.jsxs("span",{children:[e.jsx("b",{children:"Duration"}),": ",n==null?void 0:n.duration]}):null,n!=null&&n.saving_throws?e.jsxs("span",{children:[e.jsx("b",{children:"Saving Throws"}),": ",n==null?void 0:n.saving_throws]}):null,n!=null&&n.trigger?e.jsxs("span",{children:[e.jsx("b",{children:"Trigger"}),": ",n==null?void 0:n.trigger]}):null]}),e.jsxs("div",{className:"spell-description",children:[e.jsx("b",{children:"Description"}),":"," ",e.jsx(W,{text:((c=n==null?void 0:n.description)==null?void 0:c.text)||"",context:`${T.capitalize(n==null?void 0:n.name)}`,statblock:s.statblock,stats:s.stats}),(o=n==null?void 0:n.description)!=null&&o.details&&n.description.details.length>0?e.jsx("ul",{children:n==null?void 0:n.description.details.map((d,f)=>e.jsxs("li",{children:[e.jsx("b",{children:d.title}),":"," ",e.jsx(W,{text:d.text,context:`${T.capitalize(n.name)} ${d.title}`,statblock:s.statblock,stats:s.stats})]},f))}):null]}),n!=null&&n.heightened&&n.heightened.length>0?e.jsxs("div",{className:"spell-higher-level",children:[e.jsx("b",{children:"Heightened"}),":",e.jsx("div",{children:n.heightened.map((d,f)=>e.jsxs("div",{children:[e.jsx("div",{className:"modifier",children:e.jsx(W,{text:d.modifier,stats:s.stats,context:`${T.capitalize(n.name)}: Heightened`,statblock:s.statblock})}),e.jsx("div",{className:"description",children:e.jsx(W,{text:d.description,context:`${T.capitalize(n.name)}: Heightened`,statblock:s.statblock,stats:s.stats})})]},f))})]}):null]})})]})},ri=s=>e.jsxs("div",{className:"spell-list",children:[e.jsxs("h4",{className:"spell-list-title",children:[e.jsxs("span",{className:"spell-list-type",children:[s.list.type,"s"]})," ",e.jsxs("span",{className:"spell-list-level",children:[s.list.level," Level"]})]}),e.jsx("ul",{className:"spells",children:s.list.spells?s.list.spells.map(a=>e.jsxs(e.Fragment,{children:[e.jsx(ci,{spell:a,statblock:s.statblock,stats:s.stats},a.slug),e.jsx(R,{})]})):null})]}),oi=s=>{const[a,i]=y.useState([]),[t,n]=y.useState(!1),p=(c,o)=>c==="All"?-1:o==="All"?1:c==="Cant"||c==="Const"?-1:o==="Cant"||o==="Const"?1:parseInt(c)-parseInt(o),l=["All"].concat(s.spellCategory.spell_lists?s.spellCategory.spell_lists.map(c=>c.type.toLowerCase().startsWith("cantrip")?"Cant":c.type.toLowerCase().startsWith("constant")?"Const":c.level):[]).filter((c,o,d)=>d.indexOf(c)===o).sort(p);return e.jsxs("div",{className:"spell-category",children:[e.jsxs("div",{className:"spell-category-main",children:[e.jsxs("div",{className:"spell-category-header",children:[e.jsx("h3",{className:as.sectionHeading,children:s.spellCategory.name}),e.jsxs("span",{className:"spell-category-info",children:[s.spellCategory.dc?`DC: ${s.spellCategory.dc}`:null," ",s.spellCategory.attack?e.jsxs("span",{className:"text-roll",children:["Attack:"," ",e.jsx(P,{dice:`d20+${s.spellCategory.attack}`,text:`+${s.spellCategory.attack}`,stats:s.stats,context:`${T.capitalize(s.spellCategory.name)}: Attack`,statblock:s.statblock})]}):null]})]}),e.jsx("button",{className:`expand ${t?"open":null}`,onClick:()=>n(!t)})]}),e.jsx("div",{className:`spell-category-details ${t?"open":null}`,children:e.jsxs("div",{className:"spell-category-details-content",children:[e.jsx(ss,{filters:l,spellFilter:a,setSpellFilter:i,left:!0}),s.spellCategory.spell_lists?s.spellCategory.spell_lists.sort((c,o)=>{let d=c.level,f=o.level;return c.type.toLowerCase().startsWith("cantrip")?d="Cant":c.type.toLowerCase().startsWith("constant")&&(d="Const"),o.type.toLowerCase().startsWith("cantrip")?f="Cant":o.type.toLowerCase().startsWith("constant")&&(f="Const"),p(d,f)}).filter(c=>a.length===0?!0:c.type==="spell"?a.indexOf(parseInt(c.level))>=0:c.type.toLowerCase().startsWith("cantrip")?a.indexOf(0)>=0:a.indexOf(-1)>=0).map(c=>e.jsx(ri,{list:c,statblock:s.statblock,stats:s.stats},c.type+c.level)):null]})})]})},di=s=>e.jsxs("div",{className:"spells",children:[e.jsx("h3",{className:as.heading,children:"Spells"}),e.jsx(J,{}),s.spells.map((a,i)=>a?e.jsx(oi,{stats:s.stats,spellCategory:a,statblock:s.statblock},a.name+i):null),e.jsx(J,{})]}),ui=()=>{var a;const{statblock:s}=Z();return e.jsxs("div",{children:[e.jsx("h3",{className:K.heading,children:"Inventory"}),e.jsx(J,{}),e.jsx("ul",{children:(a=s.items)==null?void 0:a.map((i,t)=>e.jsx("li",{children:i},t))})]})},mi=()=>{const{statblock:s,item:a}=Z(),{activeTab:i,setActiveTab:t}=fe(),n=a.id in i?i[a.id]:"general",p=y.useMemo(()=>{var o,d,f,r,u;const c=["general","skills"];return((o=s.actions)!=null&&o.length||(d=s.reactions)!=null&&d.length)&&c.push("actions"),(f=s.items)!=null&&f.length&&c.push("inventory"),(r=s.spells)!=null&&r.length&&c.push("spells"),(u=s.special_abilities)!=null&&u.length&&c.push("special"),c},[s]),l=y.useMemo(()=>n==="general"?e.jsx(Un,{}):n==="skills"?e.jsx(Yn,{}):n==="actions"?e.jsx(ii,{}):n==="inventory"?e.jsx(ui,{}):n==="spells"?e.jsx(di,{spells:s.spells,statblock:s.name,stats:s.stats}):n==="special"?e.jsx(Se,{heading:"Reactions",abilities:s.special_abilities}):e.jsx(e.Fragment,{}),[n]);return e.jsxs("div",{className:L.wrapper,children:[e.jsx("ul",{className:L.tabs,children:p.map((c,o)=>e.jsx("li",{className:n===c?`${L.tab} ${L.activeTab}`:L.tab,onClick:()=>t(a.id,c),children:c},o))}),e.jsx("div",{className:L.content,children:l})]})},hi=()=>{const{statblock:s}=Z();return e.jsxs("div",{className:Q.statblock,children:[e.jsxs("div",{className:Q.title,children:[e.jsxs("div",{children:[e.jsx("h1",{className:Q.name,children:s.name}),e.jsxs("div",{className:Q.note,children:["Type: ",s.type,", Level: ",s.level]})]}),e.jsx(Rn,{})]}),e.jsx(mi,{})]})},xi=({slug:s,itemId:a})=>{const i=$s(s),t=i.isSuccess&&i.data?i.data:null;return t?e.jsx(An,{itemId:a,statblock:t,children:e.jsx(hi,{})}):e.jsx(ie,{})},Fi=({id:s})=>{const a=G(O(n=>n.room)),i=we(O(n=>{var p;return(p=n.tokens)==null?void 0:p.get(s)})),t=i==null?void 0:i.data;return i?e.jsx("div",{className:"statblock-wrapper",children:a&&a.ruleset==="e5"?e.jsx(Dn,{slug:t.sheet,itemId:s}):e.jsx(xi,{slug:t.sheet,itemId:s})}):null},ke=({options:s,current:a,setTheme:i})=>{const[t,n]=y.useState(a),[p,l]=y.useState(!1);return e.jsxs("div",{className:`select ${p?"open":"close"}`,children:[e.jsxs("div",{className:"select-current",onClick:()=>l(!0),children:[e.jsxs("span",{className:"current",children:[(t==null?void 0:t.icon)||null,e.jsx("span",{children:(t==null?void 0:t.name)||""})]}),e.jsx("div",{className:"expand-wrapper",children:e.jsx("button",{className:"expand button"})})]}),e.jsx("div",{className:"height-wrapper",children:e.jsxs("div",{className:"options-wrapper",children:[e.jsx("div",{className:"select-options",children:s.sort((c,o)=>c.value===(t==null?void 0:t.value)?-1:o.value===(t==null?void 0:t.value)?1:0).map(c=>e.jsxs("div",{className:`select-option ${(t==null?void 0:t.value)===c.value?"current":""}`,onClick:()=>{n(c),i(c.value),l(!1)},children:[c.icon||null,e.jsxs("span",{className:"name",children:[c.name," "]})]},c.value))}),e.jsx("div",{className:"expand-wrapper",onClick:()=>{l(!1)},children:e.jsx("button",{className:"expand button"})})]})})]})},pi=({setSettings:s})=>{var h;const a=G(O(v=>v.room)),[i,t,n,p,l]=xe(O(v=>[v.rollerApi,v.theme,v.setTheme,v.themes,v.rooms])),c=ae(),[o,d]=y.useState(!0),[f,r]=y.useState(!1),[u,g]=y.useState(null),x=l.find(v=>{var b;return v.slug===((b=a==null?void 0:a.diceRoom)==null?void 0:b.slug)}),j=async(v,b)=>{var $;try{r(!0);const w=($=await(i==null?void 0:i.theme.get(v)))==null?void 0:$.data;w&&Re(w)?w.id!==(t==null?void 0:t.id)&&(a&&c.id?(await de(a,c.id,{diceTheme:w.id}),d(!0),n(w)):(b&&(b.value=(t==null?void 0:t.id)||""),g("error updating theme"),d(!1))):d(!1)}catch{b&&(b.value=(t==null?void 0:t.id)||""),g("theme not found"),d(!1)}finally{r(!1)}};return y.useEffect(()=>{u&&setTimeout(()=>{g(null)},5e3)},[u]),e.jsxs("div",{className:"dice-settings",children:[e.jsx("button",{className:"close-button",onClick:()=>{s(!1)},children:"X"}),i?e.jsxs("div",{className:`setting dice-theme ${o?"valid":"invalid"} ${f?"searching":""}`,children:[e.jsx("span",{className:"setting-name",children:"dice theme:"}),e.jsx(ke,{options:T.isNull(p)?[]:p.filter(v=>Re(v)).map(v=>({value:v.id,name:v.name||v.id,icon:te(v)})),current:t?{value:t.id,name:t.name,icon:te(t)}:void 0,setTheme:j})]}):e.jsx("span",{children:"Unable to connect with dddice"}),u?e.jsx("span",{children:u}):null,c.role==="GM"?e.jsxs("div",{className:"setting dice-room-select valid",children:[e.jsx("span",{className:"setting-name",children:"dice room:"}),l.length===0&&!x?e.jsx(ie,{className:"room-loader"}):e.jsx(ke,{options:l.map(v=>({value:v.slug,name:`${v.name} - ${v.slug}`})),current:x?{value:x.slug,name:`${x.name} - ${x.slug}`}:void 0,setTheme:async v=>{a&&await bs(a,v)}})]}):null,e.jsxs("div",{className:"setting dice-rendering",children:[e.jsx("span",{className:"text",children:"Render 3D Dice "}),e.jsx("input",{type:"checkbox",checked:((h=_e(a,c.id))==null?void 0:h.diceRendering)??!0,onChange:async()=>{if(a){const v=U.player.id,b=_e(a,v);b&&(await de(a,v,{diceRendering:!b.diceRendering}),b.diceRendering||await U.modal.open({...Ns,url:`https://dddice.com/room/${a.diceRoom.slug}/stream?key=${b.apiKey}`}))}}})]})]})},ne=()=>e.jsx("svg",{className:"dice-svg",viewBox:"0 0 50 50",version:"1.1",children:e.jsxs("g",{transform:"matrix(0.09730448,0,0,0.09730448,0.02976391,0.15890765)",children:[e.jsx("path",{d:"M 449.532,105.602 288.463,8.989 C 278.474,2.994 267.235,0 256.011,0 244.772,0 233.528,2.994 223.544,8.989 L 62.475,105.602 c -19.012,11.406 -30.647,31.95 -30.647,54.117 v 192.562 c 0,22.168 11.635,42.711 30.647,54.117 l 161.069,96.613 c 9.984,5.988 21.228,8.989 32.467,8.989 11.225,0 22.463,-3.001 32.452,-8.989 l 161.069,-96.613 c 19.012,-11.406 30.64,-31.949 30.64,-54.117 V 159.719 c 0,-22.167 -11.628,-42.711 -30.64,-54.117 z M 250.599,492.733 c -6.029,-0.745 -11.93,-2.719 -17.32,-5.948 L 72.21,390.172 C 58.904,382.183 50.754,367.803 50.754,352.281 V 159.719 c 0,-6.022 1.236,-11.862 3.518,-17.233 L 250.6,260.246 V 492.733 Z M 59.669,133.114 c 3.364,-4.464 7.593,-8.318 12.541,-11.285 L 233.279,25.216 c 6.995,-4.196 14.85,-6.291 22.732,-6.291 7.868,0 15.723,2.095 22.718,6.291 l 161.069,96.613 c 4.941,2.967 9.184,6.821 12.54,11.285 L 256.011,250.881 Z m 401.585,219.167 c 0,15.522 -8.15,29.902 -21.456,37.891 l -161.069,96.613 c -5.398,3.229 -11.292,5.203 -17.321,5.948 V 260.246 l 196.328,-117.76 c 2.283,5.37 3.518,11.211 3.518,17.233 z"}),e.jsx("path",{d:"m 160.209,119.875 c -9.828,-7.278 -26.021,-7.465 -36.165,-0.41 -10.144,7.056 -10.399,18.67 -0.57,25.947 9.828,7.277 26.022,7.459 36.159,0.41 10.15,-7.056 10.405,-18.67 0.576,-25.947 z"}),e.jsx("path",{d:"m 279.159,48.686 c -9.829,-7.277 -26.022,-7.458 -36.172,-0.403 -10.137,7.049 -10.393,18.664 -0.564,25.941 9.829,7.284 26.022,7.458 36.159,0.416 10.15,-7.062 10.405,-18.677 0.577,-25.954 z"}),e.jsx("path",{d:"m 220.59,82.024 c -9.834,-7.27 -26.028,-7.458 -36.172,-0.403 -10.15,7.049 -10.406,18.664 -0.571,25.941 9.829,7.284 26.022,7.458 36.166,0.416 10.138,-7.062 10.399,-18.676 0.577,-25.954 z"}),e.jsx("path",{d:"m 267.437,184.754 c -9.828,-7.277 -26.015,-7.459 -36.159,-0.41 -10.15,7.056 -10.405,18.671 -0.577,25.947 9.828,7.284 26.021,7.459 36.172,0.41 10.137,-7.056 10.392,-18.67 0.564,-25.947 z"}),e.jsx("path",{d:"m 386.385,113.564 c -9.828,-7.271 -26.021,-7.458 -36.158,-0.403 -10.151,7.049 -10.406,18.664 -0.577,25.941 9.828,7.284 26.02,7.458 36.172,0.416 10.137,-7.062 10.392,-18.676 0.563,-25.954 z"}),e.jsx("path",{d:"m 327.817,146.903 c -9.829,-7.27 -26.022,-7.458 -36.172,-0.403 -10.137,7.049 -10.392,18.664 -0.564,25.941 9.828,7.284 26.021,7.465 36.158,0.416 10.152,-7.062 10.407,-18.669 0.578,-25.954 z"}),e.jsx("path",{d:"m 89.289,248.303 c 11.158,6.083 20.194,1.961 20.194,-9.19 0,-11.158 -9.036,-25.128 -20.194,-31.21 -11.157,-6.083 -20.207,-1.967 -20.207,9.19 -10e-4,11.151 9.049,25.128 20.207,31.21 z"}),e.jsx("path",{d:"m 202.061,309.771 c 11.158,6.082 20.208,1.967 20.208,-9.184 0,-11.157 -9.05,-25.135 -20.208,-31.217 -11.15,-6.076 -20.194,-1.961 -20.194,9.198 0,11.151 9.044,25.121 20.194,31.203 z"}),e.jsx("path",{d:"m 89.289,361.082 c 11.158,6.076 20.194,1.967 20.194,-9.19 0,-11.158 -9.036,-25.129 -20.194,-31.21 -11.157,-6.083 -20.207,-1.968 -20.207,9.19 -10e-4,11.157 9.049,25.128 20.207,31.21 z"}),e.jsx("path",{d:"m 202.061,422.55 c 11.158,6.082 20.208,1.967 20.208,-9.191 0,-11.151 -9.05,-25.128 -20.208,-31.21 -11.15,-6.076 -20.194,-1.961 -20.194,9.19 0,11.158 9.044,25.129 20.194,31.211 z"}),e.jsx("path",{d:"m 145.675,335.424 c 11.158,6.082 20.201,1.967 20.201,-9.191 0,-11.151 -9.044,-25.128 -20.201,-31.204 -11.158,-6.082 -20.201,-1.967 -20.201,9.185 0,11.156 9.043,25.127 20.201,31.21 z"}),e.jsx("path",{d:"m 418.341,207.902 c -11.158,6.082 -20.208,20.053 -20.208,31.21 0,11.151 9.05,15.273 20.208,9.19 11.144,-6.082 20.194,-20.059 20.194,-31.21 0,-11.157 -9.049,-15.273 -20.194,-9.19 z"}),e.jsx("path",{d:"m 305.555,382.149 c -11.158,6.082 -20.194,20.059 -20.194,31.21 0,11.158 9.036,15.273 20.194,9.191 11.158,-6.082 20.194,-20.053 20.194,-31.211 0,-11.151 -9.035,-15.265 -20.194,-9.19 z"}),e.jsx("path",{d:"m 361.948,295.028 c -11.158,6.076 -20.207,20.053 -20.207,31.204 0,11.158 9.05,15.273 20.207,9.191 11.158,-6.083 20.194,-20.053 20.194,-31.21 0,-11.151 -9.036,-15.266 -20.194,-9.185 z"})]})}),fi=()=>e.jsx("svg",{className:"add-svg",height:"24",viewBox:"0 -960 960 960",width:"24",children:e.jsx("path",{d:"M440-440H200v-80h240v-240h80v240h240v80H520v240h-80v-240Z"})}),ji=()=>e.jsxs("svg",{className:"roll-log-svg",viewBox:"0 0 128 128",width:"64px",height:"64px",children:[e.jsx("path",{d:"M 114.638,0.55489756 H 23.775355 c -7.269012,0 -13.124604,5.85559234 -13.124604,13.12460444 v 77.73804 c 0,1.716297 1.31246,3.028759 3.028754,3.028759 1.716294,0 3.028755,-1.312462 3.028755,-3.028759 v -77.73804 c 0,-3.9373809 3.129713,-7.0670952 7.067095,-7.0670952 h 79.757215 c -1.31246,2.0191707 -2.01917,4.4421742 -2.01917,7.0670952 V 114.638 c 0,3.93738 -3.129714,7.06709 -7.06709,7.06709 -3.937384,0 -7.067098,-3.12971 -7.067098,-7.06709 v -10.09585 c 0,-1.7163 -1.312461,-3.02876 -3.028761,-3.02876 H 3.5836557 c -1.7162944,0 -3.02875499,1.31246 -3.02875499,3.02876 V 114.638 c 0,7.26901 5.85559229,13.1246 13.12460429,13.1246 H 94.44631 c 7.26901,0 13.1246,-5.85559 13.1246,-13.1246 V 13.679502 c 0,-3.9373809 3.12972,-7.0670952 7.06709,-7.0670952 3.93739,0 7.0671,3.1297143 7.0671,7.0670952 v 7.067095 h -7.0671 c -1.71629,0 -3.02875,1.31246 -3.02875,3.028755 0,1.716294 1.31246,3.028754 3.02875,3.028754 h 10.09585 c 1.7163,0 3.02876,-1.31246 3.02876,-3.028754 v -10.09585 c 0,-7.2690121 -5.85559,-13.12460444 -13.12461,-13.12460444 z M 13.679505,121.70509 c -3.9373809,0 -7.0670942,-3.12971 -7.0670942,-7.06709 v -7.0671 H 81.321701 v 7.0671 c 0,2.62492 0.807662,5.04792 2.019169,7.06709 z"}),e.jsxs("g",{transform:"matrix(0.15293651,0,0,0.15293651,20.080574,15.684728)",children:[e.jsx("path",{d:"M 449.532,105.602 288.463,8.989 C 278.474,2.994 267.235,0 256.011,0 244.772,0 233.528,2.994 223.544,8.989 L 62.475,105.602 c -19.012,11.406 -30.647,31.95 -30.647,54.117 v 192.562 c 0,22.168 11.635,42.711 30.647,54.117 l 161.069,96.613 c 9.984,5.988 21.228,8.989 32.467,8.989 11.225,0 22.463,-3.001 32.452,-8.989 l 161.069,-96.613 c 19.012,-11.406 30.64,-31.949 30.64,-54.117 V 159.719 c 0,-22.167 -11.628,-42.711 -30.64,-54.117 z M 250.599,492.733 c -6.029,-0.745 -11.93,-2.719 -17.32,-5.948 L 72.21,390.172 C 58.904,382.183 50.754,367.803 50.754,352.281 V 159.719 c 0,-6.022 1.236,-11.862 3.518,-17.233 L 250.6,260.246 V 492.733 Z M 59.669,133.114 c 3.364,-4.464 7.593,-8.318 12.541,-11.285 L 233.279,25.216 c 6.995,-4.196 14.85,-6.291 22.732,-6.291 7.868,0 15.723,2.095 22.718,6.291 l 161.069,96.613 c 4.941,2.967 9.184,6.821 12.54,11.285 L 256.011,250.881 Z m 401.585,219.167 c 0,15.522 -8.15,29.902 -21.456,37.891 l -161.069,96.613 c -5.398,3.229 -11.292,5.203 -17.321,5.948 V 260.246 l 196.328,-117.76 c 2.283,5.37 3.518,11.211 3.518,17.233 z"}),e.jsx("path",{d:"m 160.209,119.875 c -9.828,-7.278 -26.021,-7.465 -36.165,-0.41 -10.144,7.056 -10.399,18.67 -0.57,25.947 9.828,7.277 26.022,7.459 36.159,0.41 10.15,-7.056 10.405,-18.67 0.576,-25.947 z"}),e.jsx("path",{d:"m 279.159,48.686 c -9.829,-7.277 -26.022,-7.458 -36.172,-0.403 -10.137,7.049 -10.393,18.664 -0.564,25.941 9.829,7.284 26.022,7.458 36.159,0.416 10.15,-7.062 10.405,-18.677 0.577,-25.954 z"}),e.jsx("path",{d:"m 220.59,82.024 c -9.834,-7.27 -26.028,-7.458 -36.172,-0.403 -10.15,7.049 -10.406,18.664 -0.571,25.941 9.829,7.284 26.022,7.458 36.166,0.416 10.138,-7.062 10.399,-18.676 0.577,-25.954 z"}),e.jsx("path",{d:"m 267.437,184.754 c -9.828,-7.277 -26.015,-7.459 -36.159,-0.41 -10.15,7.056 -10.405,18.671 -0.577,25.947 9.828,7.284 26.021,7.459 36.172,0.41 10.137,-7.056 10.392,-18.67 0.564,-25.947 z"}),e.jsx("path",{d:"m 386.385,113.564 c -9.828,-7.271 -26.021,-7.458 -36.158,-0.403 -10.151,7.049 -10.406,18.664 -0.577,25.941 9.828,7.284 26.02,7.458 36.172,0.416 10.137,-7.062 10.392,-18.676 0.563,-25.954 z"}),e.jsx("path",{d:"m 327.817,146.903 c -9.829,-7.27 -26.022,-7.458 -36.172,-0.403 -10.137,7.049 -10.392,18.664 -0.564,25.941 9.828,7.284 26.021,7.465 36.158,0.416 10.152,-7.062 10.407,-18.669 0.578,-25.954 z"}),e.jsx("path",{d:"m 89.289,248.303 c 11.158,6.083 20.194,1.961 20.194,-9.19 0,-11.158 -9.036,-25.128 -20.194,-31.21 -11.157,-6.083 -20.207,-1.967 -20.207,9.19 -10e-4,11.151 9.049,25.128 20.207,31.21 z"}),e.jsx("path",{d:"m 202.061,309.771 c 11.158,6.082 20.208,1.967 20.208,-9.184 0,-11.157 -9.05,-25.135 -20.208,-31.217 -11.15,-6.076 -20.194,-1.961 -20.194,9.198 0,11.151 9.044,25.121 20.194,31.203 z"}),e.jsx("path",{d:"m 89.289,361.082 c 11.158,6.076 20.194,1.967 20.194,-9.19 0,-11.158 -9.036,-25.129 -20.194,-31.21 -11.157,-6.083 -20.207,-1.968 -20.207,9.19 -10e-4,11.157 9.049,25.128 20.207,31.21 z"}),e.jsx("path",{d:"m 202.061,422.55 c 11.158,6.082 20.208,1.967 20.208,-9.191 0,-11.151 -9.05,-25.128 -20.208,-31.21 -11.15,-6.076 -20.194,-1.961 -20.194,9.19 0,11.158 9.044,25.129 20.194,31.211 z"}),e.jsx("path",{d:"m 145.675,335.424 c 11.158,6.082 20.201,1.967 20.201,-9.191 0,-11.151 -9.044,-25.128 -20.201,-31.204 -11.158,-6.082 -20.201,-1.967 -20.201,9.185 0,11.156 9.043,25.127 20.201,31.21 z"}),e.jsx("path",{d:"m 418.341,207.902 c -11.158,6.082 -20.208,20.053 -20.208,31.21 0,11.151 9.05,15.273 20.208,9.19 11.144,-6.082 20.194,-20.059 20.194,-31.21 0,-11.157 -9.049,-15.273 -20.194,-9.19 z"}),e.jsx("path",{d:"m 305.555,382.149 c -11.158,6.082 -20.194,20.059 -20.194,31.21 0,11.158 9.036,15.273 20.194,9.191 11.158,-6.082 20.194,-20.053 20.194,-31.211 0,-11.151 -9.035,-15.265 -20.194,-9.19 z"}),e.jsx("path",{d:"m 361.948,295.028 c -11.158,6.076 -20.207,20.053 -20.207,31.204 0,11.158 9.05,15.273 20.207,9.191 11.158,-6.083 20.194,-20.053 20.194,-31.21 0,-11.151 -9.036,-15.266 -20.194,-9.185 z"})]})]}),gi=s=>{const[a,i,t,n]=xe(O(N=>[N.rollerApi,N.theme,N.initialized,N.themes])),p=he(O(N=>N.addRoll)),{buttons:l,setButtons:c}=Me(),[o,d]=G(O(N=>[N.room,N.taSettings])),[f,r]=y.useState(!1),[u,g]=y.useState(!1),[x,j]=y.useState(!1),[h,v]=y.useState(i),b=y.useRef(null),w=ae().role==="GM"&&!!d.gm_rolls_hidden;y.useEffect(()=>{v(i)},[i]);const D=N=>{if(!T.isNull(n)){const S=n.find(_=>_.id===N);S&&v(S)}},A=y.useCallback(()=>{if(s.customDice&&i&&!(o!=null&&o.disableDiceRoller))try{const N=ce.parseRollEquation(s.customDice.dice,s.customDice.theme??i.id);return e.jsx("div",{className:"custom-dice-preview-wrapper",children:N.dice.map((S,_)=>{var C;if(S.type!=="mod"){const F=Ts(i,S.type,_,(C=s.customDice)==null?void 0:C.theme,n);if(F)return F}if(S.type!=="mod"&&i.preview.hasOwnProperty(S.type))return e.jsx("img",{className:"preview-image",src:i.preview[S.type],alt:S.type},_);if(S.type!=="mod"&&!i.preview.hasOwnProperty(S.type))return e.jsx("div",{className:"preview-image",children:ue(S.type)},_);if(S.value)return e.jsx("span",{className:"modifier",children:Intl.NumberFormat("en-US",{signDisplay:"always"}).format(S.value)},_)})})}catch{return e.jsx(ne,{})}else if(s.customDice)try{const N=ce.parseRollEquation(s.customDice.dice,s.customDice.theme??"dddice-bees");return e.jsx("div",{className:"custom-dice-preview-wrapper",children:N.dice.map((S,_)=>{if(S.type!=="mod")return e.jsx("div",{className:"preview-image",children:ue(S.type)},_);if(S.value)return e.jsx("span",{className:"modifier",children:Intl.NumberFormat("en-US",{signDisplay:"always"}).format(S.value)},_)})})}catch{return e.jsx(ne,{})}return e.jsx(ne,{})},[i,s.customDice,o==null?void 0:o.disableDiceRoller,n,a]),m=async(N,S=!1)=>{if(N.classList.add("rolling"),!(o!=null&&o.disableDiceRoller)&&a&&i&&s.customDice){let _=He(s.customDice.dice,s.customDice.theme??i.id);await Ve(a,_.dice,{operator:_.operator,label:"Roll: Custom",whisper:S?await Ke(o,a):void 0})}else s.customDice&&await We(s.customDice.dice,"Roll: Custom",p,S);N.classList.remove("rolling"),N.blur()},k=y.useCallback(()=>t&&!(o!=null&&o.disableDiceRoller)||(o==null?void 0:o.disableDiceRoller),[t,o==null?void 0:o.disableDiceRoller]);return e.jsxs("div",{className:`custom-dice-wrapper ${s.customDice&&!s.customDice.removed?"has-dice":""}`,onMouseEnter:()=>r(!0),onMouseLeave:()=>r(!1),children:[e.jsx(q,{content:s.customDice&&!s.customDice.removed?s.customDice.dice:"Add new custom dice roll",children:e.jsx("button",{className:`button custom-dice dice-${s.button} ${k()?"enabled":"disabled"} ${u?"open":""}`,onClick:async N=>{(!s.customDice||s.customDice.removed)&&l.hasOwnProperty(String(s.button))?g(!0):s.customDice&&!s.customDice.removed&&await m(N.currentTarget,w)},children:s.customDice&&!s.customDice.removed?A():e.jsx(fi,{})})}),u?e.jsxs("div",{className:"add-custom-dice",children:[o!=null&&o.disableDiceRoller?null:e.jsx("div",{className:"setting dice-theme valid searching",children:e.jsx(ke,{options:T.isNull(n)?[]:n.map(N=>({value:N.id,name:N.name||N.id,icon:te(N)})),current:{value:(h==null?void 0:h.id)||(i==null?void 0:i.id)||"",name:(h==null?void 0:h.name)||(i==null?void 0:i.name)||"",icon:h?te(h):i?te(i):void 0},setTheme:D})}),e.jsxs("div",{className:"dice-equation",children:[e.jsx("input",{ref:b,type:"text",onChange:N=>{var _,C,F,I,H,Te;const S=N.currentTarget.value;try{h&&!(o!=null&&o.disableDiceRoller)?ce.parseRollEquation(S,h)&&(j(!0),(_=b.current)==null||_.classList.remove("error"),(C=b.current)==null||C.classList.add("success")):new Je(S)&&(j(!0),(F=b.current)==null||F.classList.remove("error"),(I=b.current)==null||I.classList.add("success"))}catch{j(!1),(H=b.current)==null||H.classList.remove("success"),(Te=b.current)==null||Te.classList.add("error")}},onKeyDown:N=>{if(N.key==="Enter"&&x){const S={[s.button]:{dice:N.currentTarget.value,theme:h?h.id:i?i.id:"dddice-bees"}};c(S),g(!1),j(!1)}else N.key==="Escape"&&g(!1)}}),e.jsx("button",{className:"save-custom-dice",disabled:!x,onClick:()=>{if(b.current){const N={[s.button]:{dice:b.current.value,theme:h?h.id:i?i.id:"dddice-bees"}};c(N),g(!1),j(!1)}},children:"√"}),e.jsx("button",{className:"abort-custom-dice",onClick:()=>{g(!1)},children:"X"})]})]}):null,s.customDice&&!s.customDice.removed?e.jsxs(e.Fragment,{children:[e.jsx("button",{className:`hidden-roll self ${f?"hover":""}`,onClick:N=>{N.currentTarget.parentElement&&m(N.currentTarget.parentElement,!w)},children:w?"SHOW":"HIDE"}),e.jsx("button",{className:`remove-dice ${f?"hover":""}`,onClick:()=>{if(s.customDice&&!s.customDice.removed&&l.hasOwnProperty(String(s.button))){const N={[s.button]:{...s.customDice,removed:!0}};c(N)}},children:"x"})]}):null]})},vi=({open:s})=>{const{theme:a,rollerApi:i}=xe(),t=he(O(u=>u.addRoll)),[n,p]=G(O(u=>[u.room,u.taSettings])),[l,c]=y.useState(!0),d=ae().role==="GM"&&!!p.gm_rolls_hidden,f=async(u,g,x=!1)=>{if(u.classList.add("rolling"),a&&g&&!(n!=null&&n.disableDiceRoller)){let j=He(g,a.id);i&&await Ve(i,j.dice,{operator:j.operator,label:"Roll: Custom",whisper:x?await Ke(n,i):void 0})}else await We(g,"Roll: Custom",t,x);u.classList.remove("rolling"),u.blur()},r=()=>{const u=({preview:g,name:x})=>e.jsx(q,{content:x,children:e.jsxs("li",{className:"quick-roll",onClick:async j=>{await f(j.currentTarget,x,d)},children:[e.jsx("div",{className:"quick-preview",children:g}),e.jsx("button",{className:"self",onClick:async j=>{j.stopPropagation(),j.currentTarget.parentElement&&await f(j.currentTarget.parentElement,x,!d)},children:d?"SHOW":"HIDE"})]})});return a&&!(n!=null&&n.disableDiceRoller)?a.available_dice.map((g,x)=>{let j="",h="";try{if(g.hasOwnProperty("type")){const v=g.notation,b=g.id;a.preview.hasOwnProperty(b)?j=a.preview[b]:v&&a.preview.hasOwnProperty(v)?j=a.preview[v]:j=a.preview[g.type],h=g.notation??g.id}else j=a.preview[g],h=String(g);if(h)return h=h==="d10x"?"d100":h,e.jsx(u,{preview:j?e.jsx("img",{src:j,alt:h}):ue(h),name:h},x)}catch{return null}}):["d4","d6","d8","d10","d10x","d12","d20"].map((x,j)=>{const h=x==="d10x"?"d100":x;return e.jsx(u,{preview:ue(x),name:h},j)})};return e.jsx(e.Fragment,{children:e.jsxs("ul",{className:`quick-button-list ${s?"open":""}`,children:[r(),e.jsxs("li",{className:"quick-custom-roll",children:[e.jsx(ne,{}),e.jsx("input",{className:`quick-custom-input ${l?"valid":"invalid"}`,type:"text",size:2,onChange:u=>{if(u.currentTarget.style.width=`${u.currentTarget.value.length}ch`,u.currentTarget.value===""){c(!0);return}try{if(a&&!(n!=null&&n.disableDiceRoller)){const g=ce.parseRollEquation(u.currentTarget.value,a.id);c(!!g)}else new Je(u.currentTarget.value)&&c(!0)}catch{c(!1)}},onKeyDown:async u=>{u.key==="Enter"&&l&&u.currentTarget.value&&await f(u.currentTarget,u.currentTarget.value)}})]})]})})},bi=s=>{const{buttons:a,setButtons:i}=Me(),[t,n]=y.useState(!1);return y.useEffect(()=>{a&&Object.entries(a).forEach(([p,l])=>{l&&T.isString(l)&&i({[p]:null})})},[a]),e.jsxs("div",{className:"dice-room-buttons",children:[Object.values(a).map((p,l)=>e.jsx(gi,{button:l+1,customDice:p},l)),e.jsx(q,{content:"Log & Settings",children:e.jsx("button",{className:`open-dice-tray button icon ${s.open?"open":"closed"}`,onClick:p=>{s.setOpen(!s.open),p.currentTarget.blur()},children:e.jsx(ji,{})})}),e.jsxs("div",{className:"quick-button-wrapper",children:[e.jsx(vi,{open:t}),e.jsx(q,{content:"Quick roll",children:e.jsx("button",{onClick:()=>n(!t),className:`quick-roll-button button icon ${t?"open":""}`,children:e.jsx(ne,{})})})]})]})},Ni=()=>e.jsx("svg",{className:"copy-icon",height:"18.499901",viewBox:"0 -960 619.99603 739.99603",width:"15.499901",version:"1.1",children:e.jsx("path",{d:"m 212.306,-360.002 q -30.308,0 -51.307,-21 -21,-21 -21,-51.308 v -455.382 q 0,-30.308 21,-51.308 20.999,-21 51.307,-21 h 335.383 q 30.307,0 51.307,21 21,21 21,51.308 v 455.382 q 0,30.308 -21,51.308 -21,21 -51.307,21 z m 0,-59.999 h 335.383 q 4.615,0 8.462,-3.846 3.846,-3.847 3.846,-8.463 v -455.382 q 0,-4.616 -3.846,-8.463 -3.847,-3.846 -8.462,-3.846 H 212.306 q -4.616,0 -8.462,3.846 -3.847,3.847 -3.847,8.463 v 455.382 q 0,4.616 3.847,8.463 3.846,3.846 8.462,3.846 z M 72.307001,-220.004 q -30.307,0 -51.307,-21 Q 1.0986328e-6,-262.004 1.0986328e-6,-292.311 V -807.692 H 59.999001 v 515.381 q 0,4.616 3.846,8.462 3.847,3.847 8.462,3.847 H 467.689 v 59.998 z M 199.997,-420.001 v -480 z"})}),yi=({className:s,user:a})=>{var d;const i=G(O(f=>f.room)),t=he(O(f=>f.clear)),[n,p]=y.useState(!1),[l,c]=y.useState(!1),o=ae();return y.useEffect(()=>{l||p(!1)},[l]),e.jsxs("div",{className:`dice-room ${s} ${l?"open":"closed"}`,children:[e.jsx(bi,{open:l,setOpen:c}),e.jsx("div",{className:"dice-tray-wrapper",children:e.jsx("div",{className:`dice-tray ${l?"open":"closed"}`,children:e.jsxs("div",{className:"dice-tray-content",children:[e.jsx("div",{className:"top",children:i!=null&&i.disableDiceRoller?e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"clear-log",onClick:()=>{t()},children:"Clear"}),o.role==="GM"?e.jsx("button",{onClick:async()=>{await ys(i,{disableDiceRoller:!1})},children:"Enabled dddice Integration"}):null]}):e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"dddice-login",onClick:async()=>{let f=500,r=600;try{f=await U.viewport.getWidth(),r=await U.viewport.getHeight()}catch{}await U.modal.open({..._s,width:Math.min(400,f*.9),height:Math.min(500,r*.9)})},children:a&&a.name!=="Guest User"?a.username:"Login"}),e.jsxs("div",{className:"room-link",children:[e.jsx("a",{href:`https://dddice.com/room/${(d=i==null?void 0:i.diceRoom)==null?void 0:d.slug}`,target:"_blank",children:"Room Link"}),e.jsx("button",{className:"copy-link",onClick:f=>{var r;navigator.clipboard.writeText(`https://dddice.com/room/${(r=i==null?void 0:i.diceRoom)==null?void 0:r.slug}`),f.currentTarget.blur()},children:e.jsx(Ni,{})})]}),e.jsxs("div",{className:"side-buttons",children:[e.jsx("button",{className:"clear-log",onClick:()=>{t()},children:"Clear"}),e.jsxs("div",{className:"dice-settings-wrapper",children:[e.jsx("button",{className:"dice-settings-button",onClick:()=>{p(!n)},children:"Settings"}),n?e.jsx(pi,{setSettings:p}):null]})]})]})}),e.jsx(Ds,{})]})})})]})},je="https://dddice.com/api/1.0",_i=async(s,a)=>Qe.request({url:a??`${je}/dice-box`,headers:{Authorization:`Bearer ${s}`,"Content-Type":"application/json",Accept:"application/json"}}).then(i=>i.status===200?i.data:null),Si=s=>Ye({queryKey:["themes"],queryFn:async({pageParam:a})=>await _i(s,a),initialPageParam:`${je}/dice-box`,getNextPageParam:a=>a.links.next,enabled:s!==""}),ki=async(s,a)=>Qe.request({url:a??`${je}/room`,headers:{Authorization:`Bearer ${s}`,"Content-Type":"application/json",Accept:"application/json"}}).then(i=>i.status===200?i.data:null),wi=s=>Ye({queryKey:["rooms"],queryFn:async({pageParam:a})=>await ki(s,a),initialPageParam:`${je}/room`,getNextPageParam:a=>a.links.next,enabled:s!==""}),Ri=s=>{var A;const[a,i,t,n,p,l,c,o,d]=xe(O(m=>[m.rollerApi,m.setRollerApi,m.setInitialized,m.theme,m.setTheme,m.themes,m.setThemes,m.rooms,m.setRooms])),f=ae(),r=G(O(m=>m.room)),[u,g]=y.useState(),[x,j]=y.useState(),[h,v]=y.useState(),[b,$]=y.useState(),w=Si((u==null?void 0:u.apiKey)||""),D=wi((u==null?void 0:u.apiKey)||"");return y.useEffect(()=>{if(f.role==="GM"&&o.length===0){if(D.hasNextPage&&!D.isFetchingNextPage)D.fetchNextPage();else if(!D.hasNextPage&&D.isSuccess){const m=D.isSuccess?D.data.pages.flatMap(k=>k.data):[];d(m)}}},[D.hasNextPage,D.isFetchingNextPage,D.isSuccess]),y.useEffect(()=>{if(T.isNull(l)){if(w.hasNextPage&&!w.isFetchingNextPage)w.fetchNextPage();else if(!w.hasNextPage&&w.isSuccess){const m=w.isSuccess?w.data.pages.flatMap(k=>k.data):[];c(m)}}},[w.hasNextPage,w.isFetchingNextPage,w.isSuccess]),y.useEffect(()=>{const m=_e(r,f.id);if(m){const k=m.apiKey,N=m.diceRendering;u?(k!==void 0&&k!==u.apiKey||N!==u.diceRendering)&&g({...m}):g({...m})}},[r]),y.useEffect(()=>{var k,N;const m=async()=>{var _;let S;t(!1),(u==null?void 0:u.apiKey)!==x&&(u==null?void 0:u.apiKey)!==void 0&&(j(u==null?void 0:u.apiKey),v((_=r==null?void 0:r.diceRoom)==null?void 0:_.slug),S=await ks(r,b),S&&(i(S),$(await ws(S)))),t(!0)};(u&&u.apiKey!==void 0||!u)&&!(r!=null&&r.disableDiceRoller)&&u!=null&&u.apiKey&&m(),a&&((k=r==null?void 0:r.diceRoom)!=null&&k.slug)&&((N=r==null?void 0:r.diceRoom)==null?void 0:N.slug)!==h&&(v(r.diceRoom.slug),Ss(a,r,b))},[u,r==null?void 0:r.disableDiceRoller,(A=r==null?void 0:r.diceRoom)==null?void 0:A.slug]),y.useEffect(()=>{const m=async()=>{var N;if(!T.isNull(l)&&l.length>0)p(l[0]),r&&await de(r,U.player.id,{diceTheme:l[0].id});else{const S=(N=await(a==null?void 0:a.theme.get("dddice-bees")))==null?void 0:N.data;S&&(p(S),r&&await de(r,U.player.id,{diceTheme:S.id}))}},k=async()=>{var N,S,_;if(n)!T.isNull(l)&&!l.includes(n)&&await m();else{const C=(S=(N=r==null?void 0:r.diceUser)==null?void 0:N.find(F=>F.playerId===f.id))==null?void 0:S.diceTheme;if(C&&!T.isNull(l)&&l.map(F=>F.id).includes(C)){const F=(_=await(a==null?void 0:a.theme.get(C)))==null?void 0:_.data;F&&p(F)}else await m()}};a&&!T.isNull(l)&&k()},[a,w.isSuccess,u==null?void 0:u.diceTheme,l]),e.jsx(yi,{className:s.classes,user:b})};export{Ri as D,Fi as S};
